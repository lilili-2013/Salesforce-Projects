<apex:page controller="WP_DealQuickCreateController" standardStylesheets="false">

<apex:stylesheet value="{!URLFOR($Resource.kjo_js_libs, 'libs/jquery-ui-1.10.0.custom/css/warburg-pincus/jquery-ui-1.10.0.custom.min.css')}" />
<apex:stylesheet value="{!URLFOR($Resource.BootstrapSF, 'dist/css/bootstrap.min.css')}"/>

<apex:includeScript value="{!URLFOR($Resource.kjo_js_libs, 'libs/jquery-ui-1.10.0.custom/js/jquery-1.9.0.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.BootstrapSF, 'dist/js/bootstrap.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kjo_js_libs, 'libs/jquery-ui-1.10.0.custom/js/jquery-ui-1.10.0.custom.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kjo_js_libs, 'libs/jquery.formatcurrency/jquery.formatCurrency-1.4.0.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kjo_js_libs, 'libs/jquery.autonumeric/autoNumeric.js')}"/>

<apex:includeScript value="{!URLFOR($Resource.kjo_js_libs, 'libs/backbone/underscore-min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kjo_js_libs, 'libs/backbone/backbone.js')}"/> 
<apex:includeScript value="{!URLFOR($Resource.kjo_js_libs, 'libs/handlebars/handlebars-1.0.rc.1.js')}"/>

<apex:includeScript value="{!URLFOR($Resource.kjo_js_libs, 'libs/tinymce/jscripts/tiny_mce/tiny_mce.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.kjo_js_libs, 'libs/tinymce/jscripts/tiny_mce/jquery.tinymce.js')}"/>

<apex:includeScript value="{!URLFOR($Resource.jquery_drop_libs, 'dropdown_libs/jquery.multiselect.js')}"/>
<apex:stylesheet value="{!URLFOR($Resource.jquery_drop_libs, 'dropdown_libs/jquery.multiselect.css')}"/>

<apex:includeScript value="{!URLFOR($Resource.jquery_smart_wizard, 'js/jquery.smartWizard-2.0.js')}"/>
<apex:stylesheet value="{!URLFOR($Resource.jquery_smart_wizard, 'styles/smart_wizard.css')}"/>
 
<apex:includeScript value="{!URLFOR($Resource.autoNumeric, 'autoNumeric-master/autoNumeric.js')}"/>

<style type="text/css">

.custom-tooltip {
  background: #FEFDBA;
  font-size:12px !important;
  border: solid #FFA603;
  text-align: left;
  max-width:600px;
  white-space: normal;
  font-weight: normal;
}

.custom-mouse-info {
  cursor:pointer !important;
}

.icon-orng-bulb {
    background-image:url("{!URLFOR($Resource.custom_images, 'CustomImages/orng_qm.png')}");
    background-position: -1px -1px;
}
.custom-bulb-icon-info {
    display:inline-block;
    position:relative;
    left:0px;
    bottom:1px;
}


.smart-wizard-button-selected
{
  border: 3px solid #ADEAEA !important;
}

.swMain .stepContainer div.content {
   
  height:525px;
 }

.mark-multiselect-white
{
  background: #FFFFFF !important;
}

.ui-multiselect {
  cursor:default;
  color:black !important;
  border:1px solid #B8B8B8;
  height:30px; 
  width:254px !important;
  font-size:12px;
  overflow: hidden !important;
    overflow-y:auto; 
   overflow-x:auto;
   border-radius: 5px; 
   -moz-border-radius:5px; /* Firefox */
   -webkit-border-radius: 5px; /* Safari, Chrome */
   -webkit-appearance:textfield;-webkit-box-sizing:content-box;
 }

/*This class is is needed for making font bigger of Single Multiselect List Header*/
.ui-multiselect-header.classForCompType  ul { font-size:11px }

/*This class is needed to remove the padding of Single Multiselect List using font-size*/
.ui-multiselect-checkboxes.classForCompType  li  { clear:both; font-size:1px; padding-right:3px }

#dealteam { list-style-type: none; margin: 2px; padding: 4px; width: 90%; }
#dealteam li div { background-color: #eeeeee; position: relative; padding: 4px; margin:2px; border:0px black solid;}
#dealteam li div span { position: absolute; top:5px; right: 10px; display:inline-block;}
#dealteam li div.hilite { border:1px red solid;}

#fundlist { list-style-type: none; margin: 2px; padding: 4px; width: 90%; }
#fundlist li div { background-color: #eeeeee; position: relative; padding: 4px; margin:2px; border:0px black solid;}
#fundlist li div span { position: absolute; top:5px; right: 10px; display:inline-block;}
#fundlist li div.hilite { border:1px red solid;}

.ui-autocomplete {
    max-height: 200px;
    overflow-y: auto;
    overflow-x: auto; 
    white-space:nowrap;
   }

.textBoxAlign {
    border: 1px solid #d3d3d3 ;
    width: 255px; 
    height: 25px; 
    position:relative;
    float:left;  
    }
              
input[type=checkbox] {width:16px; height:16px;}

input[readonly],select[readonly],textarea[readonly] {
  cursor:default;
  color:black !important;
  }

select{
 cursor:default;
  }

textarea, input[type="text"], input[type="password"], input[type="datetime"], input[type="datetime-local"], input[type="date"], input[type="month"], input[type="time"], input[type="week"], input[type="number"], input[type="email"], input[type="url"], input[type="search"], input[type="tel"], input[type="color"], .uneditable-input {
background-color: #fff;
border: 1px solid #ccc;
-webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);
-moz-box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);
box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);
-webkit-transition: border linear .2s,box-shadow linear .2s;
-moz-transition: border linear .2s,box-shadow linear .2s;
-o-transition: border linear .2s,box-shadow linear .2s;
transition: border linear .2s,box-shadow linear .2s;
}
select, textarea, input[type="text"], input[type="password"], input[type="datetime"], input[type="datetime-local"], input[type="date"], input[type="month"], input[type="time"], input[type="week"], input[type="number"], input[type="email"], input[type="url"], input[type="search"], input[type="tel"], input[type="color"], .uneditable-input {
display: inline-block;
height: 30px;
/*padding: 4px 6px;*/
padding-left: 4px;
margin-bottom: 10px;
font-size: 14px;
/* line-height: 30px; */
color: #555;
vertical-align: middle;
-webkit-border-radius: 4px;
-moz-border-radius: 4px;
border-radius: 4px;
}

label, input, button, select, textarea {
font-size: 14px !important;
font-weight: normal;
/* line-height: 20px !important; */
overflow: hidden !important;
}

input[disabled], select[disabled], textarea[disabled], input[readonly], select[readonly], textarea[readonly] {
cursor: not-allowed;
background-color: #eee;
}
.bs button, .bs input {
    overflow: hidden !important;
}

.actionBar {
width: 875px; }
</style>
<div class="bs">
    <div id="staffingdialog" >
    <div style="display:none" id="dealid"></div>
    <div class='content-panel'>
    <div id="staffing-dialog-content"></div>
    </div> </div>

    <div id="funddialog" >
    <div style="display:none" id="fundid"></div>
    <div class='content-panel'>
    <div id="fund-dialog-content"></div>
    </div> </div>
   
    <div id="existing_deal_dialog" title="Checking Existing Deals" style="display:none">
        <table>
            <tr><td>Deals with similar names already exist in the system. Please double-click an item in the list to leave this page and go to an existing deal, or click ‘Create New Deal'.</td></tr>
            <tr><td>
            <div id="deal_dialog">
            <select id="deal_dialog_sel" multiple="multiple" style="height:110px; width:575px;">
            </select>
            </div>
            </td></tr>
        </table>
    </div>

    <div id="existing_company_dialog" title="Checking Existing Companies" style="display:none">
        <table>
            <tr><td>Companies with similar names already exist in the system. Please double-click an item in the list to choose an existing company or, click ‘Create New Company'.</td></tr>
            <tr><td>
            <div id="company_dialog">
            <select id="company_dialog_sel" multiple="multiple" style="height:110px; width:575px;">
            </select>
            </div>
            </td></tr>
        </table>
    </div>    
</div>   
<script id="staffing-dialog-template" type="text/x-handlebars-template">
  <div>
    {{#if dealname}}
  <div style="display:none">{{dealname}}</div>
    {{/if}}
    <input type='text' id='staff-searcher'></input>
    <ul id='dealteam'>
    {{#each staff}}
        <li data-contact-id='{{this.contact_id}}' data-user-id='{{this.user_id}} data-user-initial='{{this.user_initial}}'>
   <div>
     {{this.label}}
        <a href='#' class='delete-user'><span class='ui-icon ui-icon-circle-close'></span></a>
   </div>
    </li>
    {{/each}}
    </ul>
   </div>
  </script>
  <script id="fund-dialog-template" type="text/x-handlebars-template">
   <div>
    {{#if fundname}}
   <div style="display:none">{{fundname}}</div>
    {{/if}}
    <input type='text' id='fund-searcher' ></input>
      <ul id='fundlist'>
    {{#each fund}}
      <li data-fund-id='{{this.fund_id}}' data-fund-name='{{this.fund_name}}'>
   <div>
    {{this.label}}
      <a href='#' class='delete-user'>
        <span class='ui-icon ui-icon-circle-close'></span>
      </a>
   </div></li>
    {{/each}}
    </ul></div>
</script>
<div class="bs">
<div id="dialog-confirm" title="Create New Company" style="display:none">
<span class="ui-icon ui-icon-alert" style="float: left; margin: 0 7px 20px 0;"></span>Do you want to create new company?
</div>
 <form id="step" class="swMain">
  <fieldset>
   <div id="wizard" class="swMain">
    <ul>
     <li><a href="#step-1">
      <label class="stepNumber">1</label>
       <span class="stepDesc">Create/Specify Company>> <br />
        <small>Enter company details</small>
       </span></a></li>
       <li><a href="#step-2">
       <label class="stepNumber">2</label>
        <span class="stepDesc"> Deal Quick Create <br />
         <small>Enter deal details</small></span>
       </a></li></ul>
   <div id="step-1" style="width:875px;">   
    <h2 class="StepTitle">Enter company information</h2>
   <p></p> <p align="right" >
      <img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; !important LEFT:8px; WIDTH:4px; HEIGHT:18px"/>
       <strong> = Required Information</strong></p>
            
  <table width="700" cellspacing="4" cellpadding="2" align="left" >
   <tr>
    <td  align="right" style="vertical-align:middle; padding-bottom:10px; width:90px;" >Company
       <img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; Bottom:2px; LEFT:4px; WIDTH:4px; HEIGHT:25px"/>
    </td>
    <td align="left">
        <input type="text" id="acountName" name="acountName" value="" style="width: 602px; float:left;" />
    </td></tr> 
   <tr><td  align="middle" style="vertical-align:middle;  width:90px;" >Public/Private Company 
         <img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; Bottom:11px; Left:20px; WIDTH:4px; HEIGHT:26px;" />   
        </td>
       <td align="left" >
        <div id="comp_type" >
        <select id="comp_type_sel" readonly="true" style="width:255px; height: 200px;" >
        </select></div>
    </td> 
   </tr></table> 
   
  <table width="700" cellspacing="4" cellpadding="2" align="left"  >
   <tr>
    <td  align="right" style="vertical-align:middle; padding-bottom:8px; width:90px;padding-right:6px;"  >Sector(s)</td>
    <td align="left" style="padding-bottom:12px;">  
      <div id="wpgroup" class="textBoxAlign" ><select id="wpgroup"  multiple="multiple" style="width: 255px;" ></select></div></td>
    <td  align="right" style="vertical-align:middle; padding-bottom:8px; padding-right:6px;">Sub-Sector(s)</td>
    <td align="left" ><div id="sectorname" name="sectorname" class="textBoxAlign" >
      <select name="optionsector" id="optionsector" multiple="multiple" style="width: 255px;" ></select></div></td></tr>
  <tr>
    <td  align="right" style="vertical-align:middle; padding-bottom:10px; padding-right:6px;">City</td> 
    <td align="left" ><input type="text" id="cityname" name="cityname" readonly="true" class="textBoxAlign" style="width: 254px;"/></td>
    <td  align="right" style="vertical-align:middle; padding-bottom:10px; padding-right:6px;" >State/Province</td>
    <td align="left" > <input type="text" id="statename" name="statename" readonly="true" class="textBoxAlign" style="width: 254px;"/></td></tr>
  <tr>  
    <td  align="right" style="vertical-align:middle; padding-bottom:10px;padding-right:6px;" >Country</td>
    <td align="left" ><div><input type="text" id="countryname" name="countryname" readonly="true" class="textBoxAlign" style="width: 254px;"/></div></td>                     
    <td  align="right" style="vertical-align:middle; padding-bottom:10px;padding-right:6px;" >Geographies</td> 
    <td align="left" ><div id="geographyname" name="geographyname" class="textBoxAlign" style="width: 255px;"> 
       <select name="optionsgeography" id="optionsgeography" multiple="multiple" style="width: 255px;"></select> </div> </td>
  </tr> </table>                  
 <table width="700" cellspacing="4" cellpadding="2" align="left" >
  <tr><td  align="right" style="vertical-align:top; width:90px;padding-right:6px;" >Description</td>
      <td align="left"  ><textarea id="comp_desc" name="comp_desc" style="width: 602px; height: 120px;" readonly="true" /></td></tr>  
 </table>   </div> 
                          
     <div id="step-2" style="width:875px;">
       <h2 class="StepTitle">Enter deal information</h2> 
       <p></p>  <p align="right" >
           <img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; !important LEFT:8px; WIDTH:4px; HEIGHT:18px"/>
           <strong> = Required Information</strong></p>             
             
 <table width="810" cellspacing="2" cellpadding="2" align="left" >
   <tr><td  align="right" style="vertical-align:middle;padding-bottom:10px; width:150px;" >Deal Name
         <img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; Bottom:2px; LEFT:4px; WIDTH:4px; HEIGHT:25px"/></td>
     <td align="left"> <input type="text" id="dealname" name="dealname" class="textBoxAlign" style="width: 255px;"/></td>
     <td  align="right" style="vertical-align:middle;padding-bottom:10px; width:150px;padding-right:6px;" >Company</td>
     <td align="left"> <input type="text" id="compname" name="compname" readonly="true" class="textBoxAlign" style="width: 255px;"/></td>
   </tr>
   <tr>
     <td align="right" style="vertical-align:middle; padding-bottom:10px; padding-right:6px;">Project Name 
     <span  id="projnameRedLine" name="projnameRedLine"><img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; top:-4px; LEFT:6px; WIDTH:4px; HEIGHT:25px"/></span>
     </td>
     <td align="left">  <input type="text" id="projname" name="projname"  class="textBoxAlign" style="width: 255px;"/></td>
     <td align="right" style="vertical-align:middle; padding-bottom:10px; width:150px; padding-right:6px;" >Potential Energy Opportunity<img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; top:-10px; LEFT:6px; WIDTH:4px; HEIGHT:25px"/></td>
     <td align="left" style="padding-bottom:12px; width: 218px;" >
         <div id="EnergyFundname" name="EnergyFundname" class="textBoxAlign"> 
            <select name="optionEnergy" id="optionEnergy" style="width:200px;">     
            </select> 
         </div>
     </td>
     <td>
         <a href="#" id="energy_bulb" title="Please specify if this is a potential Energy opportunity."><span class="custom-bulb-icon-info custom-mouse-info icon-orng-bulb" id="richText-fields-Dialog-tabs-Img"></span></a>
     </td>
   </tr>
   <tr>                                     
     <td  align="right" style="vertical-align:middle;padding-bottom:10px; padding-right:6px;" >WP Group(s)
     <img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; top:-1px; LEFT:6px; WIDTH:4px; HEIGHT:25px"/>
      </td>
     <td align="left" style="padding-bottom:12px;"> <div id="wpgroup2" class="textBoxAlign" ><select id="wpgroup2"  multiple="multiple" style="width: 255px;"> 
        </select></div></td>    
     <td  align="right" style="vertical-align:middle; padding-bottom:10px; padding-right:6px;" > Sub-Sector(s) </td>
     <td align="left" style="padding-bottom:12px; width: 218px;">
         <div id="sectorname2" name="sectorname2" class="textBoxAlign" style="width: 255px;">
     <select name="optionsector2" id="optionsector2" multiple="multiple">
         </select></div></td></tr>
<tr> 
     <td  align="right" style="vertical-align:middle; padding-bottom:10px; width:120px; "> Date Received 
     <img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; top:0px; LEFT:5px; WIDTH:4px; HEIGHT:25px"/></td>        
     <td align="left"> <input type="text" id="Date_rcvd" name="Date_rcvd" class="textBoxAlign" style="width: 255px;"/>
     
     </td>
     <td  align="right" style="vertical-align:middle; padding-bottom:1px; padding-right:6px;" > Stage of Life Cycle</td>
      <td align="left" ><div id="StageLifename" name="StageLifename" class="textBoxAlign">
          <select name="optionstage2" id="optionstage2"  style="width: 255px;" >
         </select> </div> </td>  
   </tr> 
         
   <tr><td  align="right" style="vertical-align:middle; padding-bottom:1px; padding-right:6px;"  > Geographies  </td> 
      <td align="left"> <div id="geographyname2" name="geographyname2" class="textBoxAlign" >
        <select name="optionsgeography2" id="optionsgeography2" multiple="multiple" style="width: 255px;" ></select> </div></td>
      <td  align="right" style="vertical-align:middle; padding-bottom:1px; padding-right:6px;" >Deal Stage</td>
      <td align="left" >
          <div id="stagename" name="stagename" class="textBoxAlign">
            <select name="optionstage" id="optionstage"  style="width: 255px;" >
            </select> 
         </div> 
      </td>
   </tr>
   <tr><td  align="right" style="vertical-align:middle;padding-bottom:10px; padding-right:6px;" > WP Investment Amount </td>
       <td align="left" style="padding-top:10px;"> <input type="text" id="WP_Inv_Amt" name="WP_Inv_Amt" class="textBoxAlign" style="width: 255px;"/>
       <!-- <select id="WP_Inv_Amt_Mul" style="width: 64px;">
          <option id="NO Multiply" value ="Unit">Unit</option>
          <option id="Thousand" value ="k">k</option>
          <option id="Million" value ="m">m</option>
          <option id="Billion" value ="b">b</option></select> --> 
       </td>
       <td  align="right" style="vertical-align:middle;padding-bottom:2px; padding-right:6px;" > Fund(s) </td>
       <td align="left" style="padding-top:10px;" > <input type="text" id="fund" name="fund" class="textBoxAlign" style="width: 255px;"/></td></tr> 
    <tr><td  align="right" style="vertical-align:middle; padding-bottom:10px; padding-right:6px;"> Deal Team </td>
        <td align="left" > <input type="text" id="deal_team"  name="deal_team" class="textBoxAlign" style="width: 255px;"/></td>
        <td  align="right" style="vertical-align:middle; padding-bottom:10px; padding-right:6px;">Categories </td>
        <td align="left" > <input type="text" id="categories" name="categories " class="textBoxAlign" style="width: 255px;"/></td></tr>
         
    <tr><td align="right" style="vertical-align:top;">Description
    <img src= "{!URLFOR($Resource.jquery_smart_wizard, 'line.jpg')}" STYLE="position:relative; top:3px; LEFT:0px; WIDTH:4px; HEIGHT:114px"/></td>
        <td align="left" ><textarea id="deal_desc" name="deal_desc" style="width: 255px; height: 120px;" /></td>        
        <td align="right" style="vertical-align:top;padding-right:6px;">Key Dates/ Next Step(s)</td>
        <td align="left" ><textarea id="Key_date_Nxt" name="Key_date_Nxt" style="width: 255px; height: 120px;"  /></td>
    </tr>             
   </table>   
    </div> 
    </div></fieldset>
   </form>

<div id='progressbar'></div>
<div class='wait-panel'>
<div class='wait-panel-progress'></div>
</div>

<div id="dialog-general-info" style="display:none">
</div>
</div>
<script>

var $jq = jQuery.noConflict();     
var main_page;
var sector_group_name_list = new Array();
var creating_new_company = false;
var company_selected = false;

var sector_group_len_list = new Array();


var sector_elem_in_group_name_list=new Array();

var geo_name_list=new Array();

var deal_id;
var acc_info;
var deal_team_initials_string = new String();
var deal_team_contact_id_list = new Array();
var deal_team_info_list= new Array();
var account_created_id='';
var deal_stage_list=new Array();
var life_cycle_deal_stage_list=new Array();
var comp_type_list=new Array();


var sector_info='';  
var geo_info=''; 
var wp_group_info='';
var prev_wp_group_info='';
var prev_sector_info='';
var prev_geo_info=''; 

var wp_group_info2='';
var sector_info2='';  
var geo_info2=''; 
var prev_wp_group_info2='';
var prev_sector_info2=''; 
var prev_geo_info2=''; 

var fund_names_string = new String();
var fund_names_id_list = new Array();
var fund_info_list= new Array();
var entering_deal_page_first_time=true;
var user_default_wp_group;
var ignorewords;

var is_deal_and_proj_name_populated=false;
var comp_type_needed_for_company_selected=false;

$jq(document).ready(function() {
  main_page = $jq(this);
  
  //get the list words to ignore first
  Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.WP_DealQuickCreateController.getWordsToIgnore}',
        function(result, event) {
            if ( (event.status) && (result) ) {
                 if (result.length > 0)   
                    ignorewords = result[0].split('|');                  
            }
  });

 $jq(document).click(function() {
    $jq("#wizard").smartWizard("getNextButton").removeClass("smart-wizard-button-selected");
    $jq("#wizard").smartWizard("getPreviousButton").removeClass("smart-wizard-button-selected");
    $jq("#wizard").smartWizard("getFinishButton").removeClass("smart-wizard-button-selected");
 });
  
  $jq("#progressbar").progressbar( {value : false} );    

  $jq("#wizard").hide();
  $jq("#progressbar").show(); 

                                     
  preventRemovingText();

  $jq("#WP_Inv_Amt").autoNumeric('init');
   
  $jq("#deal_team").bind('click keyup', function(e){
   $jq("#deal_team").val(deal_team_initials_string);
     if( (e.type === 'click' || e.type === 'keyup') && (e.keyCode != 27) ){              
         showStaffingDialog(e);     
     }
  });


  $jq("#fund").bind('click keyup', function(e){
    $jq("#fund").val(fund_names_string);
      if( (e.type === 'click' || e.type === 'keyup') && (e.keyCode != 27) ){       
             showFundDialog(e);     
      }
  });
               
        
  $jq("#Date_rcvd").datepicker();
        
  $jq("#staffingdialog").dialog({
      autoOpen: false, 
      modal: true, 
      position: 'center',
      width: 280,
      height: 350,
      closeOnEscape: true,
      buttons: {
         "OK": function() {
               updateDealStaffing($jq(this));
               $jq(this).dialog("close");
               $jq("#categories").focus(); 
         },
         "Cancel": function() {
                    $jq(this).dialog("close");
                    $jq("#categories").focus(); 
         }
      }              
  });  
   
  $jq("#funddialog").dialog({
      autoOpen: false, 
      modal: true, 
      position: 'center',
      width: 280,
      height: 350,
      closeOnEscape: true,        
      buttons: {
        "OK": function() {
              updateFunds($jq(this));
             $jq(this).dialog("close");
             $jq("#deal_team").focus(); 
        },
        "Cancel": function() {
             $jq(this).dialog("close");
             $jq("#deal_team").focus(); 
        }
      }              
  });        
    
  $jq('#wizard').smartWizard({
    labelPrevious:'<< Previous', // label for Previous button
    transitionEffect: 'fade', // Effect on navigation, none/fade/slide/slideleft
    labelNext:'Next>>', // label for Next button
    labelFinish:'Create Deal',  // label for Finish button  
    onLeaveStep: leaveAStepCallback, //Triggers when "SaveComp" button is called
    noForwardJumping: true,
    noBackwardJumping: true,
    hideButtonsOnDisabled: true, 
    keyNavigation: false, 
    onShowStep: showAStepCallback,  // triggers when showing a step
    onFinish: onFinishCallback//Triggers when "SaveDeal" button is called
  });

  $jq("#comp_type").multiselect({
    selectedList: 1,
    beforeopen: function(event,ui){ return false;},   
    height:100,
    minWidth: 218,
    multiple:false,
    header: "Select ...",
    noneSelectedText:'',
    classes:'classForCompType',
    close:function(event,ui){ $jq("#comp_type").multiselect("getButton").focus();}
  });                

  $jq("#wpgroup").multiselect({
    selectedList: 2,
    minWidth: 230, 
    beforeopen: function(event,ui){ return false;},                     
    open: function(event,ui){
           prev_wp_group_info = $jq("#wpgroup").multiselect("getChecked").map(function(){return this.value;}).get();
           return false;
    },                
    close: function(event, ui){
           // event handler here
       wp_group_info = $jq("#wpgroup").multiselect("getChecked").map(function(){return this.value;}).get();
       //alert(prev_wp_group_info+':'+prev_wp_group_info.length+':'+wp_group_info+':'+wp_group_info.length);
       if(prev_wp_group_info.toString() != wp_group_info.toString() )
       {                          
          populateFilteredSectorList('sectorname');
          populateWpGroupListOnDealPage();
          
          $jq("#sectorname2").multiselect("uncheckAll");

            sector_info= $jq("#sectorname").multiselect("getChecked").map(function(){return this.value;}).get();
            //alert(sector_info);

       var sector_temp=sector_info;

       //alert(sector_temp);       
       if((sector_temp != null) )
       {
        $jq("#sectorname2").multiselect("uncheckAll");
       sector_temp =sector_info.toString().replace( /\&amp\;/g,"\&");
       var sector_list_values = sector_temp.toString().split(',');
       for(var elem_index=0;elem_index < sector_list_values.length;++elem_index)
       {  
          $jq("#sectorname2").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert(ui.value+':'+sector_list_values[elem_index]);
             if((ui.value == sector_list_values[elem_index]) && (ui.checked == false))
             { //alert('clicked'+ui.value);
              this.click();
             }
           });       
       }
       }  
                 
          setWPGroupOfCurrentUser();
          populateFilteredSectorList('sectorname2'); 
          entering_deal_page_first_time=false;
       }  
       $jq("#wpgroup").multiselect("getButton").focus();
    }
  });
    
  $jq("#wpgroup2").multiselect({
    selectedList: 4,
     minWidth: 269,
    open: function(event,ui){
          //alert('wpgroup2:open');
          prev_wp_group_info2 = $jq("#wpgroup2").multiselect("getChecked").map(function(){return this.value;}).get();
          return false;
    },
    close: function(event, ui){
        // event handler here
        wp_group_info2 = $jq("#wpgroup2").multiselect("getChecked").map(function(){return this.value;}).get();
        //alert(prev_wp_group_info2+':'+prev_wp_group_info2.length+':'+wp_group_info2+':'+wp_group_info2.length);
       setWPGroupOfCurrentUser();
        if(prev_wp_group_info2.toString()!=wp_group_info2.toString())
           {
              populateFilteredSectorList('sectorname2');           
           }
        $jq("#wpgroup2").multiselect("getButton").focus();   
        $jq("#wpgroup2").keydown(function (e) {
          var keyCode = e.keyCode || e.which; 
        
          if (keyCode == 9) {            
              e.preventDefault(); 
              $jq("#sectorname2").multiselect("getButton").focus();
          } 
        });           
    }
  });                           

  $jq("#sectorname").multiselect({
      selectedList: 4,
      minWidth: 230,
      menuWidth: 400,
      open: function(event,ui){
           prev_sector_info = $jq("#sectorname").multiselect("getChecked").map(function(){return this.value;}).get();
           return false;
      },
      beforeopen: function(event,ui){ return false;},                      
      close: function(event, ui){                       
            sector_info= $jq("#sectorname").multiselect("getChecked").map(function(){return this.value;}).get();
            //alert(sector_info);

       var sector_temp=sector_info;

       //alert(sector_temp);       
       if((sector_temp != null) && (sector_info.toString()!=prev_sector_info.toString()))
       {
        $jq("#sectorname2").multiselect("uncheckAll");
       sector_temp =sector_info.toString().replace( /\&amp\;/g,"\&");
       var sector_list_values = sector_temp.toString().split(',');
       for(var elem_index=0;elem_index < sector_list_values.length;++elem_index)
       {  
          $jq("#sectorname2").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert(ui.value+':'+sector_list_values[elem_index]);
             if((ui.value == sector_list_values[elem_index]) && (ui.checked == false))
             { //alert('clicked'+ui.value);
              this.click();
             }
           });       
       }
       }  
       $jq("#sectorname").multiselect("getButton").focus();  
     }
  });      
       
        
              $jq("#sectorname2").multiselect({
             selectedList: 4,
             minWidth: 269,
             menuWidth: 400,
             beforeopen: function(event,ui){return false;},
             close: function(event, ui){
                        
            sector_info2= $jq("#sectorname2").multiselect("getChecked").map(function(){return this.value;}).get();
            //alert(sector_info2);
            $jq("#sectorname2").multiselect("getButton").focus();  

        }});                

                 $jq("#geographyname").multiselect({
                  selectedList: 4,
                  minWidth: 230,
                  open: function(event,ui){
                    prev_geo_info = $jq("#geographyname").multiselect("getChecked").map(function(){return this.value;}).get();
                    return false;
                  },
                  beforeopen: function(event,ui){return false;},                
                  close: function(event, ui){
                  // event handler here
                  geo_info = $jq("#geographyname").multiselect("getChecked").map(function(){return this.value;}).get();
                  
   
       var geo_temp=geo_info;
       //alert(geo_temp);
       if((geo_temp != null) &&  (geo_info.toString()!=prev_geo_info.toString()))
       {
        $jq("#geographyname2").multiselect("uncheckAll");
       var geo_list_values=geo_temp.toString().split(',');
       for(var elem_index=0;elem_index < geo_list_values.length;++elem_index)
       {  
          $jq("#geographyname2").multiselect("widget").find(":checkbox").each(function(event,ui) {
             if((ui.value == geo_list_values[elem_index]) && (ui.checked == false))
             this.click();
          }); 
       
       }
       }         
       $jq("#geographyname").multiselect("getButton").focus();             
                  
           
                 }
        });
        
                 $jq("#geographyname2").multiselect({
                  selectedList: 4,
                  minWidth: 269,
                  beforeopen: function(event,ui){return false;},
                  close: function(event, ui){
                  // event handler here
                  geo_info2 = $jq("#geographyname2").multiselect("getChecked").map(function(){return this.value;}).get();
                  $jq("#geographyname2").multiselect("getButton").focus();       
                 }
        });  


               
        $jq("#acountName").autocomplete({
            minLength : 3,
            autoFocus: true,
            source: function(request, response) {
                acc_info= request.term;

                WP_DealQuickCreateController.getCompanyList(
                    request.term,
                    function(data, event) {
                    if ( true){ 
              
                    comp_list = $jq.map(data, function(item) {                                        
                    
                      if(item.label == 'Create New Company')
                      {
                        return {label : item.label, value : item.label , id : item.comp_id, sub_sector:item.sub_sector,geo:item.geo}
                      }
                      else
                      { 
                                           
                        var is_sub_sector_present= (item.sub_sector!=null) && (item.sub_sector!='') && (item.sub_sector!="")
                        var is_geo_present= (item.geo!=null) && (item.geo!='') && (item.geo!="")
                        
                        if(is_sub_sector_present)
                        {
                          item.sub_sector=item.sub_sector.toString().replace( /\&amp\;/g,"\&");   
                        }
                        
                        if((is_sub_sector_present == true) && (is_geo_present == true))
                        {                                                                   
                          return {label : item.label+', ['+item.sub_sector+'], ['+item.geo+']', value : item.label , id : item.comp_id, sub_sector:item.sub_sector,geo:item.geo}
                        }
                        else if((is_sub_sector_present == false) && (is_geo_present == false))
                        {
                          return {label : item.label, value : item.label , id : item.comp_id, sub_sector:item.sub_sector,geo:item.geo}
                        }
                        else if(is_sub_sector_present == true)
                        {
                          return {label : item.label+', ['+item.sub_sector+']', value : item.label , id : item.comp_id, sub_sector:item.sub_sector,geo:item.geo}
                        }
                        else if(is_geo_present == true)
                        {
                          return {label : item.label+', ['+item.geo+']', value : item.label , id : item.comp_id, sub_sector:item.sub_sector,geo:item.geo}
                        }
                      }                                       
                    });
                    
                    }        
                    response(comp_list);
                    }
                );                   
            },
        
            open:function(event, ui){
                      /*
                      for(var i=0; i <sector_group_name_list.length;++i )
                      {alert('sector_group_name_list'+sector_group_name_list[i]+':'+sector_group_name_list.length);}
                      for(var i=0; i <sector_group_len_list.length;++i )
                      {alert('sector_group_len_list'+sector_group_len_list[i]+':'+sector_group_len_list.length);}
                      for(var i=0; i <sector_elem_in_group_name_list.length;++i )
                      {alert('sector_elem_in_group_name_list'+sector_elem_in_group_name_list[i]+':'+sector_elem_in_group_name_list.length);}
                      for(var i=0; i <geo_name_list.length;++i )
                      {alert('geo_name_list'+geo_name_list[i]+':'+geo_name_list.length);}*/                           
                    //$jq('.ui-autocomplete').prepend('<li><a href="#" onclick="openDialog();">Create New Company...</a></li>');
                      reset_comp_selections();                     
                     
                     
            } ,                 
                    
            close: function( event, ui ) {      

            },
            select: function( event, ui ) {

                          
                          
                          //alert(ui+':'+ui.item+':'+ui.item.label+':'+ui.item.value+':'+ui.item.id+':'+ui.item.city+':'+ui.item.state);
 
                          clearValuesFromDealPage();
                          clearValuesFromCompPage(); 
                          if(ui.item.value == 'Create New Company')
                          {
                            event.preventDefault();
                            creating_new_company=true;
                            setCompPageEdiTable();
                            
                            $jq("#acountName").val(acc_info);
                            var dlg = $jq("#dialog-confirm");
                            dlg.html('Would you like to create new company \"'+$jq("#acountName").val()+'\" ?'); 
                            openDialog();                                                      
                          
                        }
                        else { 
                           company_selected=true;
                           account_created_id= ui.item.id;                           
                           //alert("Populating fields for selected company is under construction: " + ui.item.value + ", id: "+ ui.item.id);
                           getExistingAccountInfo(ui.item.id, false);                            
                        } 
            }, 
            create: function(event, ui) { 
           
            }                
        });

        
        $jq("#acountName").keydown(function (e) {
          var keyCode = e.keyCode || e.which; 
         //alert(keyCode+company_selected+comp_type_needed_for_company_selected);
          //SHIFT TAB key from Company Name takes to Next Button, irrespective of new company or existing company
          if((e.shiftKey) && (keyCode == 9)) {
              e.preventDefault(); 
              $jq("#wizard").smartWizard("getNextButton").addClass("smart-wizard-button-selected");
              $jq("#wizard").smartWizard("getNextButton").focus();          
          }           
          else if((keyCode == 9) && (company_selected==true)&& (comp_type_needed_for_company_selected==false)) {// TAB key from Company Name takes to Next Button only for existing company and comp_type is not needed
              e.preventDefault(); 
              $jq("#wizard").smartWizard("getNextButton").addClass("smart-wizard-button-selected");
              $jq("#wizard").smartWizard("getNextButton").focus();
          }
          else if((keyCode == 9) && (creating_new_company==false)&& (company_selected==false)) {// TAB key from Company Name stays there if neither new company nor existing company is selected
              e.preventDefault();
              //alert('TAB key from Company Name stays there if neither new company nor existing company is selected'); 
          } 
        });

        //TAB key from Company Type takes to Next Button only for existing company and if comp_type is needed
        $jq("#comp_type").multiselect("getButton").keydown(function (e) {
          var keyCode = e.keyCode || e.which;         
          //alert('TAB key from Company Type takes to Next Button only for existing company and if comp_type is needed'+comp_type_needed_for_company_selected);        
          if((!e.shiftKey) && (keyCode == 9)&& (comp_type_needed_for_company_selected==true)) {
              e.preventDefault(); 
              $jq("#wizard").smartWizard("getNextButton").addClass("smart-wizard-button-selected");
              $jq("#wizard").smartWizard("getNextButton").focus();          
          }            
        });

        //TAB key or SHIFT TAB key from Next Button takes to Company Name
        $jq("#wizard").smartWizard("getNextButton").keydown(function (e) {
          var keyCode = e.keyCode || e.which;         
          if(keyCode == 9) {
            e.preventDefault(); 
            $jq("#wizard").smartWizard("getNextButton").removeClass("smart-wizard-button-selected");
            $jq("#acountName").focus();
          } 
        });  
        
        //TAB key from Company Description takes to Next Button        
        $jq("#comp_desc").keydown(function (e) {
          var keyCode = e.keyCode || e.which; 
        
          if((!e.shiftKey) && (keyCode == 9)) {
            e.preventDefault(); 
              $jq("#wizard").smartWizard("getNextButton").addClass("smart-wizard-button-selected");
              $jq("#wizard").smartWizard("getNextButton").focus();
          } 
        });        
        
              
        $jq("#dealname").keydown(function (e) {
          var keyCode = e.keyCode || e.which; 
        
          //TAB key from Deal Name takes to Project Name
          if((!e.shiftKey) && (keyCode == 9)) {
            e.preventDefault(); 
            $jq("#projname").focus();
          } 
          else if((e.shiftKey) && (keyCode == 9)) { //SHIFT TAB key from Deal Name takes to Previous button
            e.preventDefault(); 
              $jq("#wizard").smartWizard("getPreviousButton").addClass("smart-wizard-button-selected");
              $jq("#wizard").smartWizard("getPreviousButton").focus();
          } 
        });

         //SHIFT TAB key from Project Name takes to Deal Name
        $jq("#projname").keydown(function (e) {
          var keyCode = e.keyCode || e.which; 
        
          if((e.shiftKey) && (keyCode == 9)) {
            e.preventDefault(); 
            $jq("#dealname").focus();
          } 
        });
             
                           
        $jq("#Key_date_Nxt").keydown(function (e) {
          var keyCode = e.keyCode || e.which; 
        
          if (!(e.shiftKey) && (keyCode == 9)) { //TAB key from KeyDate takes to Previous button
            e.preventDefault();
            //alert('Tab pressed from KeyDate to previous'); 
            $jq("#wizard").smartWizard("getPreviousButton").addClass("smart-wizard-button-selected");
            $jq("#wizard").smartWizard("getPreviousButton").focus();
          }
          else if((e.shiftKey) && (keyCode == 9)) { //SHIFT TAB key from KeyDate takes to Deal Description
            e.preventDefault(); 
            //alert('SHIFT Tab pressed from KeyDate to Deal Desc'); 
            $jq("#deal_desc").focus();
          } 
        });

    
        
        $jq("#wizard").smartWizard("getPreviousButton").keydown(function (e) {
          var keyCode = e.keyCode || e.which; 
        
          if((e.shiftKey) && (keyCode == 9)) { //SHIFT TAB key from Previous Button takes to KeyDate
            e.preventDefault(); 
            //alert('SHIFT Tab pressed from PreviousButton to KeyDate');
            $jq("#wizard").smartWizard("getPreviousButton").removeClass("smart-wizard-button-selected");
            $jq("#Key_date_Nxt").focus();
          } 
          else if (!(e.shiftKey) && (keyCode == 9)) { //TAB key from Previous Button takes to CreateDeal
            e.preventDefault(); 
            //alert('Tab pressed from PreviousButton to FinishButton');
            $jq("#wizard").smartWizard("getPreviousButton").removeClass("smart-wizard-button-selected");
            $jq("#wizard").smartWizard("getFinishButton").addClass("smart-wizard-button-selected");
            $jq("#wizard").smartWizard("getFinishButton").focus();
          }
        });


            
           
        $jq("#wizard").smartWizard("getFinishButton").keydown(function (e) {
          var keyCode = e.keyCode || e.which; 
        
          if((e.shiftKey) && (keyCode == 9)) { //SHIFT TAB key from CreateDeal takes to Previous Button
            e.preventDefault(); 
            //alert('SHIFT Tab pressed from FinishButton to PreviousButton ');
            $jq("#wizard").smartWizard("getFinishButton").removeClass("smart-wizard-button-selected");
            $jq("#wizard").smartWizard("getPreviousButton").addClass("smart-wizard-button-selected");
            $jq("#wizard").smartWizard("getPreviousButton").focus();
          } 
          else if(!(e.shiftKey) && (keyCode == 9)) { //TAB key from CreateDeal takes to DealName
            e.preventDefault(); 
            //alert('SHIFT Tab pressed from FinishButton to PreviousButton ');
            $jq("#wizard").smartWizard("getFinishButton").removeClass("smart-wizard-button-selected");
            $jq("#dealname").focus();
          } 
        });
                        
        $jq("#statename").autocomplete({
            minLength : 1,
            source: function(request, response) {
                WP_DealQuickCreateController.getStateList(
                    request.term,
                    function(data, event) {
                    if ( true ){                    
                   state_list = $jq.map(data, function(item) {                    
                    return { label : item.label, value : item.label , id : item.state_id}
                        }
                    ); 
                    }        
                    response(state_list);
                    }
                );                     
            }
                       
        });

        $jq("#cityname").autocomplete({
            minLength : 2,
            source: function(request, response) {
                WP_DealQuickCreateController.getCityList(
                    request.term,
                    function(data, event) {
                    if ( true ){                    
                  city_list = $jq.map(data, function(item) {                    
                    return { label : item.label, value : item.label , id : item.city_id}
                        }
                    ); 
                    }        
                    response(city_list);
                    }
                );                     
            }
                       
        });
           
        $jq("#countryname").autocomplete({
            minLength : 1,
            source: function(request, response) {
                WP_DealQuickCreateController.getCountryList(
                    request.term,
                    function(data, event) {
                    if ( true ){                    
                  country_list = $jq.map(data, function(item) {                    
                    return { label : item.label, value : item.label , id : item.country_id}
                        }
                    ); 
                    }        
                    response(country_list);
                    }
                );                     
            }
                       
        });

              $jq("#EnergyFundname").multiselect({
                selectedList: 1,
                minWidth: 269, 
                height: 115,         
                multiple:false,
                header: "Select ...",
                classes:'classForCompType',
                close:function(event,ui){
                  $jq("#EnergyFundname").multiselect("getButton").focus();       
                }
             });  
  var sEnergyToolTip='Please specify if this is a potential Energy opportunity.</p></p><table border="0"><tr><td colspan=4>Examples of Energy and Natural Resources Activities include:</td></tr><tr><td  valign="top">(a)</td><td colspan=2>The exploration, production, provision, development, extraction, processing, transportation, refining, storage, distribution, marketing and/or trading of: </td></tr> <tr><td></td><td valign="top">(i)</td><td>oil, gas, ethanol, coal or other natural resources used to produce energy;</td></tr><tr><td></td><td valign="top">(ii)</td><td>natural resources and commodities other than oil and gas, such as base metals, precious metals, rare earth minerals, timber and gemstones;</td></tr>';
   sEnergyToolTip=sEnergyToolTip+'<tr><td></td><td valign="top">(iii)</td><td>electrical power; and</td></tr><tr><td></td><td valign="top">(iv)</td><td>renewable energy resources, including power generation therefrom (e.g., derived from sunlight, wind, rain, tides, waves, plant and forest products, wastes or geothermal heat).</td></tr><tr><td valign="top">(b)</td><td colspan=2>Companies, businesses, projects or other enterprises that, are expected to derive the majority of their value from the provision of goods or services to entities engaged in one or more of the businesses described in (1)(b)(i) through (1)(b)(iv) ("Energy Services").</td></tr> <tr><td valign="top">(c)</td>';
   sEnergyToolTip=sEnergyToolTip+'<td colspan=2>Other assets determined to be related or complementary to any of the foregoing.</td></tr> </table>';
                                         
             $jq(function () {
                  $jq.widget("ui.tooltip", $jq.ui.tooltip, {
                   
                        options: {
                        tooltipClass:"custom-tooltip",
                              content: function () {
                               if (this.id == 'energy_bulb') 
                                 return sEnergyToolTip;//$jq(this).prop('title');
                               //else return $jq(this).prop('title');
                             }
                        }
                });
                $jq(document).tooltip();
              });    
              $jq("#stagename").multiselect({
                selectedList: 1,
                minWidth: 269,
                menuWidth: 350,
                multiple:false,
                header: "Select ...",
                classes:'classForCompType',
                close:function(event,ui){
                  $jq("#stagename").multiselect("getButton").focus();       
                }
             });  
    
       $jq("#StageLifename").multiselect({
                selectedList: 1,
                minWidth: 269,
                height: 115,                
                multiple:false,
                header: "Select ...",
                classes:'classForCompType',
                close:function(event,ui){
                  $jq("#StageLifename").multiselect("getButton").focus();       
                }
             });  

        

        WP_DealQuickCreateController.getSectorElemInGroupNameList(
              function(data, event) {              
              var temp_array = {};
              if ( true ){                    
                temp_array = $jq.map(data, function(item) {                    
                return { label : item.label, value : item.label , id : item.id}
              }
                 ); 
                 _.each(temp_array, function(elem, index){ sector_elem_in_group_name_list[sector_elem_in_group_name_list.length++]=elem.value;/*alert('actual:'+sector_elem_in_group_name_list[index]+'..'+sector_elem_in_group_name_list.length+elem.value);*/ });
                 
              }              
        });
        
        WP_DealQuickCreateController.getGeoNameList(
              function(data, event) {              
              var temp_array = {};
              if ( true ){                    
                temp_array = $jq.map(data, function(item) {                    
                return { label : item.label, value : item.label , id : item.id}
              }
                 ); 
                 _.each(temp_array, function(elem, index){ geo_name_list[geo_name_list.length++]=elem.value;/*alert('actual:'+geo_name_list[index]+'..'+geo_name_list.length+elem.value);*/ });
                 
                 populateGeoList('optionsgeography');
                 populateGeoList('optionsgeography2');
                 

        
                 
              }              
        });

        
       
        WP_DealQuickCreateController.getSectorGroupNameLenList(
              function(data, event) {              
              var temp_array = {};
              if ( true ){                    
                temp_array = $jq.map(data, function(item) {                    
                return { label : item.label, value : item.len, id : item.id}
              }
                 ); 
                 _.each(temp_array, function(elem, index){ 
                   sector_group_name_list[sector_group_name_list.length++]=elem.label;
                   sector_group_len_list[sector_group_len_list.length++]=elem.value;/*alert('actual:'+sector_group_len_list[index]+'..'+sector_group_len_list.length+'length:'+ sector_group_name_list[index]);*/});
                 
                populateSectorList('optionsector',true);
                populateSectorList('optionsector2',false);          
                
       

                 
              }              
        });
       



        
        WP_DealQuickCreateController.getDealStageList(
              function(data, event) {              
              var temp_array = {};
              if ( true ){                    
                temp_array = $jq.map(data, function(item) {                    
                return { label : item.label, value : item.label , id : item.id}
              }
                 ); 
                 _.each(temp_array, function(elem, index){ deal_stage_list[deal_stage_list.length++]=elem.value;/*alert('actual:'+deal_stage_list[index]+'..'+deal_stage_list.length+elem.value);*/ });
                 
                 populateDealStageList();                       
                 
              }              
        });        

        WP_DealQuickCreateController.getLifeCycleDealStageList(
              function(data, event) {              
              var temp_array = {};
              if ( true ){                    
                temp_array = $jq.map(data, function(item) {                    
                return { label : item.label, value : item.label , id : item.id}
              }
                 ); 
                 _.each(temp_array, function(elem, index){ life_cycle_deal_stage_list[life_cycle_deal_stage_list.length++]=elem.value;
                 /*alert('actual:'+life_cycle_deal_stage_list[index]+'..'+life_cycle_deal_stage_list.length+elem.value);*/ });
                 
                 populateLifeCycleDealStageList();                       
                 
              }              
        });    
        
        WP_DealQuickCreateController.getCompTypeList(
              function(data, event) {              
              var temp_array = {};
              if ( true ){                    
                temp_array = $jq.map(data, function(item) {                    
                return { label : item.label, value : item.label , id : item.id}
              }
                 ); 
                 _.each(temp_array, function(elem, index){ comp_type_list[comp_type_list.length++]=elem.value;/*alert('actual:'+comp_type_list[index]+'..'+comp_type_list.length+elem.value);*/ });
                 
                 populateCompTypeList();
                 clearValuesFromCompPage();                       
                 
              }              
        });     


        /*WP_DealQuickCreateController.enterDeafultUSStates(
              function(data, event) {              
         
        });*/        

        setDefaultDealTeam();
        setDefaultFund();
        getWPGroupOfCurrentUser();
        setCompPageUnEdiTable();
        
        $jq("#wizard").show();
        $jq("#progressbar").hide();  
               
});

function setDefaultDealTeam()
{

        WP_DealQuickCreateController.getCurrUserProfessionalInfo(
              function(data, event) { 
             

                   deal_team_info_list =  $jq.map(data, function(item) {                    
                     return { label : item.label, value : item.label, id : item.user_id, 
                                 contact_id : item.contact_id, user_initial:item.initials}});            
                   
       
                       
                 _.each(deal_team_info_list, function(elem, index){ 
                      //alert(deal_team_info_list.length+':'+elem.label+':'+elem.id+':'+elem.id+':'+elem.contact_id+':'+elem.user_initial);
                      
                      if(elem.label == '')
                      {
                        deal_team_initials_string='';
                        deal_team_contact_id_list.length=0;
                        deal_team_info_list.length=0;
                      }
                      else
                      {
                        deal_team_initials_string= elem.user_initial;  
                        deal_team_contact_id_list.push(elem.contact_id);            
                      }
                                     
           
                 });          
                
                 
        
        });       


}
   function openGeneralDialog(dialog_content,dialog_title){ 
         
         $jq( "#dialog-general-info" ).dialog({
            resizable: false,
            open: function(event, ui) {
              $jq(this).html(dialog_content);
            },          
            autoOpen: true, 
            modal: true, 
            width: 525,             
            position: 'center',     
            title: dialog_title,       
            buttons: {
               "OK": function() {                                                                                             
                   $jq(this).dialog("close");
               }
            }
         });
         
   }
    
function setDefaultFund()
{

        WP_DealQuickCreateController.getDefaultFund(
              'WP XI',
              function(data, event) { 
                   if(data==null)
                   {   
                      alert('getDefaultFund:'+event.message);return;
                   }

                   fund_info_list =  $jq.map(data, function(item) {                    
                     return { label : item.label, value : item.label, id : item.fund_id, 
                                 fund_name:item.fund_name}});            
                   
       
                       
                 _.each(fund_info_list, function(elem, index){ 
                      //alert(fund_info_list.length+':'+elem.label+':'+elem.id+':'+':'+':'+elem.fund_name);
                      
                      if(elem.label == '')
                      {
                        fund_names_string='';
                        fund_names_id_list.length=0;
                        fund_info_list.length=0;
                      }
                      else
                      {
                        fund_names_string= elem.fund_name;  
                        fund_names_id_list.push(elem.id);            
                      }
                                     
           
                 });          
                
                 
        
        });     

}

function populateFilteredSectorList(filter_sector_name)
{
    
       
       var newOptGrp;      
       var index=0;
       var temp_string1,temp_string2;
       var skip_this_grp;
       var wp_group_info_list= new Array();
       var prev_selections;
      if(filter_sector_name == 'sectorname')
      {
        prev_selections =  $jq("#sectorname").multiselect("getChecked").map(function(){return this.value;}).get();      
      }
      else
      {
        prev_selections =  $jq("#sectorname2").multiselect("getChecked").map(function(){return this.value;}).get();  
       //alert(prev_selections);           
      }
      
      if(filter_sector_name == 'sectorname')
      {
       $jq("#optionsector").empty();
       wp_group_info = $jq("#wpgroup").multiselect("getChecked").map(function(){return this.value;}).get();
       wp_group_info_list=wp_group_info.toString().split(",");
      }
      else
      {
       $jq("#optionsector2").empty();
       wp_group_info2 = $jq("#wpgroup2").multiselect("getChecked").map(function(){return this.value;}).get();
       wp_group_info_list=wp_group_info2.toString().split(","); 
       //alert('2'+wp_group_info2); 
      }

       
       
      //alert('begin'+wp_group_info_list.length+':'+sector_group_name_list.length+':'+wp_group_info);
       for(var grp_index=0;grp_index < sector_group_name_list.length;++grp_index)
       {
         skip_this_grp=true;
         for(var i=0;i<wp_group_info_list.length;++i)
         {
           //alert('Len:'+sector_group_name_list[grp_index].length+'Data:'+sector_group_name_list[grp_index]+'Len:'+wp_group_info_list[i].length+'Data:'+wp_group_info_list[i]);
          if(wp_group_info_list[i]== 'Financial Services')
            wp_group_info_list[i] = 'FIG';
            
           if(sector_group_name_list[grp_index]==wp_group_info_list[i])
           {
             skip_this_grp=false;
             //alert('Found the group'+sector_group_name_list[grp_index]+wp_group_info_list[i]);
             break;
           }
         }
         
         if(skip_this_grp == true)
         {
           index+=sector_group_len_list[grp_index];
           //alert('Skipping: index'+index+':'+grp_index);
         }
         else
         {
        
         
         temp_string1= '<optgroup label=\"';
         temp_string1= temp_string1.concat(sector_group_name_list[grp_index]);
         temp_string1= temp_string1.concat('\">');
         //alert('adding group'+temp_string1+'grp_index:'+grp_index+'index:'+index+'len:'+sector_group_len_list[grp_index]);

         if(filter_sector_name == 'sectorname')
         {
           $newOptGrp = $jq(temp_string1).appendTo('#optionsector');
         }
         else
         {
           $newOptGrp = $jq(temp_string1).appendTo('#optionsector2');
         }
         
         for(var elem_index=0;elem_index < sector_group_len_list[grp_index];++elem_index)
         {          
                   
           temp_string1= sector_group_name_list[grp_index].concat('-');
           temp_string1= temp_string1.concat(sector_elem_in_group_name_list[index]);
           
           temp_string2='<option value=\"';
           temp_string2=temp_string2.concat(temp_string1);
           temp_string2=temp_string2.concat('\">');
           temp_string2=temp_string2.concat(sector_elem_in_group_name_list[index]);
           temp_string2=temp_string2.concat('<\/option>');
           ++index;
           $jq(temp_string2).appendTo($newOptGrp);
         // alert('adding industry:'+temp_string2+':'+index);
           if(elem_index == (sector_group_len_list[grp_index]-1))
           {
             temp_string1='<\/optgroup>';
             $jq(temp_string1).appendTo($newOptGrp);
            // alert('adding group tag:'+temp_string1+':'+index);           
           }
         }
        }
       }      
      // alert('end');   


         if(filter_sector_name == 'sectorname')
         {
           $jq("#sectorname").multiselect("refresh");
         }
         else
         {
           $jq("#sectorname2").multiselect("refresh");
         }       
         
         
       if((prev_selections != null) && (prev_selections!=''))
       {
       var sector_list_values = prev_selections.toString().split(',');
       //alert(sector_list_values.length);
       for(var elem_index=0;elem_index < sector_list_values.length;++elem_index)
       {    
         if(filter_sector_name == 'sectorname')
         {              
          $jq("#sectorname").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert(sector_list_values[elem_index]+':'+sector_list_values[elem_index].length+':'+ui.value+':'+ui.value.length);
             if((ui.value == sector_list_values[elem_index]) && (ui.checked == false))
             this.click();
          });
         }
         else
         {
          $jq("#sectorname2").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert(sector_list_values[elem_index]+':'+sector_list_values[elem_index].length+':'+ui.value+':'+ui.value.length);
             if((ui.value == sector_list_values[elem_index]) && (ui.checked == false))
             {
               this.click();
               //alert('checked'+ui.value);
             }
          });          
          
         }
       }
       } 

         if(filter_sector_name == 'sectorname')
         {
           $jq("#sectorname").multiselect("refresh");
         }
         else
         {
           $jq("#sectorname2").multiselect("refresh");
         }       
       

}

function populateSectorList(sector_name,empty_the_list)
{
    
       populateWPGroupList('wpgroup');
       populateWPGroupList('wpgroup2');
       
       var newOptGrp;      
       var index=0;
       var temp_string1,temp_string2;

       if(sector_name == 'optionsector')
       {
         $jq("#optionsector").empty();
       }
       else
       {
 
         $jq("#optionsector2").empty();       
       }
              
       //alert('begin'+sector_group_name_list.length);
       for(var grp_index=0;grp_index < sector_group_name_list.length;++grp_index)
       {
        
         temp_string1= '<optgroup label=\"';
         temp_string1= temp_string1.concat(sector_group_name_list[grp_index]);
         temp_string1= temp_string1.concat('\">');
         //alert('no1:'+temp_string1);

         if(sector_name == 'optionsector')
         {
           $newOptGrp = $jq(temp_string1).appendTo('#optionsector');
         }
         else
         {
           $newOptGrp = $jq(temp_string1).appendTo('#optionsector2');
         }
         for(var elem_index=0;elem_index < sector_group_len_list[grp_index];++elem_index)
         {          
                   
           temp_string1= sector_group_name_list[grp_index].concat('-');
           temp_string1= temp_string1.concat(sector_elem_in_group_name_list[index]);
           
           temp_string2='<option value=\"';
           temp_string2=temp_string2.concat(temp_string1);
           temp_string2=temp_string2.concat('\">');
           temp_string2=temp_string2.concat(sector_elem_in_group_name_list[index]);
           
           temp_string2=temp_string2.concat('<\/option>');
           ++index;
           $jq(temp_string2).appendTo($newOptGrp);
           //alert('adding industry:'+temp_string2+':'+index);
           if(elem_index == (sector_group_len_list[grp_index]-1))
           {
             temp_string1='<\/optgroup>';
             $jq(temp_string1).appendTo($newOptGrp);
             //alert('adding group tag:'+temp_string1+':'+index);           
           }           

         }
       }      
       //alert('end');   
       
         if(sector_name == 'optionsector')
         {
            if(empty_the_list== true)
             $jq("#optionsector").empty();//If we want the list to be empty when page loads
            $jq("#sectorname").multiselect("refresh");   
         }
         else
         {
           //We want sector list 2 to be loaded.
          $jq("#sectorname2").multiselect("refresh"); 
         }        
          
                
       
}

function populateGeoList(geo_name)
{
       var temp_string;


       if(geo_name == 'optionsgeography')
       {   
         $jq("#optionsgeography").empty();
       }
       else
       {      
         $jq("#optionsgeography2").empty();       
       }
              
       //alert('begin'+ geo_name_list.length);
       for(var grp_index=0;grp_index <  geo_name_list.length;++grp_index)
       {
        
         temp_string= '<option value=\"';
         temp_string= temp_string.concat(geo_name_list[grp_index]);
         temp_string= temp_string.concat('\">');
         temp_string=temp_string.concat(geo_name_list[grp_index]);
         temp_string=temp_string.concat('<\/option>');
         //alert('no1:'+temp_string);

         if(geo_name == 'optionsgeography')
         {
           $newOptGrp = $jq(temp_string).appendTo('#optionsgeography');        
         }
         else
         {
           $newOptGrp = $jq(temp_string).appendTo('#optionsgeography2');         
         }

       }      
       //alert('end');
       if(geo_name == 'optionsgeography')
       {    
         $jq("#geographyname").multiselect("refresh"); 
       }
       else
       {
          $jq("#geographyname2").multiselect("refresh");  
       }       
} 
 
function populateWPGroupList(group_name)
{
       var temp_string;

       if(group_name == 'wpgroup')
       {
         $jq("#wpgroup").empty();
       }
       else
       {
         $jq("#wpgroup2").empty();
       }
       
       //alert('begin'+ sector_group_name_list.length);
       for(var grp_index=0;grp_index <  sector_group_name_list.length;++grp_index)
       {
        
         temp_string= '<option value=\"';
         if(sector_group_name_list[grp_index] == 'FIG')
         {
           temp_string= temp_string.concat('Financial Services');
           temp_string= temp_string.concat('\">');
           temp_string=temp_string.concat('Financial Services');         
         }
         else
         {
           temp_string= temp_string.concat(sector_group_name_list[grp_index]);
           temp_string= temp_string.concat('\">');
           temp_string=temp_string.concat(sector_group_name_list[grp_index]);
         }

         temp_string=temp_string.concat('<\/option>');
         //alert('no1:'+temp_string);

       if(group_name == 'wpgroup')
       {
         $newOptGrp = $jq(temp_string).appendTo("#wpgroup"); 
       }
       else
       {
         $newOptGrp = $jq(temp_string).appendTo("#wpgroup2");      
       }
 
              

       }   
       
       if(group_name == 'wpgroup')
       {
         $jq("#wpgroup").multiselect("refresh"); 
       }
       else
       {
         $jq("#wpgroup2").multiselect("refresh");   
       }       
       
          
       //alert('end');
}        
    
function populateDealStageList()
{
       var temp_string;

       $jq("#optionstage").empty();

       
       //alert('begin'+ deal_stage_list.length);
       for(var grp_index=0;grp_index <  deal_stage_list.length;++grp_index)
       {
        
         temp_string= '<option value=\"';
         temp_string= temp_string.concat(deal_stage_list[grp_index]);
         temp_string= temp_string.concat('\">');
         temp_string=temp_string.concat(deal_stage_list[grp_index]);
         temp_string=temp_string.concat('<\/option>');
         //alert('no1:'+temp_string);

         $newOptGrp = $jq(temp_string).appendTo('#optionstage');        

       }   
       $jq("#stagename").multiselect("refresh");   
    
       var energy_string;
       var newEnergyOpt='';

       $jq("#optionEnergy").empty();
       
       energy_string= '<option value=\"';
       energy_string= energy_string.concat("Select ...");
       energy_string= energy_string.concat('\">');
       energy_string= energy_string.concat("Select ...");
       energy_string= energy_string.concat('<\/option>');
       $newEnergyOpt = $jq(energy_string).appendTo('#optionEnergy');     
                                   
       energy_string= '<option value=\"';
       energy_string= energy_string.concat("No");
       energy_string= energy_string.concat('\">');
       energy_string= energy_string.concat("No");
       energy_string= energy_string.concat('<\/option>');
       $newEnergyOpt = $jq(energy_string).appendTo('#optionEnergy');      
       
       energy_string ='<option value=\"';
       energy_string= energy_string.concat("Yes");
       energy_string= energy_string.concat('\">');
       energy_string= energy_string.concat("Yes");
       energy_string= energy_string.concat('<\/option>');       
       $newEnergyOpt = $jq(energy_string).appendTo('#optionEnergy'); 
       
       $jq("#EnergyFundname").multiselect("refresh"); 
       //alert('end');
}     

function populateLifeCycleDealStageList()
{
       var temp_string;

       $jq("#optionstage2").empty();

       
       //alert('begin'+ life_cycle_deal_stage_list.length);
       for(var grp_index=0;grp_index <  life_cycle_deal_stage_list.length;++grp_index)
       {
        
         temp_string= '<option value=\"';
         temp_string= temp_string.concat(life_cycle_deal_stage_list[grp_index]);
         temp_string= temp_string.concat('\">');
         temp_string=temp_string.concat(life_cycle_deal_stage_list[grp_index]);
         temp_string=temp_string.concat('<\/option>');
         //alert('no1:'+temp_string);

         $newOptGrp = $jq(temp_string).appendTo('#optionstage2');        

       }   
       $jq("#StageLifename").multiselect("refresh");   
       //alert('end');
}   
  
function populateCompTypeList()
{
       var temp_string;

       $jq("#comp_type_sel").empty();

       
       //alert('begin'+ comp_type_list.length);
       //add default value here.
       var defval = '<option value=\"\">Select options<\/option>';
       $jq(defval).appendTo('#comp_type_sel');   
       
       if(comp_type_list.length > 0) {
       for(var grp_index=comp_type_list.length-1;grp_index >=0;grp_index--)
       {
        
         temp_string= '<option value=\"';
         temp_string= temp_string.concat(comp_type_list[grp_index]);
         temp_string= temp_string.concat('\">');
         temp_string=temp_string.concat(comp_type_list[grp_index]);
         temp_string=temp_string.concat('<\/option>');
         //alert('no1:'+temp_string);

         $newOptGrp = $jq(temp_string).appendTo('#comp_type_sel');        

       }   
       
      }
      
      $jq("#comp_type_sel").val('');      
      $jq("#comp_type").multiselect({                           
           noneSelectedText:''
      });      
      
      $jq("#comp_type").multiselect("refresh");   
       
       //alert('end');
}   
    
function openDialog(){ 
         
         $jq( "#dialog-confirm" ).dialog({
            resizable: false,
            autoOpen: true, 
            modal: true, 
            position: 'center',       
            buttons: {
               "Yes": function() {                         

                        
                        clearValuesFromDealPage();     
                        setCompPageEdiTable();                 
                        setWPGroupOfCurrentUserOnCompPage();                                    
                        $jq(this).dialog("close");
               },
               
               "No": function() {           

                          
                          clearValuesFromCompPage();
                          clearValuesFromDealPage();                                 
                          setCompPageUnEdiTable();
                          setDealPageUnEdiTable();       
                          $jq(this).dialog("close");
               }
            }
         }).parent().find(".ui-dialog-titlebar-close").click(function() {
      
                          clearValuesFromCompPage();
                          clearValuesFromDealPage();                                 
                          setCompPageUnEdiTable();
                          setDealPageUnEdiTable();        
                       
                          $jq(this).dialog("close");
            });
         
}

function showAStepCallback(obj){
 if(obj.attr('rel') != 1){
   //alert('showstep'+ obj.attr('rel'));
   $jq("#dealname").focus();
   $jq("#wizard").smartWizard("getNextButton").removeClass("smart-wizard-button-selected");
   $jq("#wizard").smartWizard("getPreviousButton").removeClass("smart-wizard-button-selected");
   $jq("#wizard").smartWizard("getFinishButton").removeClass("smart-wizard-button-selected");
 }

 if((obj.attr('rel') == 1) && ( (creating_new_company) || (company_selected)  ) )
 {
   //$jq("#acountName").focus();
   $jq("#wizard").smartWizard("getNextButton").focus();
   $jq("#wizard").smartWizard("getNextButton").addClass("smart-wizard-button-selected");
 }
}    

function leaveAStepCallback(obj){//Triggers when "SaveComp" button is called

                     if(obj.attr('rel') != 1)
                     {
                     //   alert(obj.attr('rel'));
                        return true;
                     }                    

                      setDealPageEdiTable();
                      var acountName =$jq("#acountName").val();

                      propagateValuesFromCompPageToDealPage();
                      


                      var companytype =$jq("#comp_type"+ " option:selected").val(); 
                      var cityname =$jq("#cityname").val();
                      var statename =$jq("#statename").val();
                      var countryname =$jq("#countryname").val();                       
                      var compdesc=$jq("#comp_desc").val();     
                      

                      
                       //alert(compdesc);
                      if((acountName == null)|| (acountName == "")||(acountName == ''))
                      {
                         $jq("#wizard").smartWizard("getNextButton").removeClass("smart-wizard-button-selected");
                         $jq("#acountName").focus();
                         alert('Please select one of the existing companies listed or choose Create New Company after entering a company name.');                         
                         return false;
                      }
                      
                       if((creating_new_company==false) && (company_selected==false))
                       {

                     
                          alert('Please select one of the existing companies listed or choose Create New Company after entering a company name.');
                          
                          clearValuesFromDealPage();                        
                          clearValuesFromCompPage();                        

                          setCompPageUnEdiTable();
                          setDealPageUnEdiTable();
                          $jq("#acountName").focus();
                          return false;     
                       }
                       
                      if((companytype == null)|| (companytype == "")||(companytype == ''))
                      {
                        $jq("#wizard").smartWizard("getNextButton").removeClass("smart-wizard-button-selected");                     
                        alert('Please indicate if the company is Public or Private.' );
                        $jq("#comp_type").multiselect("getButton").focus();                       
                        return false;
                      }                                                                   
                     
                      else if (companytype == 'Public') {
                        $jq("#projnameRedLine").show();
                      }
                      else if (companytype == 'Private') {
                        $jq("#projnameRedLine").hide();
                      }                    
    

      return true;
}
      

function getExistingAccountInfo(comp_id, keepExistingDeal)//This function gets the selected Account information to display
{
      
        // alert('getExistingAccountInfo:'+comp_id);
         
         
        WP_DealQuickCreateController.getAccountInfo(
              comp_id,
              function(data, event) {
                    //alert(data.stgAccountName);
                    //alert(data.stgStateName);
                    //alert(data.stgCountryName);
                    //alert(data.stgCityName);
                    //alert(data.stgCompType);
                    //alert(data.stgSectorName);
                    //alert(data.stgGeoName);
                    //alert(data.compdesc);
                    //alert(data.result);
                    //alert(data.id);
                    
                     
                    $jq("#acountName").val(data.stgAccountName);
                    
                    $jq("#comp_type_sel").val(data.stgCompType);
                    if( (data.stgCompType == null) || (data.stgCompType == '') ){           
                        $jq("#comp_type").multiselect({                           
                           noneSelectedText:''
                          });
                    }

                    var companytype =$jq("#comp_type"+ " option:selected").val();

                    if((companytype == null)|| (companytype == "")||(companytype == ''))
                    {
                       comp_type_needed_for_company_selected=true;
                       $jq("#comp_type").multiselect("getButton").addClass('mark-multiselect-white');                           
                       $jq("#comp_type").multiselect({
                           beforeopen: function(event,ui){return true;},
                           noneSelectedText:'Select ...'
                          });
                    }

                                          
                    $jq("#comp_type").multiselect("refresh");
        

                     
                         
       geo_info=data.stgGeoName;
       geo_info2=data.stgGeoName;        
       var geo_temp=data.stgGeoName;
       if((geo_temp != null) && (geo_temp!=''))
       {
       var geo_list_values=geo_temp.toString().split(';');
       //alert('geo length'+geo_list_values.length);
       for(var elem_index=0;elem_index < geo_list_values.length;++elem_index)
       {  
         //alert('geo1:'+geo_list_values[elem_index]);
          $jq("#geographyname").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert('geo2:'+geo_list_values[elem_index]+':'+geo_list_values[elem_index].length+':'+ui.value+':'+ui.value.length);
             if((ui.value == geo_list_values[elem_index]) && (ui.checked == false))
             this.click();
          }); 
          
          $jq("#geographyname2").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert('geo2:'+geo_list_values[elem_index]+':'+geo_list_values[elem_index].length+':'+ui.value+':'+ui.value.length);
             if((ui.value == geo_list_values[elem_index]) && (ui.checked == false))
             this.click();
          });           
       
       }
       }         
       
       if((data.stgSectorName != null) && (data.stgSectorName!=''))
       {
        sector_info=data.stgSectorName.replace( /\&amp\;/g,"\&");
       }
       else
       {
         sector_info='';
       }
       sector_info2=sector_info;
       var sector_temp=sector_info;       
       //alert(sector_temp); 

   
      wp_group_info='';
      wp_group_info2='';   
      setWPGroupOfCurrentUser();
      entering_deal_page_first_time=false;
      
       if((sector_temp != null) && (sector_temp!=''))
       {
       var sector_list_values = sector_temp.toString().split(';');
       //alert(sector_list_values.length);
       for(var elem_index=0;elem_index < sector_list_values.length;++elem_index)
       {                    
          var temp_group= sector_list_values[elem_index].toString().split('-');
          var tem_group_name=temp_group[0];
         //alert(tem_group_name+':'+ sector_list_values.length);
          

          $jq("#wpgroup").multiselect("widget").find(":checkbox").each(function(event,ui) {
              //alert(tem_group_name,+':'+tem_group_name.length+':'+ui.value+':'+ui.value.length);
             if(tem_group_name == 'FIG')
               tem_group_name = 'Financial Services';             
             if((ui.value == tem_group_name) && (ui.checked == false))
             {
               this.click();
             }
          });
          
          $jq("#wpgroup2").multiselect("widget").find(":checkbox").each(function(event,ui) {
              //alert(tem_group_name,+':'+tem_group_name.length+':'+ui.value+':'+ui.value.length);
             if(tem_group_name == 'FIG')
               tem_group_name = 'Financial Services';
             if((ui.value == tem_group_name) && (ui.checked == false))
             {
               this.click();
              
             }
          });          

       }
       } 


      populateFilteredSectorList('sectorname');
      populateFilteredSectorList('sectorname2');        
    
       
      $jq("#sectorname").multiselect("refresh");
      $jq("#sectorname2").multiselect("refresh");
     
       if((sector_temp != null) && (sector_temp!=''))
       {
       var sector_list_values = sector_temp.toString().split(';');
       //alert(sector_list_values.length);
       for(var elem_index=0;elem_index < sector_list_values.length;++elem_index)
       {           
          $jq("#sectorname").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert(sector_list_values[elem_index]+':'+sector_list_values[elem_index].length+':'+ui.value+':'+ui.value.length);
             if((ui.value == sector_list_values[elem_index]) && (ui.checked == false))
             this.click();
          });

          $jq("#sectorname2").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert(sector_list_values[elem_index]+':'+sector_list_values[elem_index].length+':'+ui.value+':'+ui.value.length);
             if((ui.value == sector_list_values[elem_index]) && (ui.checked == false))
             {
               this.click();
               //alert('checked'+ui.value);
             }
          });          
          

       }
       } 
       
                    $jq("#cityname").val(data.stgCityName);
                    $jq("#statename").val(data.stgStateName);                     
                    $jq("#countryname").val(data.stgCountryName);
                    $jq("#comp_desc").val(data.compdesc);                   
                    $jq("#compname").val(data.stgAccountName);
                  
                  if(!keepExistingDeal) {
                    $jq("#projname").val(data.stgAccountName);
                    $jq("#dealname").val(data.stgAccountName);
                  }


                
               
         
        });         
         
        setCompPageUnEdiTable();                         
} 
      
function onFinishCallback()
{ //Triggers when "SaveDeal" button is called         

    var compName =$jq("#compname").val();
    var projName =$jq("#projname").val();
    var dealName =$jq("#dealname").val();
    
    if ($jq("#comp_type"+ " option:selected").val() == 'Public' && projName == '') {
        openGeneralDialog('Because this is a deal with a public company, please enter a Project Name.  The Project Name cannot be the same as the Deal Name or the Company Name.  As per Compliance, this code name is to be used in place of the target company name in internal and external communications, as appropriate.',validation_string);
        $jq("#projname").focus();  
        return false;

    } 
    if ($jq("#comp_type"+ " option:selected").val() == 'Public' ) {
        //  - do the dealname and project name check here
        //first get the list of ignored words
        // concat deal name and companyname to one so we can check both names
        var dealcompanyNames = dealName + ' ' + compName;
           var arrDeal = dealcompanyNames.match(/\S+/g);
           var arrProject = projName.match(/\S+/g);
           for (var i=0; i < arrProject.length; i++) {
               arrProject[i] = arrProject[i].toLowerCase();
           }
           for (var i=0; i < arrDeal.length; i++) {
               if (arrProject.indexOf(arrDeal[i].toLowerCase(),0) > -1 && ignorewords.indexOf(arrDeal[i].toLowerCase(),0) == -1) {
                       validDealName = false;      
                       openGeneralDialog('Because this is a deal with a public company, please enter a Project Name.  The Project Name cannot be the same as the Deal Name or the Company Name.  As per Compliance, this code name is to be used in place of the target company name in internal and external communications, as appropriate.',validation_string);
                       $jq("#projname").focus();  
                       return false;                        
               }
           }
        /*
        // 3/5/15 - make sure project name also doesn't match companyname
        var arrComp = compName.match(/\S+/g);
        for (var i=0; i < arrComp.length; i++) {
               if (arrProject.indexOf(arrComp[i].toLowerCase(),0) > -1 && ignorewords.indexOf(arrComp[i].toLowerCase(),0) == -1) {
                       validDealName = false;      
                       openGeneralDialog('Because this is a deal with a public company, please enter a Project Name.  The Project Name cannot be the same as the Deal Name or the Company Name.  As per Compliance, this code name is to be used in place of the target company name in internal and external communications, as appropriate.',validation_string);
                       $jq("#projname").focus();  
                       return false;                        
               }
           }
           */
    }
    
    var wp_inv_amt = $jq("#WP_Inv_Amt").val();
    //var wp_inv_amt_mul = $jq("#WP_Inv_Amt_Mul").val();
    var wp_inv_amt_mul = '';
    var categories=$jq("#categories").val();
    var optionstage=$jq("#optionstage").val();
    var optionenergy=$jq("#optionEnergy").val();

    var lifeCycleOptionstage=$jq("#optionstage2").val();
    var dealDesc=$jq("#deal_desc").val();
    var Key_date_Nxt=$jq("#Key_date_Nxt").val();
    var temp_string='';
    var Date_rcvd;
    var validation_string='Validation';
    wp_group_info2 = $jq("#wpgroup2").multiselect("getChecked").map(function(){return this.value;}).get();
    
    
    sector_info2= $jq("#sectorname2").multiselect("getChecked").map(function(){return this.value;}).get();
    geo_info2 = $jq("#geographyname2").multiselect("getChecked").map(function(){return this.value;}).get();
    
    //alert(wp_inv_amt+':'+wp_inv_amt.length);
    //return false;
    
    //alert(optionstage+$jq("#deal_team").val());
    
    if((optionstage!= 'Early-Prospect')&& (optionstage!= 'Early-Initial Diligence/Management Meeting') 
       && (optionstage!= 'Early-Indicative Bid Submitted'))
    {
        openGeneralDialog('Deal Stage cannot be beyond \'Early-Indicative Bid Submitted\' for a new deal.',validation_string);
        $jq("#stagename").multiselect("getButton").focus();     
        return false;
    }  
    
    if((optionstage!= 'Early-Prospect')&& ($jq("#deal_team").val()==''))
    {
        //alert('Deal Team members must be specified for deals in stages other than \‘Early-Prospect\.’');
        openGeneralDialog('Deal Team members must be specified for deals in stages other than \‘Early-Prospect\.’',validation_string);
        $jq("#deal_team").focus();  
        return false;
    }  
    
    /*temp_string= wp_inv_amt.toString();                   

                      if ((temp_string != "") && (temp_string != '') && (temp_string != null)&& (!/^[0-9]+$/.test(temp_string))) 
                      { 
                        alert('Please enter only numeric number for WP Investment Amount:'+temp_string+ ':'+wp_inv_amt);
                        return false;
                      }*/
    
    if((wp_inv_amt != "") && (wp_inv_amt != '') && (wp_inv_amt != null))
    {
        var inv_mult=1;
        if(wp_inv_amt_mul == 'k'){
            inv_mult=1000;//3
        }
        else if(wp_inv_amt_mul == 'm'){
            inv_mult=1000000;//6
        }
            else if(wp_inv_amt_mul == 'b'){
                inv_mult=1000000000;//9
            }
        var final_num = parseFloat(wp_inv_amt.toString().replace(/,/g,""))*inv_mult;
        
        //alert(final_num+':'+wp_inv_amt.toString());
        
        if(final_num > 999999999999999.99)
        {
            openGeneralDialog('Entered WP Invest Amt exceeds maximum allowed amount[999999999999999.999]',validation_string);                         
            $jq("#WP_Inv_Amt").focus();                         
            return false;
        }
    }
    if((dealName == "")|| (dealName == '')|| (dealName == null)) 
    {
        openGeneralDialog('Please specify a name for the deal.',validation_string); 
        $jq("#dealname").focus();                        
        return false;
    }
    

    if((wp_group_info2 == "")|| (wp_group_info2 == '')|| (wp_group_info2 == null)) // #9209
    {
        //alert('Please specify Deal Description.');   
        openGeneralDialog('Please specify a WP Group(s) for the deal.',validation_string); 
        $jq("#wpgroup2").focus();                      
        return false;
    }
    
    if((dealDesc == "")|| (dealDesc == '')|| (dealDesc == null))
    {
        //alert('Please specify a description for the deal.');   
        openGeneralDialog('Please specify a description for the deal.',validation_string); 
        $jq("#deal_desc").focus();                      
        return false;
    }
    
    if(checkdate($jq("#Date_rcvd").val(),'/')== false)
    {
        //alert('Please specify valid date for the deal in the format mm/dd/yyyy.');
        openGeneralDialog('Please specify a valid date received in the format mm/dd/yyyy.',validation_string); 
        $jq("#Date_rcvd").focus();
        return false;
    }            
    Date_rcvd = new Date($jq("#Date_rcvd").val());
    Date_rcvd = Date_rcvd.toUTCString(); 
    //alert("DEBUG Date_rcvd=>" + Date_rcvd);

  var sEE='<table border="0"><tr><td colspan=4 width="600">Examples of Energy and Natural Resources Activities include:</td></tr><tr><td  valign="top">(a)</td><td colspan=2>The exploration, production, provision, development, extraction, processing, transportation, refining, storage, distribution, marketing and/or trading of: </td></tr> <tr><td></td><td valign="top">(i)</td><td>oil, gas, ethanol, coal or other natural resources used to produce energy;</td></tr><tr><td></td><td valign="top">(ii)</td><td>natural resources and commodities other than oil and gas, such as base metals, precious metals, rare earth minerals, timber and gemstones;</td></tr>';
   sEE=sEE+'<tr><td></td><td valign="top">(iii)</td><td>electrical power; and</td></tr><tr><td></td><td valign="top">(iv)</td><td>renewable energy resources, including power generation therefrom (e.g., derived from sunlight, wind, rain, tides, waves, plant and forest products, wastes or geothermal heat).</td></tr><tr><td valign="top">(b)</td><td colspan=2>Companies, businesses, projects or other enterprises that, are expected to derive the majority of their value from the provision of goods or services to entities engaged in one or more of the businesses described in (1)(b)(i) through (1)(b)(iv) ("Energy Services").</td></tr> <tr><td valign="top">(c)</td>';
   sEE=sEE+'<td colspan=2>Other assets determined to be related or complementary to any of the foregoing.</td></tr> </table>';
    
    if((optionenergy == "")|| (optionenergy == '')|| (optionenergy == null) || (optionenergy == 'Select ...')){
        openGeneralDialog("Please specify if this is a potential Energy opportunity.<p/>"+sEE ,"Validation");
        $jq("#optionEnergy").focus();                      
        return false;
    }      
    $jq("#wizard").hide();
    $jq("#progressbar").show();   
    
    saveCompany(false);//save and don't disable dupeblocker
    
                    //alert(dealName);
/*                      WP_DealQuickCreateController.getExistingDeals(
                            dealName,
                            //account_created_id,
                            '',
                            function(data, event)
                            {  
                                if(data == null)
                                {
                                   $jq("#wizard").show();
                                   $jq("#progressbar").hide();                                   
                                   alert('Getting existing deals failed:getExistingDeals:'+ event.message);
                                   return false;
                                }                                                         
                                if(data.length > 0)
                                {
                                   var temp_result;
                                  // alert('Existing deals found for dealname:'+dealName);
                                   $jq("#wizard").show();
                                   $jq("#progressbar").hide();
                                   temp_result = openExistingDealDialog(data,dealName);
                                   return temp_result;
                                }
                                else
                                {                               
                                   //alert('No deals exist with dealname:'+dealName+'.Continue with creating deal');
                                    if((creating_new_company == true)||(comp_type_needed_for_company_selected==true))
                                    {
                                      var acountName =$jq("#acountName").val();
                                      var companytype =$jq("#comp_type"+ " option:selected").val(); 
                                      var cityname =$jq("#cityname").val();
                                      var statename =$jq("#statename").val();
                                      var countryname =$jq("#countryname").val();                       
                                      var compdesc=$jq("#comp_desc").val();

                                      wp_group_info = $jq("#wpgroup").multiselect("getChecked").map(function(){return this.value;}).get();
                                      sector_info= $jq("#sectorname").multiselect("getChecked").map(function(){return this.value;}).get();
                                      geo_info = $jq("#geographyname").multiselect("getChecked").map(function(){return this.value;}).get();

                         
                                         WP_DealQuickCreateController.saveAccount(
                                            acountName,statename ,countryname ,cityname,companytype,sector_info,geo_info,compdesc,
                                            dealName,wp_inv_amt,projName,dealDesc,
                                            categories,Date_rcvd,optionstage,optionenergy,lifeCycleOptionstage,Key_date_Nxt,deal_team_contact_id_list,
                                            wp_group_info2,sector_info2,geo_info2,fund_names_id_list,wp_inv_amt_mul,account_created_id,
                                            false,
                                            function(data, event)
                                            {  
                                                if(data == null)
                                                {
                                                  var matchString = "You are trying to enter a company that may already be in the system.";
                                                  matchString = matchString.toLowerCase();
                                                  $jq("#wizard").show();
                                                  $jq("#progressbar").hide();                       
                                                  if (event.message.toLowerCase().indexOf(matchString) == -1)
                                                 {
                                                    //alert('Both Deal and Company creation failed:SaveAccount:'+ event.message);
                                                    alert('Both Deal and Company creation failed:SaveAccount1');
                                                 }
                                                 else
                                                 {
                                                    //alert("You are trying to enter a company that may already be in the system. "+
                                                         //"If the company is truly new please contact your salesforce administrator.");
                                                    try
                                                    {
                                                        var companyList = parseDupeBlockerDialog(event.message);                                                        
                                                        //var temp_result = openExistingDealDialog(companyList,dealName);  
                                                        var temp_result = openExistingCompanyDialog(companyList, acountName);
                                                    }
                                                    catch(err)
                                                    {
                                                    }    
                                                 }
                                                 return false;                               
                                                }                                                         
                                                if(data.label == 'true')
                                                {
                                                  //alert('Both Deal and Company created for given CompanyName:' +compName +':'+ 'Project Name:'+projName +' with id: '+data.id);

                                                 deal_id = data.id;
                                                 $jq(window.location).attr('href', '/'+deal_id);
                                                 
                                                }
                                                else
                                                {   
                                                 //$jq(this).find('.wait-panel').hide();                              
                                                   $jq("#wizard").show();
                                                   $jq("#progressbar").hide();                                    
                                                 //alert('Both Deal and Company failed:SaveAccount:'+ event.message);
                                                 alert('Both Deal and Company failed:SaveAccount2:');
                                                 return false;
                                                }
                                            }
                                        );                  
                                     }
                                     else
                                     {
                                         WP_DealQuickCreateController.saveDeal(
                                            account_created_id,
                                            dealName,wp_inv_amt,projName,dealDesc,
                                            categories,Date_rcvd,optionstage,optionenergy,lifeCycleOptionstage,Key_date_Nxt,deal_team_contact_id_list,
                                            wp_group_info2,sector_info2,geo_info2,fund_names_id_list,wp_inv_amt_mul,
                                            function(data, event)
                                            {   
                                                if(data == null)
                                                {
                                                   //$jq(this).find('.wait-panel').hide();
                                                   $jq("#wizard").show();
                                                   $jq("#progressbar").hide();                                      
                                                   alert('Only deal creation failed:saveDeal:'+ event.message);
                                                   return false;
                                                }
                                                if(data.label == 'true')
                                                {
                                                  //alert('Only Deal created for given CompanyName:' +compName+ ' Project Name:'+projName +' with id: '+data.id);
                                                 
                                                  deal_id = data.id;
                                                  var devURL = "https://warburgpincus--dev.cs8.my.salesforce.com/";
                                                  var prodURL = "https://warburgpincus--dev.cs8.my.salesforce.com/";
                                                  //$jq(window.location).attr('href', '/'+deal_id);
                                                  window.location.href = devURL + deal_id;                                                 
                                                }
                                                else
                                                {     
                                                 //$jq(this).find('.wait-panel').hide();                            
                                                 $jq("#wizard").show();
                                                 $jq("#progressbar").hide();                                    
                                                 //alert('Only deal failed:saveDeal:'+ event.message);
                                                 alert('Only deal failed:saveDeal:');
                                                 return false;
                                                }
                                             }
                                        );   
                                      }  
                                      clearValuesFromDealPage();
                                      setDealPageUnEdiTable();
                                      clearValuesFromCompPage();
                                      setCompPageUnEdiTable();                                          
                                }
                             }
                         );      */                  
                                         
       
       return true;
}

function attachEventOnDealList()
{
   var dlg=  $jq("#existing_deal_dialog");
   
   dlg.find("#deal_dialog_sel").dblclick(function(e) { 
   var selectedValue = $jq(this).val();//should be deal id of the selected deal
   //alert(selectedValue);
   if((selectedValue!=null) && (selectedValue!='')){
   var temp_arrary = selectedValue.toString().split(",");
   if(temp_arrary.length == 1)
   {
     $jq(window.location).attr('href', '/'+selectedValue);
   }
   else
   {
     $jq("select#deal_dialog_sel").val(''); 
   }  
   }
  });
  
  dlg.find("#deal_dialog_sel").keydown(function (e) {
    var keyCode = e.keyCode || e.which; 
                   
    if(e.shiftKey||e.ctrlKey) {
      e.preventDefault(); 
      //alert(keyCode );
      $jq("select#deal_dialog_sel").val(''); 
    }
    else if(keyCode == 13) {
     var selectedValue = $jq(this).val();//should be deal id of the selected deal
     //alert(selectedValue);   
     
     if((selectedValue!=null) && (selectedValue!=''))
     {
     var temp_arrary = selectedValue.toString().split(",");
     if(temp_arrary.length == 1)
     {
       $jq(window.location).attr('href', '/'+selectedValue);
     }
     else
     {
       $jq("select#deal_dialog_sel").val(''); 
     }    
     }    
    }
  });  
}

function attachEventOnCompanyList()
{
   var dlg=  $jq("#existing_company_dialog");
   
   dlg.find("#company_dialog_sel").dblclick(function(e) { 
   var selectedValue = $jq(this).val();//should be company id of the selected company
   //alert(selectedValue);
   
       if(selectedValue instanceof Array) {
            if(selectedValue[0] != null) {
                selectedValue = selectedValue[0]; 
            }
       }
       
   if((selectedValue!=null) && (selectedValue!='')){
   var temp_arrary = selectedValue.toString().split(",");
   if(temp_arrary.length == 1)
   {
       //$jq(window.location).attr('href', '/'+selectedValue);
       company_selected=true;
       account_created_id= selectedValue;                           
       getExistingAccountInfo(selectedValue, true); 
       $jq("#existing_company_dialog").dialog("close");
   }
   else
   {
     $jq("select#company_dialog_sel").val(''); 
   }  
   }
  });
  
  dlg.find("#company_dialog_sel").keydown(function (e) {
    var keyCode = e.keyCode || e.which; 
                   
    if(e.shiftKey||e.ctrlKey) {
      e.preventDefault(); 
      //alert(keyCode );
      $jq("select#company_dialog_sel").val(''); 
    }
    else if(keyCode == 13) {
     var selectedValue = $jq(this).val();//should be deal id of the selected deal
     //alert(selectedValue);  
        
     if(selectedValue instanceof Array) {
        if(selectedValue[0] != null) {
                selectedValue = selectedValue[0]; 
            }
       }
     
     if((selectedValue!=null) && (selectedValue!=''))
     {
     var temp_arrary = selectedValue.toString().split(",");
     if(temp_arrary.length == 1)
     {
       //$jq(window.location).attr('href', '/'+selectedValue);
       company_selected=true;
       account_created_id= selectedValue;                           
       getExistingAccountInfo(selectedValue, true);
       $jq("#existing_company_dialog").dialog("close");  
     }
     else
     {
       $jq("select#company_dialog_sel").val(''); 
     }    
     }    
    }
  });  
}    
    
function openExistingDealDialog(deal_list, name_of_deal)
{
   var new_deal_button_name='Create New Deal:'+name_of_deal;
   
          $jq("#existing_deal_dialog").dialog({
            autoOpen: true, 
            dialogClass: 'my-dialog',
            modal: true, 
            position: 'center',
            width: 600,
            height: 300,  
            create: function(event, ui) {
               attachEventOnDealList();  
            },
            close: function()
            {
            },         
            open: function() 
            { 
             //console.log("openExistingDealDialog:",deal_list,name_of_deal);
             populateExistingDealList(deal_list);
             $jq('.my-dialog .ui-button-text:contains(Create New Deal)').html('Create New Deal '+'<strong>'+name_of_deal+'</strong>');
                       
            },
            buttons: {
                "Create New Deal": function() {  
                   
                      $jq(this).dialog("close");
                      saveDeal(true);
                    /*                    
                      var compName =$jq("#compname").val();
                      var projName =$jq("#projname").val();
                      var dealName =$jq("#dealname").val();
                     
                      var wp_inv_amt = $jq("#WP_Inv_Amt").val();
                      //var wp_inv_amt_mul = $jq("#WP_Inv_Amt_Mul").val();
                      var wp_inv_amt_mul = '';
                      var categories=$jq("#categories").val();
                      var optionstage=$jq("#optionstage").val();
                      var optionenergy=$jq("#optionEnergy").val();
                      var lifeCycleOptionstage=$jq("#optionstage2").val();
                      var dealDesc=$jq("#deal_desc").val();
                      var Key_date_Nxt=$jq("#Key_date_Nxt").val();
                      var temp_string='';
                      var Date_rcvd;
       
                      wp_group_info2 = $jq("#wpgroup2").multiselect("getChecked").map(function(){return this.value;}).get();
                      sector_info2= $jq("#sectorname2").multiselect("getChecked").map(function(){return this.value;}).get();
                      geo_info2 = $jq("#geographyname2").multiselect("getChecked").map(function(){return this.value;}).get();                     
                         
                      Date_rcvd = new Date($jq("#Date_rcvd").val());
                      Date_rcvd = Date_rcvd.toUTCString(); 

                    $jq("#wizard").hide();
                    $jq("#progressbar").show();    

                                    if((creating_new_company == true)||(comp_type_needed_for_company_selected==true)){
                                      var acountName =$jq("#acountName").val();
                                      var companytype =$jq("#comp_type"+ " option:selected").val(); 
                                      var cityname =$jq("#cityname").val();
                                      var statename =$jq("#statename").val();
                                      var countryname =$jq("#countryname").val();                       
                                      var compdesc=$jq("#comp_desc").val();

                      wp_group_info = $jq("#wpgroup").multiselect("getChecked").map(function(){return this.value;}).get();
                      sector_info= $jq("#sectorname").multiselect("getChecked").map(function(){return this.value;}).get();
                      geo_info = $jq("#geographyname").multiselect("getChecked").map(function(){return this.value;}).get();
                         

                                         WP_DealQuickCreateController.saveAccount(
                                            acountName,statename ,countryname ,cityname,companytype,sector_info,geo_info,compdesc,
                                            dealName,wp_inv_amt,projName,dealDesc,
                                            categories,Date_rcvd,optionstage,optionenergy,lifeCycleOptionstage,Key_date_Nxt,deal_team_contact_id_list,
                                            wp_group_info2,sector_info2,geo_info2,fund_names_id_list,wp_inv_amt_mul,account_created_id,
                                            function(data, event) {  
                                                if(data == null)
                                                {
                                                   //$jq(this).find('.wait-panel').hide();
                                                   $jq("#wizard").show();
                                                   $jq("#progressbar").hide();                                   
                                                   alert('Both Deal and Company creation failed:SaveAccount:'+ event.message);
                                                   return false;
                                                }                                                         
                                                if(data.label == 'true')
                                                {
                                                  //alert('Both Deal and Company created for given CompanyName:' +compName +':'+ 'Project Name:'+projName +' with id: '+data.id);

                                                 deal_id = data.id;
                                                 $jq(window.location).attr('href', '/'+deal_id);
                                                 
                                                }
                                                else
                                                {   
                                                 //$jq(this).find('.wait-panel').hide();                              
                                                   $jq("#wizard").show();
                                                   $jq("#progressbar").hide();                                    
                                                 alert('Both Deal and Company failed:SaveAccount:'+ event.message);
                                                 return false;
                                                }
                                             }
                                        );                  
                                     }
                                     else
                                     {
                                        // sforce.apex.execute("CRMfusionDBR101/DB_WebServices","bypassBlock", {}, {onSuccess: doResave, onFailure: onError} ); }
                                         WP_DealQuickCreateController.saveDeal(
                                            account_created_id,
                                            dealName,wp_inv_amt,projName,dealDesc,
                                            categories,Date_rcvd,optionstage,optionenergy,lifeCycleOptionstage,Key_date_Nxt,deal_team_contact_id_list,
                                            wp_group_info2,sector_info2,geo_info2,fund_names_id_list,wp_inv_amt_mul,
                                            function(data, event) {                           
                                                  
                                                if(data == null)
                                                {
                                                   //$jq(this).find('.wait-panel').hide();
                                                   $jq("#wizard").show();
                                                   $jq("#progressbar").hide();                                      
                                                   if (event.message.indexOf('FIELD_CUSTOM_VALIDATION_EXCEPTION')!=-1 && event.message.indexOf('may already be in the system'))

                                                   
                                                   {
                                                   window.prompt("sometext",event.message);
                                                   //sforce.apex.execute("CRMfusionDBR101/DB_WebServices","bypassBlock", {}, {onSuccess: dbHiOK, onFailure: dbHiError} ); 



                                                   }
                                                   else
                                                   alert('Only deal creation failed:saveDeal:'+ event.message);
                                                   return false;
                                                }
                                                if(data.label == 'true')
                                                {
                                                  //alert('Only Deal created for given CompanyName:' +compName+ ' Project Name:'+projName +' with id: '+data.id);
                                                 
                                                  deal_id = data.id;
                                                  $jq(window.location).attr('href', '/'+deal_id);
                                                 
                                                }
                                                else
                                                {     
                                                 //$jq(this).find('.wait-panel').hide();                            
                                                 $jq("#wizard").show();
                                                 $jq("#progressbar").hide();                                    
                                                 alert('Only deal failed:saveDeal:'+ event.message);
                                                 return false;
                                                }

                                             }
                                        );   
                                      }  
                                      clearValuesFromDealPage();
                                      setDealPageUnEdiTable();
                                      clearValuesFromCompPage();
                                      setCompPageUnEdiTable(); */
                 return true;                                            
                                     
                },
                "Cancel": function() {  
                    $jq(this).dialog("close");
                    return false;
                }
            }              
        });

}
//function dbHiError() { alert('error'); }
//function dbHiOK() { alert('ok'); }

function openExistingCompanyDialog(company_list, name_of_company)
{
   var new_deal_button_name='Create New Company:'+name_of_company;
   
          $jq("#existing_company_dialog").dialog({
            autoOpen: true, 
            dialogClass: 'my-dialog',
            modal: true, 
            position: 'center',
            width: 600,
            height: 300,  
            create: function(event, ui) {
               attachEventOnCompanyList();  
            },
            close: function()
            {
            },         
            open: function() 
            { 
             //console.log("openExistingDealDialog:",comapny_list,name_of_company);
             populateExistingCompanyList(company_list);
             $jq('.my-dialog .ui-button-text:contains(Create New Company)').html('Create New Company '+'<strong>'+name_of_company+'</strong>');
                       
            },
            buttons: {
                "Create New Company": function() {                   
                        $jq(this).dialog("close");
                    
                        saveCompany(true);// second attempt to save disable dupeblocker  
                    /*
                        var compName =$jq("#compname").val();
                        var projName =$jq("#projname").val();
                        var dealName =$jq("#dealname").val();

                        var wp_inv_amt = $jq("#WP_Inv_Amt").val();
                        //var wp_inv_amt_mul = $jq("#WP_Inv_Amt_Mul").val();
                        var wp_inv_amt_mul = '';
                        var categories=$jq("#categories").val();
                        var optionstage=$jq("#optionstage").val();
                        var optionenergy=$jq("#optionEnergy").val();
                        var lifeCycleOptionstage=$jq("#optionstage2").val();
                        var dealDesc=$jq("#deal_desc").val();
                        var Key_date_Nxt=$jq("#Key_date_Nxt").val();
                        var temp_string='';
                        var Date_rcvd;

                        wp_group_info2 = $jq("#wpgroup2").multiselect("getChecked").map(function(){return this.value;}).get();
                        sector_info2= $jq("#sectorname2").multiselect("getChecked").map(function(){return this.value;}).get();
                        geo_info2 = $jq("#geographyname2").multiselect("getChecked").map(function(){return this.value;}).get();                     
                         
                        Date_rcvd = new Date($jq("#Date_rcvd").val());
                        Date_rcvd = Date_rcvd.toUTCString(); 

                        $jq("#wizard").hide();
                        $jq("#progressbar").show();    

                        if((creating_new_company == true)||(comp_type_needed_for_company_selected==true))
                        {
                          var acountName =$jq("#acountName").val();
                          var companytype =$jq("#comp_type"+ " option:selected").val(); 
                          var cityname =$jq("#cityname").val();
                          var statename =$jq("#statename").val();
                          var countryname =$jq("#countryname").val();                       
                          var compdesc=$jq("#comp_desc").val();

                          wp_group_info = $jq("#wpgroup").multiselect("getChecked").map(function(){return this.value;}).get();
                          sector_info= $jq("#sectorname").multiselect("getChecked").map(function(){return this.value;}).get();
                          geo_info = $jq("#geographyname").multiselect("getChecked").map(function(){return this.value;}).get();
             
                            //   sforce.apex.execute("CRMfusionDBR101/DB_WebServices","bypassBlock", {}, {onSuccess: doResave, onFailure: onError} ); }
                                                     
                            WP_DealQuickCreateController.saveAccount(
                                acountName,statename ,countryname ,cityname,companytype,sector_info,geo_info,compdesc,
                                dealName,wp_inv_amt,projName,dealDesc,
                                categories,Date_rcvd,optionstage,optionenergy,lifeCycleOptionstage,Key_date_Nxt,deal_team_contact_id_list,
                                wp_group_info2,sector_info2,geo_info2,fund_names_id_list,wp_inv_amt_mul,account_created_id,
                                true,
                                function(data, event) {  
                                    if(data == null)
                                    {
                                       //$jq(this).find('.wait-panel').hide();
                                       $jq("#wizard").show();
                                       $jq("#progressbar").hide();                                   
                                       alert('Both Deal and Company creation failed:SaveAccount:'+ event.message);
                                       return false;
                                    }                                                         
                                    if(data.label == 'true')
                                    {
                                      //alert('Both Deal and Company created for given CompanyName:' +compName +':'+ 'Project Name:'+projName +' with id: '+data.id);

                                     deal_id = data.id;
                                     $jq(window.location).attr('href', '/'+deal_id);
                                     
                                    }
                                    else
                                    {   
                                     //$jq(this).find('.wait-panel').hide();                              
                                       $jq("#wizard").show();
                                       $jq("#progressbar").hide();                                    
                                     alert('Both Deal and Company failed:SaveAccount:'+ event.message);
                                     return false;
                                    }
                                 }
                            );                  
                         }
                         else
                         {
                            // sforce.apex.execute("CRMfusionDBR101/DB_WebServices","bypassBlock", {}, {onSuccess: doResave, onFailure: onError} ); }
                            /*
                             WP_DealQuickCreateController.saveDeal(
                                account_created_id,
                                dealName,wp_inv_amt,projName,dealDesc,
                                categories,Date_rcvd,optionstage,optionenergy,lifeCycleOptionstage,Key_date_Nxt,deal_team_contact_id_list,
                                wp_group_info2,sector_info2,geo_info2,fund_names_id_list,wp_inv_amt_mul,
                                function(data, event) {                           
                                      
                                    if(data == null)
                                    {
                                       //$jq(this).find('.wait-panel').hide();
                                       $jq("#wizard").show();
                                       $jq("#progressbar").hide();                                      
                                       if (event.message.indexOf('FIELD_CUSTOM_VALIDATION_EXCEPTION')!=-1 && event.message.indexOf('may already be in the system'))

                                       
                                       {
                                       window.prompt("sometext",event.message);
                                       //sforce.apex.execute("CRMfusionDBR101/DB_WebServices","bypassBlock", {}, {onSuccess: dbHiOK, onFailure: dbHiError} ); 



                                       }
                                       else
                                       alert('Only deal creation failed:saveDeal:'+ event.message);
                                       return false;
                                    }
                                    if(data.label == 'true')
                                    {
                                      //alert('Only Deal created for given CompanyName:' +compName+ ' Project Name:'+projName +' with id: '+data.id);
                                     
                                      deal_id = data.id;
                                      $jq(window.location).attr('href', '/'+deal_id);
                                     
                                    }
                                    else
                                    {     
                                     //$jq(this).find('.wait-panel').hide();                            
                                     $jq("#wizard").show();
                                     $jq("#progressbar").hide();                                    
                                     alert('Only deal failed:saveDeal:'+ event.message);
                                     return false;
                                    }

                                 }
                            );   
                          }  
                        
                  clearValuesFromDealPage();
                  setDealPageUnEdiTable();
                  clearValuesFromCompPage();
                  setCompPageUnEdiTable(); */
                 return true;                                            
                                     
                },
                "Cancel": function() {  
                    $jq(this).dialog("close");
                    return false;
                }
            }              
        });

}    
    
    
function populateExistingDealList(dealList)
{
    {
           var temp_string;
           var list_of_deals=dealList;
           $jq("#deal_dialog_sel").empty();
    
           
           //alert('begin'+ list_of_deals.length);
           for(var grp_index=0;grp_index <  list_of_deals.length;++grp_index)
           {
            
             temp_string= '<option value=\"';
             temp_string= temp_string.concat(list_of_deals[grp_index].id);
             temp_string= temp_string.concat('\">');
             temp_string=temp_string.concat(list_of_deals[grp_index].label+' ['+list_of_deals[grp_index].dealGroup+' - '+list_of_deals[grp_index].dealStatus+']');
             temp_string=temp_string.concat('<\/option>');
             //alert('no1:'+temp_string);
    
             $newOptGrp = $jq(temp_string).appendTo('#deal_dialog_sel');        
    
           }   
           //alert('end');
    }
}

function populateExistingCompanyList(companyList)
{
    {
           var temp_string;
           var list_of_companies=companyList;
           $jq("#company_dialog_sel").empty();    
           
           //alert('begin'+ list_of_deals.length);
           for(var grp_index=0;grp_index <  list_of_companies.length;++grp_index)
           {
            
             temp_string= '<option value=\"';
             temp_string= temp_string.concat(list_of_companies[grp_index].id);
             temp_string= temp_string.concat('\">');
               temp_string=temp_string.concat(list_of_companies[grp_index].label);//+' ['+list_of_companies[grp_index].dealGroup+' - '+list_of_companies[grp_index].dealStatus+']');
             temp_string=temp_string.concat('<\/option>');
             //alert('no1:'+temp_string);
    
             $newOptGrp = $jq(temp_string).appendTo('#company_dialog_sel');        
    
           }   
           //alert('end');
    }
}    
    

function clearValuesFromCompPage()
{
                         $jq("#compname").focus(function(){
                           $jq(this).blur(); 
                         });
                         
                       $jq("#comp_desc").val('');
                

                       $jq("#acountName").val('');
                       
                       $jq("#comp_type_sel").val('');      
                       $jq("#comp_type").multiselect({                           
                            noneSelectedText:''
                       });                            
                       $jq("#comp_type").multiselect("refresh");              
                       
                       $jq("#cityname").val('');
                       $jq("#statename").val('');                      
                       $jq("#countryname").val('');     
                       
                                                               
                       $jq("#sectorname").multiselect("uncheckAll");                       
                       $jq("#geographyname").multiselect("uncheckAll");
                       $jq("#wpgroup").multiselect("uncheckAll");    
                             
                       $jq("#wpgroup").multiselect({
                        noneSelectedText:''
                       });

                       $jq("#sectorname").multiselect({
                        noneSelectedText:''
                       });

                       $jq("#geographyname").multiselect({
                        noneSelectedText:''
                       });
                       
                       $jq("#optionsector").empty();
                       $jq("#sectorname").multiselect("refresh");
        
                       
                       sector_info='';
                       geo_info='';
                       wp_group_info='';
                       prev_wp_group_info='';
                       prev_sector_info='';
                       prev_geo_info='';  

                       setDefaultDealTeam();
                       setDefaultFund();
                       entering_deal_page_first_time=true;
                       creating_new_company = false;
                       company_selected = false;
                       comp_type_needed_for_company_selected=false;
                       
                       is_deal_and_proj_name_populated=false;
                       account_created_id='';  
                       
   $jq("#wizard").smartWizard("getNextButton").removeClass("smart-wizard-button-selected");
   $jq("#wizard").smartWizard("getPreviousButton").removeClass("smart-wizard-button-selected");
   $jq("#wizard").smartWizard("getFinishButton").removeClass("smart-wizard-button-selected");                                            
}

function setCompPageUnEdiTable()
{
                         $jq("#compname").focus(function(){
                           $jq(this).blur(); 
                         });
                         
                          $jq("#cityname").attr('readonly', true);
                          $jq("#statename").attr('readonly', true);
                          $jq("#countryname").attr('readonly', true);
                          
                    
                         $jq("#cityname").focus(function(){
                           $jq(this).blur(); 
                         });

                         $jq("#statename").focus(function(){
                           $jq(this).blur(); 
                         });
                         
                         $jq("#countryname").focus(function(){
                           $jq(this).blur(); 
                         });    
                             

                          $jq("#comp_type").multiselect("getButton").removeClass('mark-multiselect-white');
                          $jq("#comp_type").multiselect({
                           beforeopen: function(event,ui){return false;}
                          });
                          
                          $jq("#sectorname").multiselect("getButton").removeClass('mark-multiselect-white');                
                          $jq("#sectorname").multiselect({
                           beforeopen: function(event,ui){return false;},
                           noneSelectedText:''
                          });
                          
                          
                           $jq("#geographyname").multiselect("getButton").removeClass('mark-multiselect-white');  
                           $jq("#geographyname").multiselect({
                           beforeopen: function(event,ui){return false;},
                           noneSelectedText:''
                          });
                           
                          $jq("#wpgroup").multiselect("getButton").removeClass('mark-multiselect-white');    
                          $jq("#wpgroup").multiselect({
                           beforeopen: function(event,ui){return false;},
                           noneSelectedText:''
                          });                      
                          
                           $jq("#comp_desc").attr('readonly', true); 
                           
                           
                         $jq("#comp_desc").focus(function(){
                           $jq(this).blur(); 
                         });                           

}

function setCompPageEdiTable()
{
                         $jq("#compname").focus(function(){
                           $jq(this).blur(); 
                         });
                         
                          $jq("#cityname").attr('readonly', false);
                          $jq("#statename").attr('readonly', false);
                          $jq("#countryname").attr('readonly', false);

                        
                          $jq("#comp_type").multiselect("getButton").addClass('mark-multiselect-white');                           
                          $jq("#comp_type").multiselect({
                           beforeopen: function(event,ui){return true;},
                           noneSelectedText:'Select ...'
                          });
                          
                          $jq("#sectorname").multiselect("getButton").addClass('mark-multiselect-white');   
                          $jq("#sectorname").multiselect({
                           beforeopen: function(event,ui){return true;},
                           noneSelectedText:'Select ...'
                          });
                         
                         
                           $jq("#geographyname").multiselect("getButton").addClass('mark-multiselect-white');   
                           $jq("#geographyname").multiselect({
                           beforeopen: function(event,ui){return true;},
                           noneSelectedText:'Select ...'
                          });    
                         
                          $jq("#wpgroup").multiselect("getButton").addClass('mark-multiselect-white');   
                          $jq("#wpgroup").multiselect({
                           beforeopen: function(event,ui){return true;},
                           noneSelectedText:'Select ...'
                          });     


                          $jq("#comp_desc").attr('readonly', false); 

 
                          $jq("#cityname").unbind("focus");
                          $jq("#statename").unbind("focus");
                          $jq("#countryname").unbind("focus");
                          $jq("#comp_desc").unbind("focus");                     
}

function clearValuesFromDealPage()
{
                         $jq("#compname").focus(function(){
                           $jq(this).blur();
                         });
                         
                      $jq("#deal_desc").val('');
                      $jq("#Key_date_Nxt").val('');
                      
                      /*
                       if (tinyMCE.getInstanceById('deal_desc'))
                      { 
                         tinyMCE.execCommand('mceFocus', false, 'deal_desc');                    
                         tinyMCE.execCommand('mceRemoveControl', false, 'deal_desc');
                      }

                      if (tinyMCE.getInstanceById('Key_date_Nxt'))
                     { 
                       tinyMCE.execCommand('mceFocus', false, 'Key_date_Nxt');                    
                       tinyMCE.execCommand('mceRemoveControl', false, 'Key_date_Nxt');
                      }
                      

                                             

                                          
           main_page.find("#deal_desc").tinymce({
                        width: "88%",
                        height: 30,
                        theme: "simple",   

                        script_url : "{!URLFOR($Resource.kjo_js_libs, 'libs/tinymce/jscripts/tiny_mce/tiny_mce.js')}",
                        inline_styles: false,
                        formats : {
                            underline : {inline : 'u', exact : true}
                        },
                        valid_elements : "strong/b,p,br,em/i,u,li,ul,ol"
                    });   
                 
           main_page.find("#Key_date_Nxt").tinymce({
                        width: "100%",
                        height:30,
                        theme: "simple",   

                        script_url : "{!URLFOR($Resource.kjo_js_libs, 'libs/tinymce/jscripts/tiny_mce/tiny_mce.js')}",
                        inline_styles: false,
                        formats : {
                            underline : {inline : 'u', exact : true}
                        },
                        valid_elements : "strong/b,p,br,em/i,u,li,ul,ol"
                    });                                             
          */


                       $jq("#compname").val('');
                       $jq("#dealname").val('');
                       $jq("#projname").val('');

                      
                       $jq("#sectorname2").multiselect("uncheckAll");                       
                       $jq("#geographyname2").multiselect("uncheckAll");
                       $jq("#wpgroup2").multiselect("uncheckAll");          

                       $jq("#wpgroup2").multiselect({
                        noneSelectedText:''
                       });

                       $jq("#sectorname2").multiselect({
                        noneSelectedText:''
                       });

                       $jq("#geographyname2").multiselect({
                        noneSelectedText:''
                       });
                                     


                       sector_info2='';
                       geo_info2='';
                       wp_group_info2='';
                       prev_wp_group_info2='';
                       prev_sector_info2='';
                       prev_geo_info2='';   


                      $jq("#WP_Inv_Amt").val('');
                     // $jq("#WP_Inv_Amt_Mul").val('Unit');  
                      $jq("#fund").val('');
                      $jq("#categories").val('');

                      $jq("#deal_team").val('');
                      $jq("#Date_rcvd").val('');
                      $jq("#optionstage").val('Early-Prospect');    
                      $jq("#stagename").multiselect("refresh");
                      $jq("#optionEnergy").val('Select ...');  
                      $jq("#EnergyFundname").multiselect("refresh");
                      $jq("#optionstage2").val('Venture');   
                      $jq("#StageLifename").multiselect("refresh");                       
                      
                      is_deal_and_proj_name_populated=false;    
                      
   $jq("#wizard").smartWizard("getNextButton").removeClass("smart-wizard-button-selected");
   $jq("#wizard").smartWizard("getPreviousButton").removeClass("smart-wizard-button-selected");
   $jq("#wizard").smartWizard("getFinishButton").removeClass("smart-wizard-button-selected");                           
} 

function setDealPageUnEdiTable()
{
                       $jq("#compname").attr('readonly', true);
                       $jq("#dealname").attr('readonly', true);
                       $jq("#projname").attr('readonly', true);

                         $jq("#compname").focus(function(){
                           $jq(this).blur(); 
                         });
    
                          $jq("#stagename").multiselect("getButton").removeClass('mark-multiselect-white');   
                          $jq("#stagename").multiselect({
                           beforeopen: function(event,ui){return false;}
                          });
    
                          $jq("#EnergyFundname").multiselect("getButton").removeClass('mark-multiselect-white');   
                          $jq("#EnergyFundname").multiselect({
                           beforeopen: function(event,ui){return false;},
                           noneSelectedText:''
                          });
                          
                          $jq("#StageLifename").multiselect("getButton").removeClass('mark-multiselect-white');   
                          $jq("#StageLifename").multiselect({
                           beforeopen: function(event,ui){return false;}
                          });                         
                          
                          $jq("#sectorname2").multiselect("getButton").removeClass('mark-multiselect-white');                                                                        
                          $jq("#sectorname2").multiselect({
                           beforeopen: function(event,ui){return false;},
                           noneSelectedText:''
                          });
                         
                           $jq("#geographyname2").multiselect("getButton").removeClass('mark-multiselect-white');     
                           $jq("#geographyname2").multiselect({
                           beforeopen: function(event,ui){return false;},
                           noneSelectedText:''
                          });    
                          
                          $jq("#wpgroup2").multiselect("getButton").removeClass('mark-multiselect-white');   
                          $jq("#wpgroup2").multiselect({
                           beforeopen: function(event,ui){return false;},
                           noneSelectedText:''
                          });                      



                      $jq("#WP_Inv_Amt").attr('readonly', true);
                      //$jq("#WP_Inv_Amt_Mul").attr('readonly', true);
                      $jq("#fund").attr('readonly', true);
                      $jq("#categories").attr('readonly', true);

                      $jq("#deal_team").attr('readonly', true);
                      $jq("#Date_rcvd").attr('readonly', true);
                     
                     /* 
                       if (tinyMCE.getInstanceById('deal_desc'))
                       { 
                         tinyMCE.execCommand('mceFocus', false, 'deal_desc');                    
                         tinyMCE.execCommand('mceRemoveControl', false, 'deal_desc');
                       }

                      if (tinyMCE.getInstanceById('Key_date_Nxt'))
                      { 
                       tinyMCE.execCommand('mceFocus', false, 'Key_date_Nxt');                    
                       tinyMCE.execCommand('mceRemoveControl', false, 'Key_date_Nxt');
                      }
                   */
                   
                      $jq("#deal_desc").attr('readonly', true);
                      $jq("#Key_date_Nxt").attr('readonly', true);

} 

function setDealPageEdiTable()
{
                         $jq("#compname").focus(function(){
                           $jq(this).blur(); 
                         });
                         
                       $jq("#dealname").attr('readonly', false);
                       $jq("#projname").attr('readonly', false);

                          $jq("#stagename").multiselect("getButton").addClass('mark-multiselect-white');   
                          $jq("#stagename").multiselect({
                           beforeopen: function(event,ui){return true;}
                          });
    
                          $jq("#EnergyFundname").multiselect("getButton").addClass('mark-multiselect-white');   
                          $jq("#EnergyFundname").multiselect({
                           beforeopen: function(event,ui){return true;},
                          });

                          $jq("#StageLifename").multiselect("getButton").addClass('mark-multiselect-white');   
                          $jq("#StageLifename").multiselect({
                           beforeopen: function(event,ui){return true;}
                          });      
                                              
                          $jq("#sectorname2").multiselect("getButton").addClass('mark-multiselect-white');   
                          $jq("#sectorname2").multiselect({
                           beforeopen: function(event,ui){return true;},
                           noneSelectedText:'Select ...'
                          });
                         
                           $jq("#geographyname2").multiselect("getButton").addClass('mark-multiselect-white');   
                           $jq("#geographyname2").multiselect({
                           beforeopen: function(event,ui){return true;},
                           noneSelectedText:'Select ...'
                          });    
                         
                          $jq("#wpgroup2").multiselect("getButton").addClass('mark-multiselect-white');  
                          $jq("#wpgroup2").multiselect({
                           beforeopen: function(event,ui){return true;},
                           noneSelectedText:'Select ...'
                          });     


                      $jq("#WP_Inv_Amt").attr('readonly', false);
                      //$jq("#WP_Inv_Amt_Mul").attr('readonly', false);
                      $jq("#fund").attr('readonly', false);
                      $jq("#categories").attr('readonly',false);

                      $jq("#deal_team").attr('readonly', false);
                      $jq("#Date_rcvd").attr('readonly', false);

 
                      $jq("#deal_desc").attr('readonly', false);
                      $jq("#Key_date_Nxt").attr('readonly', false);                     
} 

function propagateValuesFromCompPageToDealPage()
{
                      var acountName =$jq("#acountName").val();    
                      
                         $jq("#compname").focus(function(){
                           $jq(this).blur(); 
                         });
                      
                      if(is_deal_and_proj_name_populated == false)
                      {   
                        $jq("#compname").val( acountName);
                        //$jq("#projname").val( acountName );  
                        $jq("#projname").val( '' );  
                        $jq("#dealname").val( acountName );  
                        is_deal_and_proj_name_populated = false;
                      }
                      
                     var now = new Date();
                     var myDate=(now.getMonth()+1).padLeft() + '\/' + now.getDate().padLeft() + '\/' + now.getFullYear();
                   
                     $jq("#Date_rcvd").val(myDate);

                     $jq("#deal_team").val(deal_team_initials_string);
                     $jq("#fund").val(fund_names_string);

                 if(entering_deal_page_first_time == true)
                 {
                     setWPGroupOfCurrentUser();
                 }     
                 
                         $jq("#compname").focus(function(){
                           $jq(this).blur(); 
                         });                 
} 

Number.prototype.padLeft = function(base,chr){
   var  len = (String(base || 10).length - String(this).length)+1;
   return len > 0? new Array(len).join(chr || '0')+this : this;
}  

function checkdate(txtDate, separator) {
    var aoDate,           // needed for creating array and object
        ms,               // date in milliseconds
        month, day, year; // (integer) month, day and year
    // if separator is not defined then set '/'
    if (separator === undefined) {
        separator = '/';
    }
    // split input date to month, day and year
    aoDate = txtDate.split(separator);
    // array length should be exactly 3 (no more no less)
    if (aoDate.length !== 3) {
        return false;
    }
    // define month, day and year from array (expected format is m/d/yyyy)
    // subtraction will cast variables to integer implicitly
    month = aoDate[0] - 1; // because months in JS start from 0
    day = aoDate[1] - 0;
    year = aoDate[2] - 0;
    // test year range
    if (year < 1000 || year > 3000) {
        return false;
    }
    // convert input date to milliseconds
    ms = (new Date(year, month, day)).getTime();
    // initialize Date() object from milliseconds (reuse aoDate variable)
    aoDate = new Date();
    aoDate.setTime(ms);
    // compare input date and parts from Date() object
    // if difference exists then input date is not valid
    if (aoDate.getFullYear() !== year ||
        aoDate.getMonth() !== month ||
        aoDate.getDate() !== day) {
        return false;
    }
    // date is OK, return true
    return true;
}

function getWPGroupOfCurrentUser()
{            
        WP_DealQuickCreateController.getWPGroupInfo(
              function(data, event) {
              
              if(data==null)
              {
                alert('getWPGroupInfo:'+event.message);
                return;                
              }              
              user_default_wp_group=data;
        });                      
} 

function setWPGroupOfCurrentUser()
{         
          $jq("#wpgroup2").multiselect("refresh");         
          $jq("#wpgroup2").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert(data,+':'+user_default_wp_group.length+':'+ui.value+':'+ui.value.length);
             if((ui.value == user_default_wp_group) && (ui.checked == false)){
             this.click();
             //alert('setWPGroupOfCurrentUser'+ui.value);
             }
          }); 
           $jq("#wpgroup2").multiselect("refresh");              
                 if(entering_deal_page_first_time == true)
                 {                   
                     populateFilteredSectorList('sectorname2'); 
                     entering_deal_page_first_time=false;
                 }         
} 

function setWPGroupOfCurrentUserOnCompPage()
{         
          $jq("#wpgroup").multiselect("refresh");         
          $jq("#wpgroup").multiselect("widget").find(":checkbox").each(function(event,ui) {
             //alert(data,+':'+user_default_wp_group.length+':'+ui.value+':'+ui.value.length);
             if((ui.value == user_default_wp_group) && (ui.checked == false)){
             this.click();
             //alert('setWPGroupOfCurrentUser'+ui.value);
             }
          });
         populateFilteredSectorList('sectorname');
}

function reset_comp_selections()
{
creating_new_company=false;
company_selected=false;
}

function updateDealStaffing(dlg) {

            deal_team_info_list.length=0;
            deal_team_initials_string='';
            deal_team_contact_id_list.length=0;
            $jq("#dealteam li[data-contact-id]").each(function(index, element){                
                deal_team_contact_id_list.push($jq(this).attr('data-contact-id'));
                deal_team_info_list[deal_team_info_list.length]= { label : $jq(this).text(), value :$jq(this).text(), id : $jq(this).attr('data-user-id'), 
    contact_id : $jq(this).attr('data-contact-id'), user_initial:$jq(this).attr('data-user-initial')};
                 
                 /*
                 _.each(deal_team_info_list, function(elem, index){ 
                  alert(deal_team_info_list.length+':'+elem.label+':'+elem.id+':'+elem.id+':'+elem.contact_id+':'+elem.user_initial);
                 
                 });*/             
                 
                // alert('Now length is:'+deal_team_info_list.length);

            });

            /*           
            $jq("#dealteam li[data-user-initial]").each(function(index, element){
                
                if(index==0)
                {
                  deal_team_initials_string= $jq(this).attr('data-user-initial');
                  //alert(index+deal_team_initials_string);
                }
                else
                {
                  deal_team_initials_string= deal_team_initials_string.concat('; ');
                  deal_team_initials_string= deal_team_initials_string.concat($jq(this).attr('data-user-initial'));
                  //alert(index+deal_team_initials_string);
                }
                
            });*/

           WP_DealQuickCreateController.sortDealTeamList(
              deal_team_contact_id_list,
              function(data, event) {                              
               if( (data== null)|| (event.status == false))
               {
                 alert('sortDealTeamList:Sorting Deal Team list failed:'+event.message);
               }
               else
               {
                 deal_team_initials_string = data;
                 //alert(deal_team_initials_string);
                 $jq("#deal_team").val(deal_team_initials_string); 
               }
             });                                                     
}
        
function updateFunds(dlg) {

            fund_info_list.length=0;
            fund_names_string='';
            fund_names_id_list.length=0;
            $jq("#fundlist li[data-fund-id]").each(function(index, element){                
                fund_names_id_list.push($jq(this).attr('data-fund-id'));
                fund_info_list[fund_info_list.length]= { label : $jq(this).text(), value :$jq(this).text(), id : $jq(this).attr('data-fund-id'), 
     fund_name:$jq(this).attr('data-fund-name')};
                 
                 
                 _.each(fund_info_list, function(elem, index){ 
                  //alert(fund_info_list.length+':'+elem.label+':'+elem.id+':'+elem.id+':'+':'+elem.fund_name);
                 
                 });             
                 
                //alert('Now length is:'+fund_info_list.length);

            });

                       
            $jq("#fundlist li[data-fund-name]").each(function(index, element){
                
                if(index==0)
                {
                  fund_names_string= $jq(this).attr('data-fund-name');
                  //alert(index+fund_names_string);
                }
                else
                {
                  fund_names_string= fund_names_string.concat('; ');
                  fund_names_string= fund_names_string.concat($jq(this).attr('data-fund-name'));
                  //alert(index+fund_names_string);
                }
                
            });

            //alert(fund_names_string);
            $jq("#fund").val(fund_names_string);              
}

function showStaffingDialog(event){
 
            var deal_name = $jq("#dealname").val();  

            event.preventDefault();
 
            var dlg = $jq("#staffingdialog");           



            dlg.dialog("open");

            //dlg.dialog("option" , "title" , 'Enter Deal Team for deal-\"'+deal_name+'\"');
            dlg.dialog("option" , "title" , 'Enter Deal Team');
            dlg.dialog('option', 'position', 'center');
        
            var dlg_template = Handlebars.compile($jq("#staffing-dialog-template").html());          

                    
                    
                        $jq('#dealteam').empty();
                        dlg.find('#staffing-dialog-content').html(dlg_template({dealname : deal_name, staff : ''}));
                        $jq('#dealteam').sortable();

                   
                 _.each(deal_team_info_list, function(elem, index){ 
                  //alert(deal_team_info_list.length+':'+elem.label+':'+elem.id+':'+elem.id+':'+elem.contact_id+':'+elem.user_initial);
                                    var entry = $jq("#dealteam li[data-contact-id='" + elem.contact_id + "']");
                                    if ( entry.length == 0 ) {
                                        var divelem = $jq('<div>');
                                        divelem.append(elem.label);
                                        divelem.append("<a href='#' class='delete-user'><span class='ui-icon ui-icon-circle-close'></span></a>");
                                        var listelem = $jq('<li>');
                                        listelem.attr('data-user-id', elem.id);
                                        listelem.attr('data-contact-id', elem.contact_id);
                                        listelem.attr('data-user-initial', elem.user_initial);
                                        listelem.append(divelem);                
                                        $jq('#dealteam').append(listelem);
                                    } else {
                                        entry.children('div').stop().fadeOut(300).fadeIn(300);
                                    }                 
                 }); 

                       dlg.find('#staff-searcher').focus();
                       $jq("#staffingdialog input:text, #staffingdialog textarea").eq(0).focus();
                       
                        $jq( "#staff-searcher" ).autocomplete({
                            source: function(request, response) {
                             WP_DealQuickCreateController.getProfessionalsList(
                              request.term,
                              function(data, event) {                              
                              response($jq.map(data, function(item) {                              
                              return { label : item.label, value : item.label, id : item.user_id, 
                                 contact_id : item.contact_id, user_initial:item.initials} }));
                              });
                            },
                            minLength: 2,
                            select: function( event, ui ) {
                                event.preventDefault();
                                if ( ui.item ) {
                                    var entry = $jq("#dealteam li[data-contact-id='" + ui.item.contact_id + "']");
                                    if ( entry.length == 0 ) {
                                        var divelem = $jq('<div>');
                                        divelem.append(ui.item.label);
                                        divelem.append("<a href='#' class='delete-user'><span class='ui-icon ui-icon-circle-close'></span></a>");
                                        var listelem = $jq('<li>');
                                        listelem.attr('data-user-id', ui.item.id);
                                        listelem.attr('data-contact-id', ui.item.contact_id);
                                        listelem.attr('data-user-initial', ui.item.user_initial);
                                        listelem.append(divelem);                
                                        $jq('#dealteam').append(listelem);
                                    } else {
                                        entry.children('div').stop().fadeOut(300).fadeIn(300);
                                    }
                                    $jq( "#staff-searcher" ).val('');
                                } else {
                                    alert('Nothing Selected.');
                                }
                            }
                        });
                    
                        $jq("#dealteam").on('click', 'a.delete-user', function(event) {
                            event.preventDefault();
                            $jq(this).parents('li').remove();
                        });                       

            return false;
}  

function showFundDialog(event){
 
            var deal_name = $jq("#dealname").val();  

            event.preventDefault();
 
            var dlg = $jq("#funddialog");
            
            dlg.dialog("open");
            //dlg.dialog("option" , "title" , 'Enter Fund(s) for deal-\"'+deal_name+'\"');
            dlg.dialog("option" , "title" , 'Enter Fund(s)');
            dlg.dialog('option', 'position', 'center');
        
            var dlg_template = Handlebars.compile($jq("#fund-dialog-template").html());          

                    
                    
                        $jq('#fundlist').empty();
                        dlg.find('#fund-dialog-content').html(dlg_template({dealname : deal_name, fund : ''}));
                        $jq('#fundlist').sortable();

                   
                 _.each(fund_info_list, function(elem, index){ 
                 // alert(fund_info_list.length+':'+elem.label+':'+elem.id+':'+elem.fund_name);
                                    var entry = $jq("#fundlist li[data-fund-id='" + elem.fund_id + "']");
                                    if ( entry.length == 0 ) {
                                        var divelem = $jq('<div>');
                                        divelem.append(elem.label);
                                        divelem.append("<a href='#' class='delete-user'><span class='ui-icon ui-icon-circle-close'></span></a>");
                                        var listelem = $jq('<li>');
                                        listelem.attr('data-fund-id', elem.id);                                        
                                        listelem.attr('data-fund-name', elem.fund_name);
                                        listelem.append(divelem);                
                                        $jq('#fundlist').append(listelem);
                                    } else {
                                        entry.children('div').stop().fadeOut(300).fadeIn(300);
                                    }                 
                 }); 

                        
                        dlg.find('#fund-searcher').focus();
                        $jq("#funddialog input:text, #funddialog textarea").eq(0).focus();
                        $jq( "#fund-searcher" ).autocomplete({
                            source: function(request, response) {
                             WP_DealQuickCreateController.getFundsList(
                              request.term,
                              function(data, event) {                              
                              response($jq.map(data, function(item) {                              
                              return { label : item.label, value : item.label, id : item.fund_id, 
                                 fund_name:item.fund_name} }));
                              });
                            },
                            minLength: 1,
                            select: function( event, ui ) {
                                event.preventDefault();
                                if ( ui.item ) {
                                    var entry = $jq("#fundlist li[data-fund-id='" + ui.item.id + "']");
                                    //alert(entry.length+':'+ui.item.id);
                                    if ( entry.length == 0 ) {
                                        var divelem = $jq('<div>');
                                        divelem.append(ui.item.label);
                                        divelem.append("<a href='#' class='delete-user'><span class='ui-icon ui-icon-circle-close'></span></a>");
                                        var listelem = $jq('<li>');
                                        listelem.attr('data-fund-id', ui.item.id);
                                        listelem.attr('data-fund-name', ui.item.fund_name);
                                        listelem.append(divelem);                
                                        $jq('#fundlist').append(listelem);
                                    } else {
                                        entry.children('div').stop().fadeOut(300).fadeIn(300);
                                    }
                                    $jq( "#fund-searcher" ).val('');
                                } else {
                                    alert('Nothing Selected.');
                                }
                            }
                        });
                    
                        $jq("#fundlist").on('click', 'a.delete-user', function(event) {
                            event.preventDefault();
                            $jq(this).parents('li').remove();
                        });                       

            return false;
}        
        
function populateWpGroupListOnDealPage(){
  
       var wp_group_temp=wp_group_info;
       
       //alert(wp_group_temp);
       $jq("#wpgroup2").multiselect("uncheckAll");    
       
       $jq("#wpgroup2").multiselect("refresh");
       
       if((wp_group_temp != null) && (wp_group_temp!=''))
       {
       var wp_group_list_values=wp_group_temp.toString().split(',');
       for(var elem_index=0;elem_index < wp_group_list_values.length;++elem_index)
       {  
       
        if(wp_group_list_values[elem_index]== 'FIG')
            wp_group_list_values[elem_index] = 'Financial Services';         
            $jq("#wpgroup2").multiselect("widget").find(":checkbox").each(function(event,ui) {
             if((ui.value == wp_group_list_values[elem_index]) && (ui.checked == false)){
             this.click();
             //alert('populateWpGroupListOnDealPage'+ui.value);
             }
          }); 
       
       }
       }         
       $jq("#wpgroup2").multiselect("refresh");     
}        
   
function preventRemovingText() /* Prevent Esc deleting imput and if input is readonly, stop backspace acting as 'Back' */
{
  var inps = document.getElementsByTagName( 'input' ), /* Place BELOW all <input>s */
      field;
  
  function ih( obj, evt, func )
  { 
    obj.attachEvent ? obj.attachEvent( 'on' + evt, func ) : obj.addEventListener( evt, func, false );
  }      
      
  function k( e )
  {  
    var evt = ( e || window.event ),
        elem = evt.srcElement || evt.target,
        ro = elem.getAttribute('readonly');
    
    if( evt.keyCode == 27 || ( ro && evt.keyCode == 8 ) )
      evt.preventDefault ? evt.preventDefault() : evt.returnValue = false;  
  };
      
  for( var i = 0; ( field = inps[ i ] ); i++ ) 
    ih( field, 'keydown', k );          
}         

function validateWpInvAmt()
{
    /**
     * Substitutions for keydown keycodes.
     * Allows conversion from e.which to ascii characters.
     */
    var _keydown = {
        codes : {
            188 : 44,
            109 : 45,
            190 : 46,
            191 : 47,
            192 : 96,
            220 : 92,
            222 : 39,
            221 : 93,
            219 : 91,
            173 : 45,
            187 : 61, //IE Key codes
            186 : 59, //IE Key codes
            189 : 45, //IE Key codes
            110 : 46  //IE Key codes
        },
        shifts : {
            96 : "~",
            49 : "!",
            50 : "@",
            51 : "#",
            52 : "$",
            53 : "%",
            54 : "^",
            55 : "&",
            56 : "*",
            57 : "(",
            48 : ")",
            45 : "_",
            61 : "+",
            91 : "{",
            93 : "}",
            92 : "|",
            59 : ":",
            39 : "\"",
            44 : "<",
            46 : ">",
            47 : "?"
        }
    };
    
    $jq("#WP_Inv_Amt").keydown(function(e) {
    
     var code   = (e.keyCode ? e.keyCode : e.which);
     var chara  = '';
     
                            if (_keydown.codes.hasOwnProperty(code)) {
                                code = _keydown.codes[code];
                            }
                            if (!e.shiftKey && (code >= 65 && code <= 90)){
                                code += 32;
                            } else if (!e.shiftKey && (code >= 69 && code <= 105)){
                                code -= 48;
                            } else if (e.shiftKey && _keydown.shifts.hasOwnProperty(code)){
                                //get shifted keyCode value
                                chara = _keydown.shifts[code];
                            }
                            
                            if( chara == '' ) chara = String.fromCharCode(code);
                        
                        //Stop executing if the user types key `
                        if( (e.keyCode ? e.keyCode : e.which) == 192)
                        {
                          e.preventDefault();
                          return false;
                        }
                        
                        {
                            // We need the original keycode now...
                            var key = (e.keyCode ? e.keyCode : e.which);
                            if( // Allow control keys to go through... (delete, etc)
                                key == 46 || key == 8 || key == 9 || key == 27 || key == 13 || 
                                // Allow: Ctrl+A, Ctrl+R
                                ( (key == 65 || key == 82 ) && ( e.ctrlKey || e.metaKey ) === true ) || 
                                // Allow: Ctrl+V, Ctrl+C
                                ( (key == 86 || key == 67 ) && ( e.ctrlKey || e.metaKey ) === true ) || 
                                // Allow: home, end, left, right
                                ( (key >= 35 && key <= 39) ) 
                            ){ 
                                console.log('Going from here');                               
                                return;
                            }
                        }                           
                        
                        // Stop executing if the user didn't type ah,H kK, mM, bB, tT
                        if( !chara.match(/[hHkKmMbBtT]/))
                        {
                          e.preventDefault();
                          return false;
                        }                   
                        // Stop executing if  the user typed more than 1 character
                        if( $jq(this).val().length > 0)
                        {
                           //console.log('Code char value', code, chara, $jq("#WP_Inv_Amt").val());

                            // But prevent all other keys.
                            e.preventDefault();
                            return false;
                        }    

    });
}

    
function parseDupeBlockerIds(message)
{
     var items = []; 
     var htmlParsed =  $jq.parseHTML( message );
     $jq(htmlParsed).find("li").each(function( i, el ) {
        var href = el.firstChild.href;
        var urlParts = href.split("/");
        var id = urlParts.pop();
        
         //only works in chrome
         //var text = el.firstChild.text;  
        var text = el.firstChild.innerText;          
        var item = { label: text, name: text, id: id }       
        var contains = false;
  
         for(var i=0; i<items.length; ++i) {
             if(items[i].id == item.id) {
                 contains = true;
             }
         }        
        
         if(!contains) {
            items.push(item.id);
         }
     });
    
    return items;
}    
    
function parseDupeBlockerDialog(message)
{
     var items = []; 
     var htmlParsed =  $jq.parseHTML( message );
     $jq(htmlParsed).find("li").each(function( i, el ) {
        var href = el.firstChild.href;
        var urlParts = href.split("/");
        var id = urlParts.pop();
         //only works in chrome
         //var text = el.firstChild.text;  
        var text = el.firstChild.innerText;  
        var item = { label: text, name: text, id: id }       
        var contains = false;

         for(var i=0; i<items.length; ++i) {
             if(items[i].id == item.id) {
                 contains = true;
             }
         }        
        
         if(!contains) {
            items.push(item);
         }         

    });
    items.sort(orderByNameAscending);
    return items;
}    
    
function saveCompany(disableDupeBlocker) 
{
    var compName =$jq("#compname").val();
    var projName =$jq("#projname").val();
    var dealName =$jq("#dealname").val();

    var wp_inv_amt = $jq("#WP_Inv_Amt").val();
    //var wp_inv_amt_mul = $jq("#WP_Inv_Amt_Mul").val();
    var wp_inv_amt_mul = '';
    var categories=$jq("#categories").val();
    var optionstage=$jq("#optionstage").val();
    var optionenergy=$jq("#optionEnergy").val();
    var lifeCycleOptionstage=$jq("#optionstage2").val();
    var dealDesc=$jq("#deal_desc").val();
    var Key_date_Nxt=$jq("#Key_date_Nxt").val();
    var temp_string='';
    var Date_rcvd;

    wp_group_info2 = $jq("#wpgroup2").multiselect("getChecked").map(function(){return this.value;}).get();
    sector_info2= $jq("#sectorname2").multiselect("getChecked").map(function(){return this.value;}).get();
    geo_info2 = $jq("#geographyname2").multiselect("getChecked").map(function(){return this.value;}).get();                     
     
    Date_rcvd = new Date($jq("#Date_rcvd").val());
    Date_rcvd = Date_rcvd.toUTCString(); 

    $jq("#wizard").hide();
    $jq("#progressbar").show();    
    

    if((creating_new_company == true)||(comp_type_needed_for_company_selected==true))
    {
      var acountName =$jq("#acountName").val();
      var companytype =$jq("#comp_type"+ " option:selected").val(); 
      var cityname =$jq("#cityname").val();
      var statename =$jq("#statename").val();
      var countryname =$jq("#countryname").val();                       
      var compdesc=$jq("#comp_desc").val();
      
      wp_group_info = $jq("#wpgroup").multiselect("getChecked").map(function(){return this.value;}).get();
      sector_info= $jq("#sectorname").multiselect("getChecked").map(function(){return this.value;}).get();
      geo_info = $jq("#geographyname").multiselect("getChecked").map(function(){return this.value;}).get();
                                 
        WP_DealQuickCreateController.saveAccount(
            acountName,statename ,countryname ,cityname,companytype,sector_info,geo_info,compdesc,
            dealName,wp_inv_amt,projName,dealDesc,
            categories,Date_rcvd,optionstage,optionenergy,lifeCycleOptionstage,Key_date_Nxt,deal_team_contact_id_list,
            wp_group_info2,sector_info2,geo_info2,fund_names_id_list,wp_inv_amt_mul,account_created_id,
            disableDupeBlocker,
            function(data, event)
            {  
                //alert("DEBUG MSG Data=" + data + "\n event.message" + event.message );
                if(data == null)
                {
                  var isDupeBlockerError =  event.message.toLowerCase().indexOf("dupeblocker") > 0 && event.message.toLowerCase().indexOf("error") > 0; 
                  
                  $jq("#wizard").show();
                  $jq("#progressbar").hide();  
                    
                 if (!isDupeBlockerError)
                 {
                    alert('Both Deal and Company creation failed:SaveAccount:'+ event.message);
                     //alert('Both Deal and Company creation failed:SaveAccount1');
                 }
                 else
                 {
                    //alert("You are trying to enter a company that may already be in the system. "+
                         //"If the company is truly new please contact your salesforce administrator.");
                    try
                    {
                        var companyList = parseDupeBlockerDialog(event.message);
                        var temp_result = openExistingCompanyDialog(companyList, acountName);
                    }
                    catch(err)
                    {
                    }    
                 }
                 return false;                               
                }                                                         
                if(data.label == 'true' || ( data.label = 'false' && data.id != null) )
                {
                  //alert('Both Deal and Company created for given CompanyName:' +compName +':'+ 'Project Name:'+projName +' with id: '+data.id);

                    // deal_id = data.id;
                    //$jq(window.location).attr('href', '/'+deal_id);
                 
                    //Company save succeeded so now try to save the deal
                    account_created_id = data.id;
                    saveDeal(false);                 
                }    
                else
                {   
                 //$jq(this).find('.wait-panel').hide();                              
                   $jq("#wizard").show();
                   $jq("#progressbar").hide();                                    
                 //alert('Both Deal and Company failed:SaveAccount:'+ event.message);
                 alert('Both Deal and Company failed:SaveAccount2:');
                 return false;
                }
            }
        );                  
     }
    else
    {
        saveDeal(false);
    }
}       

function saveDeal(disableDupeBlocker)
{
    var compName =$jq("#compname").val();
    var projName =$jq("#projname").val();
    var dealName =$jq("#dealname").val();
    
    var wp_inv_amt = $jq("#WP_Inv_Amt").val();
    //var wp_inv_amt_mul = $jq("#WP_Inv_Amt_Mul").val();
    var wp_inv_amt_mul = '';
    var categories=$jq("#categories").val();
    var optionstage=$jq("#optionstage").val();
    var optionenergy=$jq("#optionEnergy").val();
    var lifeCycleOptionstage=$jq("#optionstage2").val();
    var dealDesc=$jq("#deal_desc").val();
    var Key_date_Nxt=$jq("#Key_date_Nxt").val();
    var temp_string='';
    var Date_rcvd;
    
    wp_group_info2 = $jq("#wpgroup2").multiselect("getChecked").map(function(){return this.value;}).get();
    sector_info2= $jq("#sectorname2").multiselect("getChecked").map(function(){return this.value;}).get();
    geo_info2 = $jq("#geographyname2").multiselect("getChecked").map(function(){return this.value;}).get();                     
    
    Date_rcvd = new Date($jq("#Date_rcvd").val());
    Date_rcvd = Date_rcvd.toUTCString(); 
    
    $jq("#wizard").hide();
    $jq("#progressbar").show();    
    
    WP_DealQuickCreateController.saveDeal(
        account_created_id,
        dealName,wp_inv_amt,projName,dealDesc,
        categories,Date_rcvd,optionstage,optionenergy,lifeCycleOptionstage,Key_date_Nxt,deal_team_contact_id_list,
        wp_group_info2,sector_info2,geo_info2,fund_names_id_list,wp_inv_amt_mul,
        disableDupeBlocker,
        function(data, event)
        {   
            //alert("Saving to the deal obj-> data="+data +"\n event.message="+event.message);
            
            if(data == null)
            {
                //$jq(this).find('.wait-panel').hide();
                $jq("#wizard").show();
                $jq("#progressbar").hide();                                      
                // alert('Only deal creation failed:saveDeal:'+ event.message);
                
                 var isDupeBlockerError =  event.message.toLowerCase().indexOf("dupeblocker") > 0 && event.message.toLowerCase().indexOf("error") > 0; 
                       
                 if (!isDupeBlockerError)
                 {
                    alert('Both Deal and Company creation failed:SaveAccount:'+ event.message);
                     //alert('Both Deal and Company creation failed:SaveAccount1');
                 }
                 else
                 {
                    //alert("You are trying to enter a company that may already be in the system. "+
                         //"If the company is truly new please contact your salesforce administrator.");
                    try
                    {
                        //var dealList = parseDupeBlockerDialog(event.message);
                        //var temp_result = openExistingDealDialog(dealList, dealName);  
                        var dealIdList = parseDupeBlockerIds(event.message);
                        
                        WP_DealQuickCreateController.getExistingDealList(                            
                            dealIdList,
                            function(data, event)
                            {   
                                if(data == null)
                                {
                                    alert('Unable to find duplicate deals from Dupeblocker list: ' + event.message);
                                }
                                else
                                {
                                    var temp_result = openExistingDealDialog(data, dealName);    
                                }
                            }
                        );                      
                        
                        
                    }
                    catch(err)
                    {
                    }    
                 }
                 return false;
            }
            if(data.label == 'true')
            {
                //alert('Only Deal created for given CompanyName:' +compName+ ' Project Name:'+projName +' with id: '+data.id);                
                deal_id = data.id;
                $jq(window.location).attr('href', '/'+deal_id);                          
            }
            else
            {     
                //$jq(this).find('.wait-panel').hide();                            
                $jq("#wizard").show();
                $jq("#progressbar").hide();                                    
                alert('Only deal failed:saveDeal:'+ event.message);
                //alert('Only deal failed:saveDeal:');
                return false;
            }
        }
    );
}    
  
function orderByNameAscending(a, b) {
    if (a.name.toLowerCase() == b.name.toLowerCase()) {
        return 0;
    } else if (a.name.toLowerCase() > b.name.toLowerCase()) {
        return 1;
    }
    return -1;
}    
    
</script>
</apex:page>