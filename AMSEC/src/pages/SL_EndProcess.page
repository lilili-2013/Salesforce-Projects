<apex:page id="thePage" showHeader="false" sidebar="false" standardController="Deal__c" extensions="SL_EndProcessController">
    
    <apex:includescript value="{!URLFOR($Resource.SL_EndProcess, 'jquery/dist/jquery.js')}"></apex:includescript>
    <apex:includescript value="{!URLFOR($Resource.SL_EndProcess, 'bootstrap/dist/js/sl-bootstrap.js')}"></apex:includescript>
    <apex:stylesheet value="{!URLFOR($Resource.bootstrap, 'dist/css/sl-bootstrap.min.css')}" />
    <!-- <apex:stylesheet value="{!URLFOR($Resource.SL_EndProcess, 'bootstrap/dist/css/sl-bootstrap.min.css')}"></apex:stylesheet> -->

    <div id="sl"> 
        <div id="sl-body">

            <apex:form id="theForm">

                <apex:actionFunction name="closedProcessAF" action="{!saveClosedProcess}" status="loading" oncomplete="closeWindow();"/>
                <apex:actionFunction name="deadProcessAF" action="{!saveDeadProcess}" status="loading" oncomplete="closeWindow();"/>

                <apex:pageMessages />

            
                <apex:outputPanel id="out1" rendered="{!IF(AND(!isError, OR(Deal__c.Deal_Status__c == 'Dead', Deal__c.Deal_Status__c == 'Entered as Dead', Deal__c.Deal_Status__c == 'Closed')), true, false)}">
                    <div class="alert alert-info" style="position: fixed;top: 50%;left: 50%;margin-top: -50px;margin-left: -80px;" role="alert"><b>Inv. Opp. is already closed</b></div>
                </apex:outputPanel>


                <apex:outputPanel id="out2" rendered="{!IF(AND(!isError, OR(Deal__c.Deal_Status__c == 'Dead', Deal__c.Deal_Status__c == 'Entered as Dead', Deal__c.Deal_Status__c == 'Closed')), false, true)}">

                    <div id="divId">
                        <div id="selectProcess" class="panel panel-info">
                            <div class="panel-heading">
                                <b><h4>End Process</h4></b>
                            </div>
                            <div class="panel-body">
                                <table width="100%" cellpadding="5px" cellspacing="5px" style=" border-collapse: separate; border-spacing: 0px 12px; padding-left:5%">
                                    <tr>
                                        <td style="width:40%!important;text-align: right;padding-right: 12px;">Select Status</td>

                                        <td style="width:60%!important;">
                                            <apex:selectList id="statusId" value="{!strStatus}" multiselect="false" size="1" onchange="renderTable(this.value);">
                                                <apex:selectOptions value="{!items}"/>
                                            </apex:selectList>
                                        </td>
                                    </tr> 
                                </table> 
                            </div>
                        </div>


                        <div id="closedProcess" class="panel panel-info" style="display:none;">
                            <div class="panel-heading">
                                <h7>{!Deal__c.Salesforce_Company__r.Name}</h7><br/>
                                <b><h4>{!Deal__c.Name}</h4></b>
                            </div>
                            <div class="panel-body">
                                <table width="100%" >
                                    <apex:repeat value="{!$ObjectType.Deal__c.FieldSets.SL_ClosedDealProcess}" var="field">
                                    <tr >
                                        <td style="width:40%!important;text-align: right;padding-right: 12px;padding-top: 12px;">
                                            {!field.label}
                                        </td>
                                        <td style="width:60%!important;padding-top: 12px;">    

                                            <apex:inputField value="{!objClosedDeal[field]}" rendered="{!field != 'Deal_Status__c'}"/>      

                                            <apex:selectList id="selectStatus" value="{!objClosedDeal[field]}" size="1" rendered="{!field == 'Deal_Status__c'}">
                                                <apex:selectOption itemValue="null" itemLabel="--None--"/>
                                                <apex:selectOption itemValue="Closed" itemLabel="Closed"/>
                                                <apex:selectOption itemValue="Dead" itemLabel="Dead"/>
                                            </apex:selectList>

                                        </td>
                                    </tr> 
                                    </apex:repeat> 
                                </table>
                                <div style="text-align: center;margin-top: 24px;">
                                    <button type="button" onclick="saveClosedProcess();return false;" class="btn btn-primary">Save</button>
                                </div>
                            </div>
                        </div>

                                
                        <div id="deadProcess" class="panel panel-info" style="display:none;">
                            <div class="panel-heading">
                                <h7>{!Deal__c.Salesforce_Company__r.Name}</h7><br/>
                                <b><h4>{!Deal__c.Name}</h4></b>
                            </div>
                            <div class="panel-body">
                                <table width="100%" >
                                    <apex:repeat value="{!$ObjectType.Deal__c.FieldSets.SL_DeadDealProcess}" var="field">
                                    <tr >
                                        <td style="width:40%!important;text-align: right;padding-right: 12px;padding-top: 12px;">
                                            {!field.label}
                                        </td>
                                        <td style="width:60%!important;padding-top: 12px;">    

                                            <apex:inputField value="{!objDeadDeal[field]}" rendered="{!field != 'Deal_Status__c'}"/>        

                                            <apex:selectList id="selectStatus" value="{!objDeadDeal[field]}" size="1" rendered="{!field == 'Deal_Status__c'}">
                                                <apex:selectOption itemValue="null" itemLabel="--None--"/>
                                                <apex:selectOption itemValue="Closed" itemLabel="Closed"/>
                                                <apex:selectOption itemValue="Dead" itemLabel="Dead"/>
                                            </apex:selectList>
                                                
                                        </td>
                                    </tr> 
                                    </apex:repeat>
                                </table>
                                <div style="text-align: center;margin-top: 24px;">
                                    <button type="button" onclick="saveDeadProcess();return false;" class="btn btn-primary">Save</button>
                                </div>
                            </div>
                        </div>

                    </div>

                    
                </apex:outputPanel>


                <apex:actionstatus id="loading" startText="Requesting...">
                    <apex:facet name="start">
                        <div id="salesforceSource_blurybackground" style="position:fixed; left:1px; top:1px; width:100%; height:100%; text-align:center; vertical-align: middle; background-color: #dcdcdc; opacity:0.7;filter:alpha(opacity=60)"></div>
                        <div id="ManageMembersViewport_loading" class="waitingSearchDiv" style="width: 100%; height: 100%; display: ''; ">
                            <div style="width: 144px;vertical-align: middle;" class="waitingHolder">
                                <table style="width: 100%; height: 100%">
                                    <tr align="center" valign="top" style="width: 100%; height: 30%">
                                        <td valign="top"><img src="/img/loading.gif" /><span class="waitingDescription"><b>Loading...</b></span></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div id="ManageMembersViewport_loading" class="waitingSearchDiv" style="width: 100%; height: 100%; display:''; "></div>
                        <script>
                            document.getElementById('ManageMembersViewport_loading').height = window.innerHeight * (3 / 4);
                        </script>
                    </apex:facet>
                    <apex:facet name="stop"></apex:facet>
                </apex:actionstatus>


            </apex:form>

        </div>
    </div>

    <script type="text/javascript">

        var inputArray = document.getElementById('divId').getElementsByTagName('input');
        for (var index = 0; index < inputArray.length; index++) {
            if (inputArray[index].type == 'checkbox') {
                inputArray[index].className = 'checkbox';
            } else if (inputArray[index].type == 'text') {
                inputArray[index].className = 'form-control';
                inputArray[index].style.width = '30%';
            } 
        }

        var textareaArray = document.getElementById('divId').getElementsByTagName('textarea');
        for (var index = 0; index < textareaArray.length; index++) {
            textareaArray[index].className = 'form-control';
            textareaArray[index].style.width = '50%';
            textareaArray[index].style.height = '110%';
        }
        

        var selectArray = document.getElementById('divId').getElementsByTagName('select');
        for (var index = 0; index < selectArray.length; index++) {

            selectArray[index].className = 'form-control';
            if (selectArray[index].multiple == true) {
                selectArray[index].style.width = '100%';
            } else {
                selectArray[index].style.width = '30%';
            }
        }

        function renderTable (status) {
            if(status == 'Closed'){
                document.getElementById('selectProcess').style.display = 'none';
                document.getElementById('closedProcess').style.display = '';
                document.getElementById('deadProcess').style.display = 'none';
            }else if(status == 'Dead'){
                document.getElementById('selectProcess').style.display = 'none';
                document.getElementById('closedProcess').style.display = 'none';
                document.getElementById('deadProcess').style.display = '';
            }else if(status == ''){
                document.getElementById('selectProcess').style.display = '';
                document.getElementById('closedProcess').style.display = 'none';
                document.getElementById('deadProcess').style.display = 'none';
            }
        }

        function saveClosedProcess () {
            closedProcessAF();
        }

        function saveDeadProcess () {
            deadProcessAF();
        }

        function closeWindow () {

            if (navigator.appVersion.indexOf("MSIE 7") > 0 || navigator.appVersion.indexOf("MSIE 8") > 0 || navigator.appVersion.indexOf("MSIE 9") > 0) {
                window.location.href = '../{!$CurrentPage.parameters.Id}';
                //window.location.reload(true);
            } else { 
                self.close();
                window.opener.location.href = '../{!$CurrentPage.parameters.Id}';
                window.opener.location.reload(true);
            }
        }
    </script>

</apex:page>