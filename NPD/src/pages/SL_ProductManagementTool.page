<!-- 
* @PageName      : SL_ProductManagementTool.
* @Ticket No.    : NPD-87.
* @CreatedOn     : 08/Sep/2015
* @CreatedBy     : Sandeep
* @Description   : This page to create opportunity product records.
-->
<apex:page standardController="Opportunity" extensions="SL_ProductManagementToolCtrl" readOnly="false" >
    <apex:sectionHeader title="Product Selection for" subtitle="{!objOpp.Name}"/>
    <apex:form id="frm">
        <head>
            <apex:stylesheet value="{!URLFOR($Resource.SL_ProductManagementTool, 'css/jquery.dataTables.min.css')}"/>
            <apex:includeScript value="{!URLFOR($Resource.SL_ProductManagementTool, 'js/main.js')}"/>
            <!--<apex:stylesheet value="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.9/css/jquery.dataTables.css"/>-->
            <!--<apex:includeScript value="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"/>-->
            <!--<apex:includeScript value="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.9/js/jquery.dataTables.js"/>-->
            
            <style>
                table.dataTable thead .sorting_asc {
                background: url("{!URLFOR($Resource.SL_ProductManagementTool, 'images/sort_asc.png')}") no-repeat center left;
                }
                table.dataTable thead .sorting_desc {
                background: url("{!URLFOR($Resource.SL_ProductManagementTool, 'images/sort_desc.png')}") no-repeat center left;
                }
                table.dataTable thead .sorting {
                background: url("{!URLFOR($Resource.SL_ProductManagementTool, 'images/sort_both.png')}") no-repeat center left;
                }
                .se-pre-con {
                position: fixed;
                left: 0px;
                top: 0px;
                width: 100%;
                height: 100%;
                z-index: 9999;
                background: url('{!URLFOR($Resource.SL_ProductManagementTool, 'images/Preloader_8.gif')}') center no-repeat #fff;
                }
                .paginate_input{width:40px;}
            </style>
        </head>
        
                       
        <div class="se-pre-con"></div>
        <apex:pageBlock id="pb1" >
            <div style="font-size: 22px;">
                Search Products
            </div><br/>
            <table style="width:100%;">
                <tr>
                    <th rowspan="2"><span style="font-size:18px;">Filter By:</span></th>
                    <th>Product Family</th>
                    <th>Product Group</th>
                    <th>Product Offering</th>
                    <th>Retailer</th>
                    <th>Accounting Units</th>
                </tr>
                <tr>
                    <td>
                        <select id="selectFamily" class="select" onchange="familyAF(this.value)">
                            <option value="">--None--</option>
                            <apex:repeat value="{!Family}" var="fmly">
                                <option value="{!fmly.value}">{!fmly.value}</option>
                            </apex:repeat>
                        </select>
                    </td>
                    <td>
                        <apex:outputPanel id="op4">
                         <select id="selectGroup" class="select" onchange="GroupAF(this.value);">
                            <apex:repeat value="{!setProductGroup}" var="grp">
                                <option value="{!grp}">{!grp}</option>
                            </apex:repeat>
                        </select>
                        </apex:outputPanel>
                        
                    </td>
                    <td>
                        <apex:outputPanel id="op5">
                         <select id="selectOffering" class="select">
                            <apex:repeat value="{!setProductOffering}" var="offr">
                                <option value="{!offr}">{!offr}</option>
                            </apex:repeat>
                        </select>
                        </apex:outputPanel>
                    </td>
                    <td>
                        <select id="selectRetailer" class="select">
                            <option value="">--None--</option>
                            <apex:repeat value="{!Retailers}" var="rtlr">
                                <option value="{!rtlr.value}">{!rtlr.value}</option>
                            </apex:repeat>
                        </select>
                    </td>
                    <td>
                        <select id="selectAccountingUnits" class="select">
                            <option value="">--None--</option>
                            <apex:repeat value="{!AccountingUnits}" var="rtlr">
                                <option value="{!rtlr.value}">{!rtlr.value}</option>
                            </apex:repeat>
                        </select>
                    </td>
                </tr>
            </table>
        <br/>
            <table id="productId" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th style="background-image:none;"></th>
                        <th>Product Identifier</th>
                        <th>Product Family</th>
                        <th>Product Group</th>
                        <th>Product Offering</th>
                        <th>Retailer</th>
                        <th>Accounting Units</th>
                    </tr>
                </thead>
                <tbody>
                    <apex:repeat value="{!mapProductIdentifierToProduct2}" var="mapProduct2">
                    <tr>
                        <td>
                            <input class="btn" type="button" value="Add" onclick="addIntoSelectedProductJS('{!mapProductIdentifierToProduct2[mapProduct2].Product_Identifier__c}');"/>
                        </td>
                        <td>{!mapProductIdentifierToProduct2[mapProduct2].Product_Identifier__c}</td>
                        <td>{!mapProductIdentifierToProduct2[mapProduct2].Product_Family__c}</td>
                        <td>{!mapProductIdentifierToProduct2[mapProduct2].Product_Group__c}</td>
                        <td>{!mapProductIdentifierToProduct2[mapProduct2].Product_Offering__c}</td>
                        <td>{!mapProductIdentifierToProduct2[mapProduct2].Retailers__c}</td>
                        <td>{!mapProductIdentifierToProduct2[mapProduct2].Accounting_Units__c}</td>
                    </tr>
                    </apex:repeat>
                </tbody>
            </table>
        </apex:pageBlock>
        
        <apex:pageMessages id="pMsg"/>
        
        <apex:pageBlock id="pb2" >
            <div style="font-size: 22px;">Selected Products</div><br/>
            <apex:pageBlockButtons >
                <apex:commandButton action="{!createOppLineItems}" value="Save" rerender="pMsg" status="counterStatus" disabled="{!lstProduct2Wrapper.size == 0}"/>
                <apex:commandButton action="{!cancel}" value="Cancel" rerender="pMsg" status="counterStatus"/>
            </apex:pageBlockButtons>
            <apex:pageBlockTable value="{!lstProduct2Wrapper}" var="wraptEntry1" id="pbt2" styleClass="table table-hover" rendered="{!(lstProduct2Wrapper.size == 0)}">
                    <apex:facet name="header">No data available in table</apex:facet>
            </apex:pageBlockTable>
            
            <table id="selectedProductId" class="display" cellspacing="0" width="100%" style="display:{!IF(lstProduct2Wrapper.size == 0, 'none', 'block')}">
                <thead>
                    <tr>
                        <th></th>
                        <th>Trend</th>
                        <th>Is Fund?</th>
                        <th colspan="2">Start Month</th>
                        <th colspan="2">End Month</th>
                        <th>Sales Price</th>
                        <apex:repeat value="{!$ObjectType.Product2.FieldSets.SL_ProductMgtTool}" var="flds">
                        <th>{!flds.Label}</th>
                        </apex:repeat>
                    </tr>
                </thead>
                <tbody>
                    <apex:variable var="rowNo" value="{!0}"/> 
                    <apex:repeat value="{!lstProduct2Wrapper}" var="wrpr">
                    <tr>
                        <td>
                            <apex:variable var="rowNo" value="{!rowNo+1}"/>
                            <apex:commandLink action="{!removeProductFromSelectedProduct}" value="X" rerender="pb2,pMsg" status="counterStatus" oncomplete="prepareDataTable();">
                                <apex:param name="removeParam" value="{!rowNo}" assignTo="{!intSelectedProductTableRowNo}"/>
                            </apex:commandLink>
                        </td>
                        <td>
                            <apex:inputCheckbox value="{!wrpr.objOppLineItem.Trend__c}" />
                        </td>
                        <td>
                            <apex:inputCheckbox value="{!wrpr.objOppLineItem.Is_Fund__c}"/>
                        </td>
                        <td>
                            <apex:selectList value="{!wrpr.strCurrentMonth}" multiselect="false" size="1">
                                <apex:selectOptions value="{!Months}"/>
                            </apex:selectList>
                        </td>
                        <td>
                            <apex:inputText value="{!wrpr.intCurrentYear}" style="width:40px;"></apex:inputText>
                        </td>
                        <td>
                            <apex:selectList value="{!wrpr.strEndMonth}" multiselect="false" size="1">
                                <apex:selectOptions value="{!Months}"/>
                            </apex:selectList>
                        </td>
                        <td>
                            <apex:inputText value="{!wrpr.intEndYear}" style="width:40px;" ></apex:inputText>
                        </td>
                         <td id="{!rowNo}-1">
                            <apex:inputHidden value="{!wrpr.strCombinationOfAllFields}"/>
                            <apex:inputText value="{!wrpr.objOppLineItem.UnitPrice}" style="width:80px;"></apex:inputText>
                        </td>
                        
                        <apex:repeat value="{!$ObjectType.Product2.FieldSets.SL_ProductMgtTool}" var="flds">
                            <td >
                                <select id="{!flds}-{!rowNo}" onchange="createUniqCombinations1('{!flds}', '{!rowNo}');">
                                    <apex:repeat value="{!wrpr.mapFieldToTheirOptions[flds.FieldPath]}" var="fldsVal" >
                                        <option value="{!fldsVal}">{!fldsVal}</option>
                                    </apex:repeat>
                                </select>
                                
                                 <script>
                                    var arrayVar = '{!wrpr.mapFieldToTheirOptions[flds.FieldPath]}';
                                    if(arrayVar.length <= 2)
                                        document.getElementById('{!flds}-{!rowNo}').style.display = 'none';
                                    createUniqCombinations();
                                    function createUniqCombinations()
                                    {
                                        document.getElementById('{!rowNo}-1').getElementsByTagName('input')[0].value += '~~~{!flds}--->'+document.getElementById('{!flds}-{!rowNo}').value;
                                    }
                                    function createUniqCombinations1(fld, rowNo)
                                    {
                                        document.getElementById(rowNo+'-1').getElementsByTagName('input')[0].value += '~~~'+fld+'--->'+document.getElementById(fld+'-'+rowNo).value;
                                    }
                                </script>
                            </td>
                        </apex:repeat>
                    </tr>
                    </apex:repeat>
                </tbody>
            </table>
        </apex:pageBlock>
        
        <!--Action status for loading symbol-->
        <apex:actionstatus id="counterStatus">
            <apex:facet name="start">
                <div class="waitingSearchDiv" id="el_loading" style="background-color: #fbfbfb; height:100%;opacity:0.75;width:100%;">
                    <div class="waitingHolder" style="top: 100px; width: 91px;">
                    <img class="waitingImage" src="{!URLFOR($Resource.SL_ProductManagementTool, 'images/Preloader_8.gif')}" title="Please Wait..." />
                    <span class="waitingDescription">Loading...</span>
                    </div>
                </div>
            </apex:facet>
        </apex:actionstatus>
            
        <apex:actionFunction name="addIntoSelectedProductAF" action="{!addIntoSelectedProduct}" rerender="pb2,pMsg" status="counterStatus" oncomplete="prepareDataTable();">
            <apex:param name="addParam" value="" assignTo="{!strSelectedProductIdentifier}"/>
        </apex:actionFunction>
         <apex:actionFunction name="familyAF" action="{!onChangeOfProductFamily}" rerender="op4,op5" oncomplete="prepareFiltersJS();">
            <apex:param name="myfamilyParam" value="" assignTo="{!strProductFamilySelected}"/>
        </apex:actionFunction>
        <apex:actionFunction name="GroupAF" action="{!onChangeOfProductGroup}" rerender="op5" oncomplete="prepareFiltersJS();">
            <apex:param name="myGroupParam" value="" assignTo="{!strProductGroupSelected}"/>
        </apex:actionFunction>
         <script>
            function addIntoSelectedProductJS(productUniqueName)
            {
                addIntoSelectedProductAF(productUniqueName);
            }
            var table;
            $(document).ready(function() {
                
                table =  $('#productId').DataTable( {
                    "columnDefs": [ {  
                        "targets": 0,
                        "orderable": false 
                    }, {
                        "targets": [ 5, 6],
                        "visible": false,
                        "searchable": true
                    }]
                } );
                prepareFiltersJS();
                prepareDataTable();
            } );
            
            function prepareFiltersJS()
            {
                $('#selectFamily').on('change', function () {
                    var selectVal = this.value == '--None--'?'':this.value;
                    table.columns(2).search( selectVal).draw();
                    table.columns(3).search( '' ).draw();//on change of family removing filter for group and offering
                    table.columns(4).search( '' ).draw();
                } );
                $('#selectGroup').on('change', function () {
                    var selectVal = this.value == '--None--'?'':this.value;
                    table.columns(3).search( selectVal ).draw();
                    table.columns(4).search( '' ).draw();//on change of group removing filter for offering
                } );
                $('#selectOffering').on('change', function () {
                    var selectVal = this.value == '--None--'?'':this.value;
                    table.columns(4).search( selectVal ).draw();
                } );
                $('#selectRetailer').on('change', function () {
                    var selectVal = this.value == '--None--'?'':this.value;
                    table.columns(5).search( selectVal ).draw();
                } );
                $('#selectAccountingUnits').on('change', function () {
                    var selectVal = this.value == '--None--'?'':this.value;
                    table.columns(6).search( selectVal ).draw();
                } );
            }
            function prepareDataTable()
            {
               var productTable = $('#selectedProductId').DataTable({
                   "bFilter": false,
                   "bLengthChange": false,
                   "bSort": false
               });
            }
            $(".se-pre-con").fadeOut("slow");
        </script>
    </apex:form>
</apex:page>