<apex:page standardController="Deal__c" extensions="ManageDealTeamMembers">

<apex:outputPanel id="dmessage">{!dmessage}</apex:outputPanel>

<apex:includeScript value="{!URLFOR($Resource.jquery, '/js/jquery-1.4.2.min.js')}"/>

<style type="text/css">
.tightHeader {
    width:1px;
}
</style>

<apex:sectionHeader title="Manage Team Members" subtitle="{!Deal__c.Name}"/>

<apex:actionStatus id="loadStatus">
    <apex:facet name="start">
        <apex:pageBlock >
            <c:loadingStatus />
        </apex:pageBlock>
    </apex:facet>
    <apex:facet name="stop">
        <apex:form id="tmPanel">
            <script type="text/javascript">
            $(function() {
                clickCheckboxChild('add');
                clickCheckboxChild('remove');
            });
            function clickCheckboxParent(checkboxId, checked) {
                $('[id$='+checkboxId+'CheckboxChild]').attr('checked',checked);
            };
            function clickCheckboxChild(checkboxId) {
                var checkParent = true;
                $('[id$='+checkboxId+'CheckboxChild]').each(function() {
                    checkParent &= $(this).attr('checked');
                });
                $('[id$='+checkboxId+'CheckboxParent]').attr('checked',checkParent);
            };
            </script>

            <apex:pageMessages />

            <apex:pageBlock title="Add Team Members" >
                <apex:pageBlockButtons location="top">
                    <apex:commandButton value="Add" action="{!add}" status="loadStatus" reRender="tmPanel" disabled="{!newMembers.empty}"/>
                    <apex:commandButton value="Done" action="{!cancel}" immediate="true"/>
                </apex:pageBlockButtons>

                <apex:pageBlockTable value="{!newMembers}" var="tm">
                    <apex:column width="1px" headerClass="tightHeader" style="vertical-align:top">
                        <apex:facet name="header">
                            <apex:inputCheckbox id="addCheckboxParent" onclick="clickCheckboxParent('add',this.checked);" disabled="{!newMembers.empty}"/>
                        </apex:facet>
                        <apex:inputCheckbox id="addCheckboxChild" value="{!tm.selected}" onclick="clickCheckboxChild('add');"/>
                    </apex:column>
                    <apex:column headerValue="Name" value="{!tm.record.User__r.Name}"/>
                    <apex:column headerValue="Title" value="{!tm.record.User__r.Title}"/>
                    <apex:column headerValue="Role">
                        <apex:inputField value="{!tm.record.Role__c}"/>
                    </apex:column>
                    <apex:column headerValue="Deal Mentor">
                        <apex:inputField value="{!tm.record.Deal_Mentor__c}"/>
                    </apex:column>
                    <apex:column headerValue="Active Deals">
                        <apex:outputField value="{!tm.record.User__r.Active_Deals__c}"/>
                    </apex:column>
                </apex:pageBlockTable>
            </apex:pageBlock>


            <apex:pageBlock title="Selected Team Members" rendered="{!NOT(oldMembers.empty)}">
                <apex:pageBlockButtons location="top">
                    <apex:commandButton value="Remove" action="{!remove}" status="loadStatus" reRender="tmPanel" disabled="{!oldMembers.empty}"/>
                </apex:pageBlockButtons>

                <apex:variable var="index" value="{!0}"/>
                <apex:pageBlockTable value="{!oldMembers}" var="tm">
                    <apex:column width="1px" headerClass="tightHeader" style="vertical-align:top">
                        <apex:facet name="header">
                            <apex:inputCheckbox id="removeCheckboxParent" onclick="clickCheckboxParent('remove',this.checked);" disabled="{!oldMembers.empty}"/>
                        </apex:facet>
                        <apex:inputCheckbox id="removeCheckboxChild" value="{!tm.selected}" onclick="clickCheckboxChild('remove');"/>
                    </apex:column>
                    <apex:column headerValue="Name" value="{!tm.record.User__r.Name}"/>
                    <apex:column headerValue="Title" value="{!tm.record.User__r.Title}"/>
                    <apex:column headerValue="Role" value="{!tm.record.Role__c}"/>
                    <apex:column headerValue="Deal Mentor">
                        <apex:inputField value="{!tm.record.Deal_Mentor__c}">
                            <apex:actionSupport event="onchange" action="{!applyDealMentor}" status="loadStatus" rerender="dmessage">
                                <apex:param name="index" value="{!index}"/>
                            </apex:actionSupport>
                        </apex:inputField>
                        <apex:variable var="index" value="{!index+1}"/>
                    </apex:column>
                </apex:pageBlockTable>
            </apex:pageBlock>
        </apex:form>
    </apex:facet>
</apex:actionStatus>
</apex:page>