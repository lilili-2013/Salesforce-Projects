<apex:page sidebar="false" controller="SLCA2.CA_JSInitController" >

<apex:stylesheet value="{!URLFOR($Resource.SLCA2__jQuery, '/themes/default/theme.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.SLCA2__jQuery, '/css/color-picker-1.0.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.SLCA2__CalendarAnything, 'css/changes.css')}"/>
 
<apex:includeScript value="{!URLFOR($Resource.SLCA2__jQuery, 'jquery.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__jQuery, 'jquery-ui.custom.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__CalendarAnything, 'js/jquery.ui.datepicker.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__CalendarAnything, 'js/ui.timepicker.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__CalendarAnything, 'js/jquery.validate.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__CalendarAnything, 'js/jquery.ui.sf.filters.102.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__CalendarAnything, 'js/panels-ui-1.0.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__CalendarAnything, 'js/extends-ui-1.0.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__CalendarAnything, 'helpSystem.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__jQuery, 'js/color-picker-1.0.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__CalendarAnything, 'touch/phantomLimb.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.SLCA2__betaTouch)}"/>
<style> 
               
    #dlg_add_edit td.list-column {
        width:40%;
    }
                
    #dlg_add_edit div ul { 
        list-style-type: none; 
        margin: 0; 
        padding: 0; 
        margin-bottom: 10px; 
        font-size: 12px; 
        overflow:auto;  
        height:185px;
    }
                
    #dlg_add_edit h3 { display: block !important; }
                
    #dlg_add_edit div ul li { 
        margin: 5px; 
        padding: 5px; 
        white-space:nowrap;
        height: 15px;
        vertical-align: middle;                        
    }
    #dlg_add_edit div ul li input{
        float:right;                    
    } 
                                
    .ui-datepicker { z-index : 2002 !important; }

    .is-selected-item {
        background-color: #26c;
        color: #fff;
        outline: none;
        font-weight: bold;
        border: 1px solid #ccf;
    }
    
    /* Preventing selectable in webkit */
    body {
        -khtml-user-select: none;
        -webkit-user-select: none;
    }
    .ui-state-default, .list-column {
        -moz-user-select: none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        user-select: none;
    }
    .widgetGrayBackground {
        position: absolute;
        z-index: 998;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("{!URLFOR($Resource.CalendarAnything, 'css/pixel.png')}");
    }
    .widgetMessage {
        border: 2px solid #eef;
        border-radius: 5px;
        background-color: #a03;
        color: #fff;
        position: absolute;
        z-index: 999;
        top: 120px;
        left: 30%;
        overflow:auto;
    }
    .scrollHidden {
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    #dlg_colors_popup {
        position: relative;
        width: 15px;
        height: 15px;
    }
    #dlg_colors_popup div {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 15px;
        height: 15px;
        border: 2px solid #000;
    }
    .color-table td {
        width: 15px;
        height: 15px;
    }
    .ca-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
    }
    .ui-form-label {
        font-weight: bold;
    }
    
    /* Help styles */
    .ca-help-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        background: url({!URLFOR($Resource.jQuery, '/icons/create_edit_icons.png')}) no-repeat 0 -16px;
    }
    .helpLink {
        color: #000;
    }
    
    /* Show more box for fix bug for iPod/Droid scrollbar */
    .show-more {
        border:1px solid #26c;
        background-color:#c1e1fb;
        margin-top:5px;
        border-radius: 5px;
        text-align: center;
        color: #797979;
        cursor: pointer;
    }
    .more-class {
        height: auto;
    }
    
    /* additional styles */
    .ui-block-sites-section {
        position: absolute;
        z-index: 30000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: #666;
        opacity: 0.3;
    }
    
    #dlg_display_sites .no_show{
       display:none !important;
    }
    
    
</style>

<!-- -------- Status Bar -------- -->

<div id="salesforceSource_blurybackground" style="position:absolute; left:1px; top:1px; width:100%; height:100%; 
                                                text-align:center; vertical-align: middle; background-color: #dcdcdc; 
                                                opacity:0.6;filter:alpha(opacity=60); z-index:888;"></div>
<div id="ManageMembersViewport_loading" class="waitingSearchDiv" style="width: 100%; height: 80%; display: ''; z-index:889;">
<div style="width: 144px;vertical-align: middle;" class="waitingHolder">
    <table align="center" valign="top" style="width: 100%; height: 30%">
        <tr align="center" valign="top" style="width: 100%; height: 30%">
            <td valign="top"><img class="waitingImage" src="/img/loading.gif"/><span class="waitingDescription">Processing......</span></td>
        </tr>
    </table>
</div>
</div>

<!-- ---------------- -->

<script>


var calendarFormController;

var calendarForm = function(initData){
    var self = this,
        _aAllFields = [],
        _initData = {},
        _bInit = false;    
    
    self.getFieldProperty = function(sId){
        if (_aAllFields == undefined) {
            return {};
        }       
        for (var nI = 0; nI < _aAllFields.length; nI++) {
            if (_aAllFields[nI].id.toLowerCase() == sId) {
                return _aAllFields[nI];
            }
        }
        return {};
    }
    
    self.checkEditableCalendar = function() {
        var aCheck = ['#dlg_entry_end', '#dlg_entry_start'], 
            nI,  bNonEditable = false, 
            aField = {},
            sTitle = '';
            
        if (_initData.iseditable == undefined || _initData.iseditable) {
            for (nI = 0; nI < aCheck.length; nI++) {
                aField = self.getFieldProperty(jQuery(aCheck[nI]).val());
                if (aField.id == undefined) {
                    continue;
                }
                bNonEditable = !(aField.isCreateable && aField.isUpdateable);
                if (bNonEditable) {
                    break;
                }            
            }
            sTitle = 'Calendar can not be Editable because non-editable Entry Start or Entry End is selected';
        } else if (_initData.iseditable != undefined && !_initData.iseditable){
            bNonEditable = true;
            sTitle = 'No edit permissions to target object';
        }
        jQuery('#dlg_editable')
             .attr('disabled',  bNonEditable)
             .attr('title', bNonEditable ? sTitle : '');
         if (bNonEditable) {
           jQuery('#dlg_editable').attr('checked', false);
         }
    }
    
    self.init = function(initData) {
        if (_bInit) {
//            return;
        }
        _bInit = true;
        _initData = initData;
        _aAllFields = initData.AllFields;
        self.checkEditableCalendar();
        return self; 
    }
    
    self.init(initData);
}



//Igor Bidenko add
jQuery(document).ready(
    function(){
        jQuery.extend(jQuery.support, {
            touch: "ontouchend" in document
        });
    
    //
    // Hook up touch events
    //
    
        jQuery.fn.addTouch = function() {
                if (jQuery.support.touch) {
                        this.each(function(i,el){
                                el.addEventListener("touchstart", iPadTouchHandler, false);
                                el.addEventListener("touchmove", iPadTouchHandler, false);
                                el.addEventListener("touchend", iPadTouchHandler, false);
                                el.addEventListener("touchcancel", iPadTouchHandler, false);
                        });
                }
        };
        jQuery('.ui-draggable').dialog().addTouch();
        var lastTap = null;
    
    }
);
//Igor Bidenko add end



function on_delete() {
        return window.confirm('You are sure?');
}

function getUrlParameter(p) {
    var res = '';
    var url = location.href.substr(location.href.indexOf('?') + 1);
    var parts = url.split('&');
    for (var i = 0; i < parts.length; i++) {
        if (parts[i] != undefined) {
            var param = parts[i].split('=');
            if (param[0] == p) {
                res = param[1];
            }
        }
    }
    return res;
}
var isFirstLoading = true;
jQuery.noConflict();    
(function($) {
        $(document).ready(function() {
            window.focus();
            
            function getBodyScrollTop() {
                return self.pageYOffset || 
                (document.documentElement && document.documentElement.scrollTop) || 
                (document.body && document.body.scrollTop);
            }
            
            function showErrorMessage(p_message) {
        
                var messageContainer = document.createElement('div');
                document.body.appendChild(messageContainer);
                var itemsLen = $('.widgetError').length;
                
                $(messageContainer).addClass('widgetError');
                $(messageContainer).attr('id','wdg_err_wnd_'+itemsLen);
                $(messageContainer).css('top',document.scrollTop);
                $(document).find('body').addClass('scrollHidden');
                
                var text = "";
                var grayElems = $('.widgetGrayBackground').length;
                if (grayElems > 0) {
                    text += "<div class='widgetGrayBackground' style='display:none;'></div>";
                } else {
                    text += "<div class='widgetGrayBackground'></div>";
                }
                text += "<table width='55%' class='widgetMessage' style='margin:"+(itemsLen*8)+"px; top: "+
                        (getBodyScrollTop()+120)+"px;'>";
                text += "<tr><td style='color:#fff;' id='wdg_msg_container' align='center'>";
                text += p_message;
                text += "</td><td valign='top'>";
                text += "<a href='#' style='color:yellow; font-weight:bold; text-decoration:none;'>X</a>";
                text += "</td></tr>";
                text += "</table>";
                
                $(messageContainer).html(text);
                $(messageContainer).find('a').bind('click',function(){
                    $(document).find('body').removeClass('scrollHidden');
                    $(messageContainer).remove();
                });
                $('.widgetGrayBackground').css('height',(document.body.scrollHeight > document.body.offsetHeight)?document.body.scrollHeight:document.body.offsetHeight);
            }
            
                var json_response = null;
                var g_cid = null;
                var AddButtonsClass = "";
                var EditButtonsClass = "";
                var DeleteButtonsClass = "";
                var sessionToken = "{!SessionToken}";
                var allCalendarsNames = "{!JSENCODE(getAllCalendarsNamesToClone)}";
                var initingCalendarName = '';
                var initingFriendlyName = '';
                var initingCalendarName = '';
                var initingFriendlyName = '';
                
                /* properties names definition here. this is necessary to be sure that names is the same in client and server part*/
                
                var Names = {};
                Names.UrlEventHandle = '{!EventHandlerPageName}';
                Names.UrlJsonResponses = '{!AjaxResponsePageName}'; 
                
                Names.GetParamEvent = '{!GetParameterNameEvent}';
                Names.GetParamCalID = '{!GetParameterNameCID}';
                Names.GetParamToken = '{!GetParameterNameToken}';
                Names.GetParamColor = '{!GetParameterNameColor}';
                Names.GetParamObjType = '{!GetParameterNameObjType}';
                Names.GetParamObjName = '{!GetParameterNameObjName}';
                Names.GetParamObjID = '{!GetParameterNameObjId}';
                Names.GetParamSelectedIDs = '{!GetParameterNameSelectedIDs}';
                
                Names.GetParamTitle = '{!GetParameterNameTitle}';
                Names.GetParamFriendlyName = '{!GetParameterNameFriendlyName}';
                Names.GetParamEntryField = '{!GetParameterNameEntryField}';
                Names.GetParamGroupByField = '{!GetParameterNameGroupByField}';
                Names.GetParamStartField = '{!GetParameterNameStartField}';
                Names.GetParamEndField = '{!GetParameterNameEndField}';
                Names.GetParamVisible = '{!GetParameterNameVisible}';
                Names.GetParamEditable = '{!GetParameterNameEditable}';
                Names.GetParamOwnership = '{!GetParameterNameOwnership}';
                Names.GetParamRestrictVisability = '{!GetParameterNameRestrictVisability}';
                Names.GetParamHoverFields = '{!GetParameterNameHoverFields}';
                Names.GetParamFilterset = '{!GetParameterNameFilterset}';
                Names.GetParamFilteradvanced = '{!GetParameterNameFilteradvanced}';
                Names.GetParamFilteradvancedSection = '{!ActiveAdvancedFilterSection}';
                Names.GetParamSelectedGroupsIDs = '{!GetParameterNameSelectedGroupsIDs}';
                Names.GetParamSelectedSitesIDs = '{!GetParameterNameSelectedSitesIDs}';
                Names.GetParamAdvOptions = '{!GetParameterNameAdvOptions}';
                Names.GetParamFieldChanged = '{!GetParameterNameChangedField}';
                Names.GetParamPicklist = '{!GetParameterNamePicklist}';
                Names.GetParamCreatingFields = '{!GetParameterNameCreatingFields}';
                
                Names.ActionCalendarCreate = '{!EventNameCalendarCreate}';
                Names.ActionCalendarEdit = '{!EventNameCalendarEdit}';
                Names.ActionCalendarDelete = '{!EventNameCalendarDelete}';
                Names.ActionCalendarSave = '{!EventNameCalendarSave}';
                Names.ActionGroupCreate = '{!EventNameCalendarGroupCreate}';
                Names.ActionGroupDelete = '{!EventNameCalendarGroupDelete}';
                Names.ActionGroupSave = '{!EventNameCalendarGroupSave}';
                Names.ActionFieldChange = '{!EventNameFieldChange}';
                Names.ActionLoadFilters = '{!EventNameFiltersLoad}';
                
                g_cid = "{!IF(CIDParam != '',CIDParam,'')}";
                $('#dlg_calendar_name').val("");
                if (g_cid == '') {
                    loadingData(Names.ActionCalendarCreate);
                } else {
                    loadingData(Names.ActionCalendarCreate,g_cid);
                }
                
                function DialogInitialize() {
                    if(json_response != null) {
                    
                        if( json_response.HoverPageAvailableFields != undefined ) {
                            if(json_response.HoverPageSelectedFields == undefined) {
                                json_response.HoverPageSelectedFields = [];
                            }
                            $("#dlg_display").SortablePanels({
                                clean : true,
                                panel1 : 'list_of_object_fields',
                                panel2 : 'list_of_selected_fields',
                                connected_class : 'connectedSortable',
                                panel1_list : json_response.HoverPageAvailableFields,
                                panel2_list : json_response.HoverPageSelectedFields                                               
                            });
                        }

                        if( json_response.AvailableCreatingFields != undefined ) {
                            if(json_response.SelectedCreatingFields == undefined) {
                                json_response.SelectedCreatingFields = [];
                            }

                            $("#dlg_display_on_create").SortablePanels({
                                clean : true,
                                panel1 : 'list_of_object_creating_fields',
                                panel2 : 'list_of_selected_creating_fields',
                                connected_class : 'connectedSortable',
                                panel1_list : json_response.AvailableCreatingFields,
                                panel2_list : json_response.SelectedCreatingFields,     
                                nonMoveablePropertyName : 'isRequired',
                                ShowCheckbox : 'true'                                    
                            });
                        }

                        if( json_response.AvailableCalendars != undefined && json_response.SelectedCalendars != undefined) {
                            $("#select_calendars_dlg").SortablePanels({
                                clean : true,
                                panel1 : 'list_of_available_calendars',
                                panel2 : 'list_of_selected_calendars',
                                connected_class : 'connectedGroupsSortable',
                                panel1_list : json_response.AvailableCalendars,
                                panel2_list : json_response.SelectedCalendars                       
                            });
                        }

                        if( json_response.ObjectFields != undefined) {
                            var source = Names.UrlJsonResponses + "?"+Names.GetParamCalID+"=" + g_cid + "&"+Names.GetParamEvent+"=" + Names.ActionLoadFilters;
                            if(g_cid == undefined || g_cid == '') {
                                source += "&"+ Names.GetParamObjName +"=" + json_response.SelectedObject;                                               
                            }
                            $("#dlg_filters").sfFilters("destroy");
//                          var objName = ($('#dlg_object_name option:selected').val() ? $('#dlg_object_name option:selected').val() : 'accountfeed');

                            var objName = json_response.SelectedObject != undefined 
                                 ? json_response.SelectedObject 
                                 : ($('#dlg_object_name').val() != null && $('#dlg_object_name').val() != undefined  
                                     ? $('#dlg_object_name').val()
                                     : 'accountfeed'
                                 );
                            $("#dlg_filters").sfFilters({
                                debug : false,
                                sourceFieldData: source,
                                calcMargin : function(width) {
                                    var res = (width == 0)? 390 : width-160;
                                    if ($.browser.msie && $.browser.version=="7.0") res /= 2;
                                    return res;
                                },
                                delimiter : "___",
                                sort : false,
                                safeValue : false,
                                sessionToken : sessionToken,
                                firstFilter : false,
                                switchover : true,
                                //goalTargetID: json_response.SelectedObject,
                                goalTargetID: objName,

                                GetParamNameToken : Names.GetParamToken,
                                GetParamNamePicklist : Names.GetParamPicklist,

                                load : function(p_widget) {
                                    p_widget.options.fieldset = json_response.ObjectFields;
                                    p_widget.options.filterset = json_response.UserFilters;
                                },
                                afterload : function(p_widget) {
                                    try {
                                        p_widget.AdvancedFilter(json_response.AdvancedOptionsValue);
                                        if (json_response.Mask != 'null') {
                                            p_widget.AdvancedFilter(json_response.Mask);
                                        }
                                    } catch(err) {}
                                }       
                            });
                        }

                        if( json_response.NonSelectedGroups != undefined && json_response.SelectedGroups != undefined) {
                            $("#groups").SortablePanels({
                                clean : true,
                                panel1 : 'list_of_groups',
                                panel2 : 'list_of_selected_groups',
                                connected_class : 'connectedGroups',
                                panel1_list : json_response.NonSelectedGroups,
                                panel2_list : json_response.SelectedGroups                                        
                            });
                        }

                        //alert(json_response.SelectedSites);
                        if( json_response.AvailableSites != undefined ) {
                            $("#dlg_display_sites").SortablePanels({
                                clean : true,
                                panel1 : 'list_of_sites',
                                panel2 : 'list_of_selected_sites',
                                connected_class : 'connectedSites',
                                panel1_list : json_response.AvailableSites,
                                panel2_list : json_response.SelectedSites
                            });
                            if (json_response.AvailableSites.length > 0 
                                || json_response.SelectedSites.length > 0
                            ) {
                                $('#dlg_display_sites').children()
                                    .removeClass('no_show')
                                    .filter('.sites_not_avaible').addClass('no_show');
                            }                           
                        }

                        if( json_response.Title != undefined && g_cid == '') {
                            $('#dlg_calendar_name').val(json_response.Title);
                        }
                        if( json_response.CalendarGroupName != undefined ) {
                            $('#dlg_group_name').val(json_response.CalendarGroupName);
                        }

                        if (json_response.Color == 'null') {
                            json_response.Color = 'rgb(80,102,240)';
                        }
                        
                        var currentColor;
                        if( json_response.Color != undefined ) {

                            // ==== Initialize standard colorpicker ==== //

                            currentColor = json_response.Color;
                            /*$(".color-table td").click(function () {
                                var element = $(this);
                                $("#dlg_colors_popup div").css('background-color',element.css('background-color'));
                                currentColor = element.css('background-color');
                            });*/

                            // ==== Initialize ColorPicker widget ==== //

                            //$("#dlg_colors_popup div").css('background-color',currentColor);
                        }
                        if (currentColor == 'null' || currentColor == '' || currentColor == undefined) {
                            currentColor = 'rgb(12, 127, 200)';
                        }
                        /* ==== ColorSelector widget ==== */
                        $("#dlg_colors_popup div").css('background-color',currentColor);
                        $('.color-selector-container').ColorSelector({
                            color: currentColor,
                            widgetPath: '{!URLFOR($Resource.jQuery, '/')}',
                            onColorChange: function (ev,data) {
                                $("#dlg_colors_popup div").css('background-color',data.color);
                            }
                        });
                            
                        if( json_response.TypeOfObjects != undefined) 
                            $('#dlg_object_type').SelectInitialize(json_response.TypeOfObjects, json_response.SelectedObjectType);

                        if( json_response.Objects != undefined) {
                            if (g_cid == '') {
                                $('#dlg_object_name').SelectInitialize(json_response.Objects, '');
                            } else {
                                $('#dlg_object_name').SelectInitialize(json_response.Objects, json_response.SelectedObject);
                            }
                            if ($('#dlg_object_name').val().length > 2) {
                                $('.object-name').html($('#dlg_object_name option:selected').html());
                            } else {
                                $('.object-name').html('[select object on step 2]');
                            }
                        }

                        if( json_response.EntryFields != undefined) {     
                            if (g_cid == '') {
                                $('#dlg_entry_label').SelectInitialize(json_response.EntryFields, '');
                            } else {
                                $('#dlg_entry_label').SelectInitialize(json_response.EntryFields, json_response.SelectedEntryField);
                            }
                        }

                        if( json_response.GroupByFields != undefined) {
                            json_response.GroupByFields.unshift({name : "", value : "No Grouping"});     
                            if (g_cid == '') {
                                $('#dlg_group_by').SelectInitialize(json_response.GroupByFields, '');
                            } else {
                                $('#dlg_group_by').SelectInitialize(json_response.GroupByFields, json_response.SelectedGroupByField);
                            }
                        }

                        if( json_response.StartFields != undefined) {
                            if (g_cid == '') {
                                $('#dlg_entry_start').SelectInitialize(json_response.StartFields, '', $('#dlg_object_name').val());
                            } else {
                                $('#dlg_entry_start').SelectInitialize(json_response.StartFields, json_response.SelectedStartField, $('#dlg_object_name').val());
                            }
                        }

                        if( json_response.EndFields != undefined) {
                            if (g_cid == '') {
                                $('#dlg_entry_end').SelectInitialize(json_response.EndFields, '', $('#dlg_object_name').val());
                            } else {
                                $('#dlg_entry_end').SelectInitialize(json_response.EndFields, json_response.SelectedEndField, $('#dlg_object_name').val());
                            }
                        }

                        $('#dlg_visible').CheckboxInitialize("true");
                        /*if( json_response.Visible != undefined) {
                            $('#dlg_visible').CheckboxInitialize(json_response.Visible);
                        } else {
                          
                        }*/

                        if( json_response.editable != undefined)        {
                            $('#dlg_editable').CheckboxInitialize(json_response.editable);
                        }

                        if( json_response.OwnershipOfObjectRecords != undefined) {
                            $('#records').RadioInitializeByReturn(json_response.OwnershipOfObjectRecords);
                        }

                        if( json_response.RestrictVisability != undefined ) {
                            $('#restricts').RadioInitializeByReturn(json_response.RestrictVisability);
                        }

                        if( json_response.AdvancedOptionsValue != undefined ) {
                            $("#advanced_options_value").val('');
                        }

                        if($('#dlg_object_name').val() == '') {
                            $('ul').html('');
                        }
                        
                        if( json_response.AllFields != undefined ){
                            if (calendarFormController == undefined) {
                            
                                calendarFormController = new calendarForm(jQuery.extend({}, json_response));
                            } else {
                                calendarFormController.init(jQuery.extend({}, json_response));                                  
                            }
                            //getFieldProperty.aAllFields = [].concat(json_response.AllFields);  
                        
                        }                       
                    }
                }

                function prepareParams(p_event,p_cid, p_additional) {
                    var params = {};
                    params[Names.GetParamEvent] = p_event;
                    params[Names.GetParamCalID] = p_cid;
                    params[Names.GetParamToken] = sessionToken;
                    if(p_additional != 'undefined') {
                        for(var name in p_additional) {
                            params[name] = p_additional[name];
                        }
                    }
                    return params;
                } 

                function sendActionRequest(p_event, p_cid, p_additional) {
                    var params = prepareParams(p_event,p_cid, p_additional);
                    $.ajax({
                        url: Names.UrlEventHandle,
                        type: 'POST',
                        dataType: 'json',
                        data: params,
                        cache: false, 
                        error : function(XMLHttpRequest, textStatus, errorThrown){
                            alert('Oops! There was an issue connecting to Salesforce. Please close this window and try again.');
                        },
                        success: function(data){
                            if (data.status.substr(0,5) == 'Error') {
                                isError = true;
                                var regExp = /STRING_TOO_LONG/g;
                                var regExpShare = /FIELD_INTEGRITY_EXCEPTION(.)+AccessLevel(.)+share/g;
                                if (regExpShare.test(data.status)) {
                                    showErrorMessage("Settings of Step 6 are related to security settings (organization wide default) for CA_Calendar__c. Please make Private permissions for CA_Calendar__c object for correct work of all settings in this Section 6.");
                                } else {
                                    showErrorMessage(data.status);
                                }
                            } else {
                                if (getUrlParameter('retPage')) {
                                    window.location.href=getUrlParameter('retPage');
                                } else {
                                    window.location.href="{!AjaxListPageName}";
                                }
                            }
                        }
                    });
                }

                function loadingData(p_event, p_cid, p_additional) {
                    var isCache = false;
                    var params = prepareParams(p_event,p_cid, p_additional);
                    $.ajax({
                        url: Names.UrlJsonResponses,
                        type: 'POST',
                        dataType: 'json',
                        data: params,
                        cache: isCache, 
                        error : function(XMLHttpRequest, textStatus, errorThrown){
                            $("body").loadingBar(false);
                            alert('Some error caused. Probably, session is locked by timeout. Please, reload the page: '+errorThrown);
                        },
                        success: function(data){
                            json_response = data;
                            var isError = false;
                            if (p_event != Names.ActionFieldChange) {
                                if (json_response.status.substring(0, 5).toLowerCase() == 'error') {
                                    isError = true;
                                    alert(json_response.status);
                                }
                            }

                            if((p_event == Names.ActionCalendarCreate || p_event == Names.ActionCalendarEdit) && isError == false ) {
                                DialogInitialize();
                            }

                            if(p_event == Names.ActionFieldChange) {
                                DialogInitialize();                             
                            }
                            $('#salesforceSource_blurybackground').hide("slow");
                            $('#ManageMembersViewport_loading').hide("slow");
                            if (isFirstLoading) {
                                if (g_cid == '') {
                                   $('#dlg_object_name').trigger('change');
                                }
                                isFirstLoading = false;
                            }
                        }
                    });     
                }

                function validateName(name) {
                    var reg = /[\\\/\$\?'"@#%\[\]\{\}]/;
                    var res = reg.test(name);
                    var isValidate = true;

                    if (res) {
                        alert('\''+name+'\' contains incorrect symbols');
                        isValidate = false;
                    }

                    return isValidate;
                }

                function prepareNameToSave(nameStr) {
                    var result = nameStr.replace(/[\\]/g,'\\');
                    var result = nameStr.replace(/[\/]/g,'\/');
                    var result = nameStr.replace(/[\?]/g,'\?');
                    var result = nameStr.replace(/[\$]/g,'\$');
                    var result = nameStr.replace(/[']/g,'\'');
                    var result = nameStr.replace(/["]/g,'\"');

                    return result;
                }

                function validateFields() {
                    var ret = true;

                    if ($('#dlg_calendar_name').val() == '') {
                        alert('Enter the name of calendar on Step 1.');
                        ret = false;
                    } else if ($('#dlg_object_name').val() == '') {
                        alert('Enter name of object on Step 2.');
                        ret = false;
                    } else if ($('#dlg_entry_label').val() == '') {
                        alert('Enter entry label on Step 2.');
                        ret = false;
                    } else if ($('#dlg_entry_start').val() == '') {
                        alert('Choose \'Entry Start\' value on Step 2.');
                        ret = false;
                    }

                    return ret;
                }
                
                /* Trim start and end spaces from string */
                function ltrim(inStr) {
                    var ptrn = /\s*((\S+\s*)*)/;
                    return inStr.replace(ptrn, "$1");
                }
                function rtrim(inStr) {
                    var ptrn = /((\s*\S+)*)\s*/;
                    return inStr.replace(ptrn, "$1");
                }
                function trim(inStr) {
                    return ltrim(rtrim(inStr));
                }
                
                function SaveSettings() {
                    var params = {};
                    params[Names.GetParamTitle] = prepareNameToSave($('#dlg_calendar_name').val());
                    $('#dlg_calendar_name').val(trim($('#dlg_calendar_name').val()));
                    refreshFriendlyName();
                    params[Names.GetParamFriendlyName] = $('#dlg_calendar_friendly_name').val();
                    
                    params[Names.GetParamColor] = $('.color-selector-container .ds-color-selector-td-checked').css('background-color');
                    //params[Names.GetParamColor] = $('#dlg_colors_popup div').css('background-color');
                    
                    params[Names.GetParamObjType] = $('#dlg_object_type').val();
                    params[Names.GetParamObjName] = $('#dlg_object_name').val();
                    params[Names.GetParamEntryField] = $('#dlg_entry_label').val();
                    params[Names.GetParamGroupByField] = $('#dlg_group_by').val();
                    params[Names.GetParamStartField] = $('#dlg_entry_start').val();
                    var endField = $('#dlg_entry_end').val();
                    if (endField !== '--none--') {
                        params[Names.GetParamEndField] = endField;
                    } else {
                        params[Names.GetParamEndField] = '';
                    }
                    params[Names.GetParamVisible] = $('#dlg_visible').CheckboxGetValue();
                    params[Names.GetParamEditable] = $('#dlg_editable').CheckboxGetValue();
                    params[Names.GetParamOwnership] = $("input:radio[name='records']:checked").val();
                    params[Names.GetParamRestrictVisability] = $("input:radio[name='restricts']:checked").val();
                    params[Names.GetParamFilteradvancedSection] = $("#sf_filter_advanced").accordion("option","active");

                    var hover_result = $("#dlg_display").SortablePanelsGetResult(
                        { panel1 : 'list_of_object_fields', panel2 : 'list_of_selected_fields'} 
                    );
                    params[Names.GetParamHoverFields] = hover_result.panel2;

                    var creating_result = $("#dlg_display_on_create").SortablePanelsGetResult(
                        { panel1 : 'list_of_object_creating_fields', panel2 : 'list_of_selected_creating_fields', ReturnRequiredFields : 'true'} 
                    );
                    params[Names.GetParamCreatingFields] = creating_result.panel2;
                    params[Names.GetParamFilterset] = $('#dlg_filters').sfFilters("Serialize");
                    params[Names.GetParamFilteradvanced] = '';
                    if (params[Names.GetParamFilterset] != '') {
                        params[Names.GetParamFilteradvanced] = $('#dlg_filters').sfFilters("AdvancedFilter");
                    }

                    var groups_result = $("#groups").SortablePanelsGetResult(
                        { panel1 : 'list_of_groups', panel2 : 'list_of_selected_groups'}
                    );
                    params[Names.GetParamSelectedGroupsIDs] = groups_result.panel2;

                    var sites_result = $("#dlg_display_sites").SortablePanelsGetResult(
                        { panel1 : 'list_of_sites', panel2 : 'list_of_selected_sites'}
                    );
                    params[Names.GetParamSelectedSitesIDs] = sites_result.panel2;

                    if (validateFields()) {
                        sendActionRequest(Names.ActionCalendarSave, '', params);
                    }
                }

                $("#saveBtn").click(function(event) {
                    SaveSettings();
                });

                $("#saveBtnBot").click(function(event) {
                    SaveSettings();
                });

                function print_object(p_what, p_where) {
                    var $msg = $('#' + p_where);
                    $msg.append( " { " );
                    for(var it in p_what) {
                        if (typeof p_what[it] == 'object') {
                            $msg.append(it + " = " + print_object(p_what[it], p_where));
                        }
                        $msg.append(it + "  =  " + p_what[it] + " , ");
                    }
                    $msg.append(" } ");
                }

                //onload...

                /*$("#step1, #step2, #step3, #step4, #step5, #step6, #step7").accordion({ 
                    header: '.fcui-block-header', 
                    collapsible: true,
                    fillSpace: false,
                    autoHeight: false,
                    animated: true,
                    clearStyle: true,
                    navigation: false
                });*/

                $("#steps").accordion({
                    /*collapsible: true,*/
                    active: 0,
                    header: '.fcui-block-header' , 
                    autoHeight: false
                });

                function initCalendarDlg() {
                    $("#dlg_add_edit").dialog("destroy");
                    $("#dlg_add_edit").dialog({
                        bgiframe: true,
                        autoOpen: false,
                        width: jQuery('body').width() * 0.8,
                        height: 640,
                        modal: true,
                        buttons: {
                            'Cancel': function() {
                                $(this).dialog('close');
                                $(this).dialog('destroy');
                                return false;
                            },
                            'Save': function() {
                                SaveSettings();
                                return false;
                            }
                        }
                    });
                }

                $('#dlg_object_type').bind("change", function(event) {
                    var propsObj = {};

                    propsObj[Names.GetParamObjType] = $(this).attr('value');
                    propsObj[Names.GetParamCalID] = g_cid;
                    propsObj[Names.GetParamObjName] = $('#dlg_object_name').val();
                    propsObj[Names.GetParamStartField] = $('#dlg_entry_start').val();
                    propsObj[Names.GetParamEndField] = $('#dlg_entry_end').val();
                    propsObj[Names.GetParamFieldChanged] = Names.GetParamObjType;
					propsObj['bHideSystemObjects'] = $( '#hideObjectsBox' ).attr( 'checked' ) == 'checked';
					
                    loadingData(Names.ActionFieldChange, g_cid,propsObj); 
                });

                $( '#hideObjectsBox' ).bind( 'change', function(event) {
                    $('#dlg_object_type').trigger( "change" );
                } );

                $('#dlg_object_name').bind("change", function(event){
                    var propsObj = {};

                    propsObj[Names.GetParamObjType] = $('#dlg_object_type').val();
                    propsObj[Names.GetParamCalID] = g_cid;
                    propsObj[Names.GetParamObjName] = $(this).attr('value');
                    propsObj[Names.GetParamStartField] = $('#dlg_entry_start').val();
                    propsObj[Names.GetParamEndField] = $('#dlg_entry_end').val();
                    propsObj[Names.GetParamFieldChanged] = Names.GetParamObjName;

                    loadingData(Names.ActionFieldChange, g_cid, propsObj);
                    if ($('#dlg_object_name').val().length > 2) {
                        $('.object-name').html($('#dlg_object_name option:selected').html());
                    } else {
                        $('.object-name').html('[select object on step 2]');
                    }
                });

                $('#dlg_entry_start').bind("change", function(event){
                    calendarFormController.checkEditableCalendar();
                    return;
                
                    var propsObj = {};

                    propsObj[Names.GetParamObjType] = $('#dlg_object_type').val();
                    propsObj[Names.GetParamCalID] = g_cid;
                    propsObj[Names.GetParamObjName] = $('#dlg_object_name').val();
                    propsObj[Names.GetParamStartField] = $(this).attr('value');
                    propsObj[Names.GetParamEndField] = $('#dlg_entry_end').val();
                    propsObj[Names.GetParamFieldChanged] = Names.GetParamStartField;
                    calendarFormController.checkEditableCalendar();
                    
                    loadingData(Names.ActionFieldChange, g_cid, propsObj);
                });

                $('#dlg_entry_end').bind("change", function(event){
                    calendarFormController.checkEditableCalendar();
                    return;
                    var propsObj = {};

                    propsObj[Names.GetParamObjType] = $('#dlg_object_type').val();
                    propsObj[Names.GetParamCalID] = g_cid;
                    propsObj[Names.GetParamObjName] = $('#dlg_object_name').val();
                    propsObj[Names.GetParamStartField] = $('#dlg_entry_start').val();
                    propsObj[Names.GetParamEndField] = $(this).attr('value');
                    propsObj[Names.GetParamFieldChanged] = Names.GetParamEndField;
                    calendarFormController.checkEditableCalendar();
                    
                    loadingData(Names.ActionFieldChange, g_cid, propsObj);
                });

                $(DeleteButtonsClass).click(function(event) {
                    g_cid = $(this).attr("cid");
                    if( on_delete() ) {
                        sendActionRequest(Names.ActionCalendarDelete, g_cid);
                    }
                });

                $('.non-moveable').draggable('disable');
                
                function replaceSpecialChars(str) {
                    var i, regExp = /[^a-zA-Z0-9]/, res = '', char;
                    for (i=0; i<str.length; i++) {
                        char = str.substr(i,1);
                        if (regExp.test(char)) {
                            char = '_';
                        }
                        res += char;
                    }
                    
                    for (i=res.length-1; i>0; i--) {
                        char = res.substr(i,1);
                        if (char == '_') {
                            res = res.substr(0,i);
                        } else {
                            break;
                        }
                    }
                    return res;
                }
                
                function haveDuplicate (name,allNames) {
                    var numOfNames = 0;
                    for (i=0;i<allNames.length;i++) {
                        //if (allNames[i] == name && allNames[i] != replaceSpecialChars($('#dlg_calendar_name').val())) {
                        if (allNames[i] == name) {
                            return true;
                        }
                    }
                    
                    return false;
                }
                
                function refreshFriendlyName() {
                    var nameStr = $('#dlg_calendar_name').val();
                    var i,res = '';
                    var allNames = allCalendarsNames.split(';');
                    var isDuplicate = false;
                    
                    res = replaceSpecialChars(nameStr);
                    
                    if (initingCalendarName != nameStr) {
                        if (haveDuplicate(res,allNames)) {
                            for (i=1;;i++) {
                                var tempStr = res + '_' + i;
                                if (!haveDuplicate(tempStr,allNames)) {
                                    res = tempStr;
                                    break;
                                }
                            }
                        }
                    } else {
                        res = initingFriendlyName;
                    }
                    
                    $('#dlg_calendar_friendly_name').val(res);
                }
                
                $('#dlg_calendar_name').keyup(function () {
                    refreshFriendlyName()
                });
                $('#dlg_calendar_name').blur(function () {
                    refreshFriendlyName()
                });
                
            // ==== Initialize help system. Choose name of help section ('/help/calendar_creator/') ==== (D. Malenko) //
            $("#helpSystem").helpSystem({baseURL:'{!URLFOR($Resource.CalendarAnything, '/help/calendar_creator/')}'});
            
            // ==== Fix bug with scrollbar under iPad/Android ==== //
            $('.show-more').click(function () {
                $(this).prev().find('ul').toggleClass('more-class');
                $(this).prev().toggleClass('more-class');
                $(this).toggleClass('more-class');
                $('.show-more').html('▼');
                $('.show-more.more-class').html('▲');
                $(this).prev().find('ul').height('185px');
                $(this).prev().height('190px');
                $('ul.more-class').css('height','auto');
                $('div.more-class').css('height','auto');
            });
            $('.show-more').html('▼');
            var userag = navigator.userAgent.toLowerCase();
            var isAndroid = userag.indexOf("android") > -1;
            var isIphone = userag.indexOf('iphone') > -1;
            var isIpad = userag.indexOf('ipad') > -1;
            if (!isAndroid && !isIphone && !isIpad) {
                $('.show-more').hide();
            }
            
            // ==== Prevent adding calendar to sites if using User object in lookups ==== //
            $('.ui-block-sites-section').hide();
            setInterval(function () {
                if ($(".lookup_id")) {
                    $(".lookup_id").each(function (index,item) {
                        var prefix = $(item).val().substr(0,3);
                        if (prefix == '005' || prefix == '00g' || prefix == '00G') {
                            $('.ui-block-sites-section').show();
                            $('#list_of_selected_sites ul li').appendTo($('#list_of_sites ul'));
                            return false;
                        } else {
                            $('.ui-block-sites-section').hide();
                        }
                    });
                } else {
                    $('.ui-block-sites-section').hide();
                }
            },1000);
            
            // ==== Additional function to change style ==== //
            $('.ui-button').mouseover(function () {
                $(this).addClass('ui-state-hover');
            }).mouseout(function () {
                $(this).removeClass('ui-state-hover');
            });
        });
        
        
})(jQuery);

function ret() {
    if (getUrlParameter('retPage')) {
        window.location.href='/apex/' + getUrlParameter('retPage');
    } else {
        window.location.href="{!AjaxListPageName}";
    }
}

function changeTitle(title) {
    
    title = title == '' ? "New Calendar " : title;
    jQuery('.pbHeader .mainTitle').text(title);
}


</script>

<apex:sectionHeader title="Calendar Settings" subtitle="Edit Calendar"/>
<apex:form >
    <apex:pageBlock id="pb0" title="New calendar" mode="edit">
        <apex:pageBlockButtons location="top">
            <input id="saveBtn" type="button" value="Save" class="btn" />
            <input type="button" value="Cancel" class="btn" onclick="ret();"/>
        </apex:pageBlockButtons>

        <apex:pageBlockButtons location="bottom">
            <input id="saveBtnBot" type="button" value="Save" class="btn"/>
            <input type="button" value="Cancel" class="btn" onclick="ret();"/>
        </apex:pageBlockButtons>

        <div id="dlg_add_edit" style="width:100%; padding-right:0px; padding-left: 0px;  ">
            <div id="steps">
                <div id="step1" class="text-size" >

                    <div class="fcui-block-header">
                        <h1><a href="#">Step 1: Enter Calendar Name and Color</a></h1>
                    </div>
                    <div>
                        <table>
                            <tr>
                                <td>
                                    <span class="ca-icon" style="background: url({!URLFOR($Resource.jQuery, '/icons/create_edit_icons.png')}) no-repeat 0 0;"></span>
                                    <span class="ui-form-label">Calendar Name: </span>
                                </td>
                                <td>
                                    <input type="text" onChange="changeTitle(this.value)" name="calendar_name" maxlength="80" id="dlg_calendar_name" class="text ui-widget-content ui-corner-all" />
                                </td>
                                <td width="50px">
                                    &nbsp;
                                </td>
                                <td>
                                    <span class="ca-icon"></span>
                                    <span class="ui-form-label">SiteCalendar Name: </span>
                                </td>
                                <td>
                                    <input type="text" name="calendar_friendly_name" maxlength="80" id="dlg_calendar_friendly_name" class="text ui-widget-content ui-corner-all" disabled="disabled" />
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <span class="ca-icon" style="background: url({!URLFOR($Resource.jQuery, '/icons/create_edit_icons.png')}) no-repeat 0 -32px"></span>
                                    <span class="ui-form-label">Calendar color: </span>
                                    <div class="color-selector-container"></div>
                                    <div id="dlg_colors_popup" style="display:none;"><div></div></div>
                                </td>
                            </tr>
                        </table>
                        <div class="helpButton" id="step1" title="Help for step 1">
                            <a href="#" class="helpLink">
                                <span class="ca-help-icon"></span>
                                Help: 
                            </a>
                            Enter a name for your calendar and select a color for the calendar. The Site Calendar Name field will automatically populate.
                        </div>
                        
                    </div>
                </div>

                <div id="step2" class="text-size" >
                    <div class="fcui-block-header">
                        <h1><a href="#">Step 2: Specify Object &amp; Entry Details</a></h1>
                    </div>
                    <div>
                        <table width="100%">
                            <tr>
                                <td>
                                    <table>
                                        <tr>
                                            <td>
                                                <span class="ui-form-label">Object Type </span>        
                                            </td>
                                            <td>
                                                <select name="object_type" id="dlg_object_type"  class="text ui-widget-content ui-corner-all" >
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <span class="ui-form-label">Hide system objects</span>      
                                            </td>
                                            <td>
                                                <input id="hideObjectsBox" type="checkbox" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <span class="ui-form-label">Object Name </span>
                                            </td>
                                            <td>
                                                <select name="object_name" id="dlg_object_name"  class="text ui-widget-content ui-corner-all" >
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <span class="ui-form-label">Entry Label </span>
                                            </td>
                                            <td>
                                                <select name="entry_label" id="dlg_entry_label"  class="text ui-widget-content ui-corner-all" >
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <span class="ui-form-label">Default Gantt Grouping </span>
                                            </td>
                                            <td>
                                                <select name="group_by" id="dlg_group_by"  class="text ui-widget-content ui-corner-all" >
                                                </select>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                <td>
                                    <table>
                                        <tr>
                                            <td>
                                                <span class="ui-form-label">Entry Start </span>
                                            </td>
                                            <td>
                                                <select name="entry_start" id="dlg_entry_start"  class="text ui-widget-content ui-corner-all">
                                                </select>
                                            </td>
                                        </tr>   
                                        <tr>
                                            <td>
                                                <span class="ui-form-label">Entry End </span>
                                            </td>
                                            <td>
                                                <select name="entry_end" id="dlg_entry_end"  class="text ui-widget-content ui-corner-all" >
                                                </select>       
                                            </td>
                                        </tr>                      
                                        <tr>
                                            <td>
                                                <span class="ui-form-label">Visible </span>
                                            </td>
                                            <td align="left">
                                                <input type="checkbox" name="visible" id="dlg_visible" />
                                            </td>
                                            <td>
                                                <span class="ui-form-label">Editable </span>
                                            </td>
                                            <td align="left">
                                                <input type="checkbox" name="editable" id="dlg_editable" />
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                        <div class="helpButton" id="step2" title="Help for step 2">
                            <a href="#" class="helpLink">
                                <span class="ca-help-icon"></span>
                                Help: 
                            </a>
                            Specify the object for this calendar as well as the date fields using Entry Start and Entry End. The Visible box determines whether this calendar will appear in the left sidebar upon saving. You can control which calendars are visible and in what order they are listed in the left sidebar using the Display Settings "eye" icon on the main screen. The Editable box determines whether you can drag and drop records to different days or times, or create new records on this calendar.
                        </div>
                    </div>
                </div>

                <div id="step5" class="text-size">
                    <div class="fcui-block-header">
                        <h1><a href="#">Step 3: Specify Filter Criteria</a></h1>
                    </div>
                    <div>
                        <div id="records" style="margin:0px 2px 0px 5px;">
                            <table cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td colspan="2">
                                        <span style="font-weight:bold;">Filter By Owner </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="radio" checked="checked" id="all_records" return="all" value="all" name="records"/>
                                    </td>
                                    <td style="padding:3px 0 0 0">
                                        <label for="all_records" class="text-size">All <span class="object-name"></span></label>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="radio" id="my_records" return="my" value="my" name="records" />
                                    </td>
                                    <td style="padding:3px 0 0 0">
                                        <label for="my_records" class="text-size">My <span class="object-name"></span></label>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div id="filters" style="margin:10px 2px 2px 2px;">
                            <span><b>Filters </b></span>     
                            <div id="dlg_filters" style="width:700px;" class="ui-widget-content ui-corner-all"></div>        
                        </div>
                        <div class="helpButton" id="step3" title="Help for step 3">
                            <a href="#" class="helpLink">
                                <span class="ca-help-icon"></span>
                                Help: 
                            </a>
                            Filter through object records by adding filter criteria.
                        </div>
                    </div>
                </div>

                <div id="step3" class="text-size" >
                    <div class="fcui-block-header">
                        <h1><a href="#">Step 4: Specify Fields to Display On Hover </a></h1>
                    </div>
                    <div id="dlg_display" style="overflow:hidden;">
                        <table style="height:220px;width:95%" align="center">
                            <tr>
                                <td class="list-column">
                                    <div id="list_of_object_fields">
                                        <h5 >Available </h5>
                                        <ul class="ui-state-highlight connectedSortable" style="cursor: default;position:static; width:99%;"></ul>
                                    </div>
                                    <div class="show-more">▼</div>
                                </td>
                                <td align="center" style="padding:10px;">
                                    <div class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" id="step3_right_btn" style="width:100%;">
                                        <span class="ui-button-text">Display &gt;</span>
                                    </div><br /><br />
                                    <div class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" id="step3_left_btn" style="width:100%;">
                                        <span class="ui-button-text">&lt;Don't display</span>
                                    </div>
                                </td>
                                <td class="list-column"> 
                                    <div id="list_of_selected_fields">
                                        <h5>Selected </h5>
                                        <ul class="ui-state-highlight connectedSortable" style="cursor: default;position:static; width:99%;"></ul> 
                                    </div>
                                    <div class="show-more">▼</div>
                                </td>
                            </tr>
                        </table>    
                        <div class="helpButton" id="step4" title="Help for step 4">
                            <a href="#" class="helpLink">
                                <span class="ca-help-icon"></span>
                                Help: 
                            </a>
                            Specify the fields shown when hovering over a record.
                        </div>
                    </div>
                </div>

                <div id="step4" class="text-size">
                    <div class="fcui-block-header">
                        <h1><a href="#">Step 5: Specify Calendar Entry Edit Fields</a></h1>
                    </div>
                    <div id="dlg_display_on_create" style="overflow:hidden;">
                        <table style="height:220px;width:95%;" align="center">
                            <tr>
                                <td class="list-column">
                                    <div id="list_of_object_creating_fields">
                                        <h5 >Available fields </h5>
                                        <ul class="ui-state-highlight connectedSortable" style="cursor: default;position:static; width:99%;"></ul>
                                    </div>
                                    <div class="show-more">▼</div>
                                </td>
                                <td align="center" style="padding:10px;">
                                    <div class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" id="step4_right_btn" style="width:100%;">
                                        <span class="ui-button-text">Select &gt;</span>
                                    </div><br /><br />
                                    <div class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" id="step4_left_btn" style="width:100%;">
                                        <span class="ui-button-text">&lt;Don't select</span>
                                    </div>
                                </td>
                                <td class="list-column">
                                    <div id="list_of_selected_creating_fields">
                                        <h5>Selected fields </h5>
                                        <ul class="ui-state-highlight connectedSortable" style="cursor: default;position:static; width:99%;"></ul> 
                                    </div>
                                    <div class="show-more">▼</div>
                                </td>
                            </tr>
                        </table>    
                        <div class="helpButton" id="step5" title="Help for step 5">
                            <a href="#" class="helpLink">
                                <span class="ca-help-icon"></span>
                                Help: 
                            </a>
                            Specify the fields that are displayed when a user tries to create a record. Any fields already in the Selected box bordered with RED are required fields from the object. 
                        </div>
                    </div>
                </div>

                <div id="step6" class="text-size" >
                    <div class="fcui-block-header">
                        <h1><a href="#">Step 6: Restrict Visibility</a></h1>
                    </div>
                    <div>
                        <div id="restricts" style="margin:0px 2px 10px 5px;">
                            <table cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td><input type="radio" id="restricts_me" return="me" value="me" name="restricts" /></td>
                                    <td style="padding:3px 0 0 0"><label for="restricts_me" class="text-size">Visible only to me</label></td>
                                    <td><input type="radio" id="restricts_selected" return="selected" value="selected" name="restricts"/></td> 
                                    <td style="padding:3px 0 0 0"><label for="restricts_selected" class="text-size">Visible to certain groups of user</label></td>
                                </tr>
                            </table>
                        </div>
                        <div id="groups" style="overflow:hidden;">
                            <table style="height:220px;width:95%;" align="center">
                                <tr>
                                    <td class="list-column">
                                        <div id="list_of_groups">
                                            <h5 >Available </h5>
                                            <ul class="ui-state-highlight connectedGroups" style="cursor: default;position:static; width:99%;"></ul>
                                        </div>
                                        <div class="show-more">▼</div>
                                    </td>
                                    <td align="center" style="padding:10px;">
                                        <div class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" id="step6_right_btn" style="width:100%;">
                                            <span class="ui-button-text">Select &gt;</span>
                                        </div><br /><br />
                                        <div class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" id="step6_left_btn" style="width:100%;">
                                            <span class="ui-button-text">&lt;Don't select</span>
                                        </div>
                                    </td>
                                    <td class="list-column">
                                        <div id="list_of_selected_groups">
                                            <h5>Selected </h5>
                                            <ul class="ui-state-highlight connectedGroups" style="cursor: default;position:static; width:99%;"></ul> 
                                        </div>
                                        <div class="show-more">▼</div>
                                    </td>
                                </tr>
                            </table>    
                        </div>
                        <div class="helpButton" id="step6" title="Help for step 6">
                            <a href="#" class="helpLink">
                                <span class="ca-help-icon"></span>
                                Help: 
                            </a>
                            Restrict visibility of the calendar using Public Groups in your org setup. Only members of selected groups will have access to this calendar. 
                        </div>
                    </div>
                </div>
                

                <div id="step7" class="text-size" >
                    <div class="fcui-block-header">
                        <h1><a href="#">Step 7: Specify Sites to Display Calendar</a></h1>
                    </div>
                    <div id="dlg_display_sites" style="overflow:hidden;">
                        <div class="no_show ui-block-sites-section"></div>
                        <table style="height:220px;width:95%" align="center" class="no_show">
                            <tr>
                                <td class="list-column">
                                    <div id="list_of_sites">
                                        <h5 >Available </h5>
                                        <ul class="ui-state-highlight connectedSites" style="cursor: default;position:static; width:99%;"></ul>
                                    </div>
                                    <div class="show-more">▼</div>
                                </td>
                                <td align="center" style="padding:10x;">
                                    <div class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" id="step7_right_btn" style="width:100%;">
                                        <span class="ui-button-text">Select &gt;</span>
                                    </div><br /><br />
                                    <div class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" id="step7_left_btn" style="width:100%;">
                                        <span class="ui-button-text">&lt;Don't select</span>
                                    </div>
                                </td>
                                <td class="list-column"> 
                                    <div id="list_of_selected_sites">
                                        <h5>Selected </h5>
                                        <ul class="ui-state-highlight connectedSites" style="cursor: default;position:static; width:99%;"></ul> 
                                    </div>
                                    <div class="show-more">▼</div>
                                </td>
                            </tr>
                        </table>    
                        <div class="no_show helpButton" id="step7" title="Help for step 7">
                            <a href="#" class="helpLink">
                                <span class="ca-help-icon"></span>
                                Help: 
                            </a>
                            Specify the Salesforce sites that can be used to display a read-only version of this calendar.
                        </div>
                        <div class="sites_not_avaible">No sites avaible</div>
                    </div>
                </div>
            </div>
        </div>

    </apex:pageBlock>
</apex:form>
<div id="helpSystem"></div>

</apex:page>