<apex:page standardController="BTGCDA__CallDownStrategy__c" extensions="BTGCDA.CallDownReportController" docType="html-5.0" sidebar="false">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"/>
    <apex:includeScript value="{!URLFOR($Resource.BTGCDA__CallDownResources, 'CallDownResources/bootstrap-3.0.2/js/bootstrap.min.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.BTGCDA__CallDownResources, 'CallDownResources/bootstrap-3.0.2/css/bootstrap-btg-force.css')}"/>
    <apex:includeScript value="{!URLFOR($Resource.BTGCDA__CallDownResources, 'CallDownResources/chart/Chart.min.js')}"/>
    <style>
    	.btg-force a {color: #015ba7; text-decoration: none;}
    	
    	<apex:outputPanel layout="none" rendered="{!$Setup.CallDownSettings__c.Theme__c == 'Gray'}" id="grayTheme">      
        	/* Gray Theme */  
	       	.btg-force .panel-strategy{border-color: #aaaaaa;margin-bottom: 10px !important;border-top: 3px solid #015ba7;}
	        .btg-force .panel-strategy > .panel-heading {color: #000000;background-color: #f5f5f5;border-color: #aaaaaa;padding: 5px 10px !important;}        
        </apex:outputPanel>
                
        <apex:outputPanel layout="none" rendered="{!$Setup.CallDownSettings__c.Theme__c == null || $Setup.CallDownSettings__c.Theme__c == 'Blue'}" id="colorTheme">    
        	/* Blue Theme */
	        .btg-force .panel-strategy{border-color: #015ba7;border-width: 1px;margin-bottom: 5px !important;}
	        .btg-force .panel-strategy > .panel-heading a{color: #FFFFFF;}
	        .btg-force .panel-strategy > .panel-heading{color: #FFFFFF;background-color: #015ba7;border-color: #015ba7;padding: 5px 10px !important;}
         </apex:outputPanel>
        
        .btg-force .panel-body{padding: 5px !important;}
        
        .contact-legend{display:inline-block; background-color:#56458c; width: 13px; height: 13px; margin-right: 2px;}
        .lead-legend{display:inline-block; background-color:#e39321; width: 13px; height: 13px; margin-right: 2px;}
        .abandoned-legend{display:inline-block; background-color:#d9534f; width: 13px; height: 13px; margin-right: 2px;}
        .successful-legend{display:inline-block; background-color:#5cb85c; width: 13px; height: 13px; margin-right: 2px;}
        .completed-legend{display:inline-block; background-color:#ffff00; width: 13px; height: 13px; margin-right: 2px;}
        
        .btg-force .progress {margin-bottom: 0px;}
        .btg-force .progress-bar-warning {background-color: #ffff00;}
        
        .strategy-details-table {width: 100%;}
        .strategy-details-table tr td { padding: 5px;}
        .label-column {text-align: right;}
        
        .btg-force .badge-success {background-color: #5cb85c;}
        .btg-force .data-row{padding: 1px;}
        
        .overlay {position: fixed; top: 0; left: 0; height: 100%; width: 100%; z-index: 10; background-color: rgba(0,0,0,0.5);}
        .white-box{width: 200px; height: 100px; position: fixed; top: 50%; left: 50%; margin-top: -100px; margin-left: -150px; background-color: #FFFFFF; border-radius: 5px; text-align: center; z-index: 11;}
    	.white-box img{width: 75px;}
    </style>
    <div id="overlay" style="display: none;">
        <div class="overlay">
        </div>
        <div class="white-box">
            <img src="{!URLFOR($Resource.CallDownResources, 'CallDownResources/Loading_Animation.gif')}" alt="Loading" />
            <div>
            	<strong>Loading</strong>
            </div>
        </div>
    </div>
    <apex:outputPanel id="accessErrorPnl" layout="block" styleClass="btg-force" rendered="{!NOT(hasAccess)}">
	<div class="row">
		<div class="col-md-12"> 
			<h4>Permission Issues</h4>
			 <div class="alert alert-{!messageType}">
                 <apex:outputText value="{!message}" />
             </div>
             <h5>Object and Field Permissions Needed</h5>
             <table class="table table-striped table-condensed table-bordered">
             	<tr>
             		<th>Object</th>
             		<th>Field</th>
             		<th>Permission Type</th>
             	</tr>
             	<tr>
             		<td><strong>Account</strong></td>
             		<td></td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>ID</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Name</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td><strong>Lead</strong></td>
             		<td></td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>ID</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Name</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>First Name</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Last Name</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Company</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Phone</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td><strong>Contact</strong></td>
             		<td></td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>ID</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Name</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>First Name</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Last Name</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Account Id</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Phone</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td><strong>Campaign</strong></td>
             		<td></td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>ID</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Name</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Owner</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td><strong>Campaign Member</strong></td>
             		<td></td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>ID</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Contact Id</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Lead Id</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>Campaign Id</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td><strong>Call Down Strategy</strong></td>
             		<td></td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>All Fields</td>
             		<td>Read</td>
             	</tr>             	
             	<tr>
             		<td><strong>Call Down Attempt</strong></td>
             		<td></td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>All Fields</td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td><strong>Call Down Attempt Result</strong></td>
             		<td></td>
             		<td>Read</td>
             	</tr>
             	<tr>
             		<td></td>
             		<td>All Fields</td>
             		<td>Read</td>
             	</tr>
             </table>
		</div>
	</div>	
</apex:outputPanel>
  <apex:outputPanel id="reportPnl" layout="block" styleClass="btg-force" rendered="{!hasAccess}">
    	<div class="row" style="margin-bottom: 5px;">
    		<div class="col-md-12 clearfix">
    			<div class="pull-left">
    				<strong>Report for {!strategy.Campaign__r.Name} - {!strategy.Name}</strong>
    			</div>
                <div class="pull-right">
                	<strong>Quick Links: </strong>
               		 <span style="display: {!IF(strategy == null, 'none', 'inline')}"><a href="/{!strategy.BTGCDA__Campaign__c}" target="_blank">Campaign Details</a> | <a href="/{!strategy.Id}" target="_blank">Strategy Details</a> | </span>
               		 <a href="#" target="_blank">Help</a>
                </div> 
    		</div>
    	</div>
        <div class="row header-row">
            <div class="col-md-12">
                <div class="panel panel-strategy">
                    <div class="panel-heading">
                    	<h5>Overview</h5>
                    </div>
                    <div class="panel-body"> 
                    	<table class="strategy-details-table">
                                <tr>
                                    <td class="label-column" width="7%"><strong>Start Date</strong></td>
                                    <td width="5%">
                                        <apex:outputText value="{0,date,MM/dd/yyyy}">
                                            <apex:param value="{!strategy.BTGCDA__StartDate__c}" />
                                        </apex:outputText>
                                    </td>
                                    <td class="label-column clearfix" width="15%">
                                        <div class="pull-right">
                                            <strong>Contacts</strong>
                                        </div>
                                        <div class="contact-legend pull-right">&nbsp;</div>
                                    </td>
                                    <td width="5%">{!strategy.ContactsCount__c}</td>
                                    
                                    <td class="label-column" width="15%"><strong>Progress</strong></td>
                                    <td colspan="7">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-success" style="width: {!strategy.SuccessfulPercentage__c}%">
                                            </div>
                                            <div class="progress-bar progress-bar-warning" style="width: {!strategy.CompletedPercentage__c}%">
                                            </div>                                                       
                                            <div class="progress-bar progress-bar-danger" style="width: {!strategy.AbandonedPercentage__c}%">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="label-column"><strong>End Date</strong></td>
                                    <td>
                                        <apex:outputText value="{0,date,MM/dd/yyyy}">
                                            <apex:param value="{!strategy.BTGCDA__EndDate__c}" />
                                        </apex:outputText>
                                    </td>
                                    <td class="label-column">
                                        <div class="pull-right">
                                            <strong>Leads</strong>
                                        </div>
                                        <div class="lead-legend pull-right">&nbsp;</div>
                                    </td>
                                    <td>{!strategy.LeadsCount__c}</td>
                                    <td class="label-column" width="15%">
                                    	<strong>In Progress</strong>                                          
                                    </td>
                                    <td width="5%">
                                    	<apex:outputText value="{!strategy.BTGCDA__MembersCount__c - (strategy.BTGCDA__AbandonedAttemptResults__c + strategy.BTGCDA__SuccessfulAttemptResults__c + strategy.BTGCDA__CompletedAttempts__c)}"/>
                                    </td>
                                    <td class="label-column clearfix">
                                        <div class="pull-right">
                                            <strong>Successful</strong>
                                        </div>
                                        <div class="successful-legend pull-right">&nbsp;</div>  
                                    </td>
                                    <td width="5%">
                                    	{!strategy.SuccessfulAttemptResults__c}
                                    </td>
                                    <td class="label-column">
                                        <div class="pull-right">
                                            <strong>Completed Members</strong>
                                        </div>
                                        <div class="completed-legend pull-right">&nbsp;</div> 
                                    </td>
                                    <td>
                                        {!strategy.CompletedAttempts__c}
                                    </td>
                                    <td class="label-column">
                                        <div class="pull-right">
                                            <strong>Abandoned Members</strong>
                                        </div>
                                        <div class="abandoned-legend pull-right">&nbsp;</div>
                                    </td>
                                    <td>{!strategy.AbandonedAttemptResults__c}</td>
                                </tr>
                             </table>
                           
                	</div>
            	</div>
        	</div>
        </div>   
        <div class="row">
            <div class="col-md-12">
               <div class="panel panel-strategy">
	               <div class="panel-heading">
	               		<h5>All Attempts</h5>
	               </div>
               	   <div class="panel-body"> 
				        <div class="row">
				            <div class="col-sm-4">
				                <div class="row data-row">
				                    <div class="col-sm-9">
				                        <span>Morning Attempts</span> 
				                    </div>
				                    <div class="col-sm-3">
				                        <span class="badge pull-right">{!resultSummary.morningAttempts}</span>
				                    </div>
				                </div>
				                <div class="row data-row">
				                    <div class="col-sm-9">
				                        <span>Successful Morning Attempts</span> 
				                    </div>
				                    <div class="col-sm-3">
				                        <span class="badge badge-success pull-right">{!resultSummary.successfulMorningAttempts}</span>
				                    </div>
				                </div>
				                <div class="row data-row">
				                    <div class="col-sm-9">
				                        <span>Afternoon Attempts</span> 
				                    </div>
				                    <div class="col-sm-3">
				                        <span class="badge pull-right">{!resultSummary.afternoonAttempts}</span>
				                    </div>
				                </div>
				                <div class="row data-row">
				                    <div class="col-sm-9">
				                        <span>Successful Afternoon Attempts</span> 
				                    </div>
				                    <div class="col-sm-3">
				                        <span class="badge badge-success pull-right">{!resultSummary.successfulAfternoonAttempts}</span>
				                    </div>
				                </div>
				                <div class="row data-row">
				                    <div class="col-sm-9">
				                        <span>Evening Attempts</span> 
				                    </div>
				                    <div class="col-sm-3">
				                        <span class="badge pull-right">{!resultSummary.eveningAttempts}</span>
				                    </div>
				                </div>
				                <div class="row data-row">
				                    <div class="col-sm-9">
				                        <span>Successful Evening Attempts</span> 
				                    </div>
				                    <div class="col-sm-3">
				                        <span class="badge badge-success pull-right">{!resultSummary.successfulEveningAttempts}</span>
				                    </div>
				                </div>
				                <div class="row data-row">
				                    <div class="col-sm-9">
				                        <label>Total Attempts</label> 
				                    </div>
				                    <div class="col-sm-3">
				                        <span class="badge pull-right">{!resultSummary.totalAttempts}</span>
				                    </div>
				                </div>
				                <div class="row data-row">
				                    <div class="col-sm-9">
				                        <label>Total Successful Attempts</label> 
				                    </div>
				                    <div class="col-sm-3">
				                        <span class="badge badge-success pull-right">{!resultSummary.totalSuccessfulAttempts}</span>
				                    </div>
				                </div>
				            </div>
				            <div class="col-sm-8">
				                <div class="pull-center">
				                    <canvas id="attemptsChart" width="400" height="250"></canvas>
				                </div>
				            </div>
				        </div>
				   </div>
			  </div>
        	</div>
        </div>
        <apex:repeat value="{!resultTypes}" var="at">
         <div class="row">
            <div class="col-md-12">
               <div class="panel panel-strategy">
	               <div class="panel-heading">
                    <h5>{!at.name}</h5> 
                </div>
           		<div class="panel-body"> 
		              <div class="row">
		                <div class="col-sm-4">                  
		                <div class="row data-row">
		                    <div class="col-sm-9">
		                        <span>Morning Attempts</span> 
		                    </div>
		                    <div class="col-sm-3">
		                        <span class="badge pull-right">{!at.morningAttempts}</span>
		                    </div>
		                </div>
		                <div class="row data-row">
		                    <div class="col-sm-9">
		                        <span>Successful Morning Attempts</span> 
		                    </div>
		                    <div class="col-sm-3">
		                        <span class="badge badge-success pull-right">{!at.successfulMorningAttempts}</span>
		                    </div>
		                </div>
		                <div class="row data-row">
		                    <div class="col-sm-9">
		                        <span>Afternoon Attempts</span> 
		                    </div>
		                    <div class="col-sm-3">
		                        <span class="badge pull-right">{!at.afternoonAttempts}</span>
		                    </div>
		                </div>
		                <div class="row data-row">
		                    <div class="col-sm-9">
		                        <span>Successful Afternoon Attempts</span> 
		                    </div>
		                    <div class="col-sm-3">
		                        <span class="badge badge-success pull-right">{!at.successfulAfternoonAttempts}</span>
		                    </div>
		                </div>
		                <div class="row data-row">                  
		                    <div class="col-sm-9">
		                        <span>Evening Attempts</span> 
		                    </div>
		                    <div class="col-sm-3">
		                        <span class="badge pull-right">{!at.eveningAttempts}</span>
		                    </div>
		                </div>
		                <div class="row data-row">
		                    <div class="col-sm-9">
		                        <span>Successful Evening Attempts</span> 
		                    </div>
		                    <div class="col-sm-3">
		                        <span class="badge badge-success pull-right">{!at.successfulEveningAttempts}</span>
		                    </div>
		                </div>
		                <div class="row data-row">
		                    <div class="col-sm-9">
		                        <label>Total Attempts</label> 
		                    </div>
		                    <div class="col-sm-3">
		                        <span class="badge pull-right">{!at.totalAttempts}</span>
		                    </div>
		                </div>
		                <div class="row data-row">
		                    <div class="col-sm-9">
		                        <label>Total Successful Attempts</label> 
		                    </div>
		                    <div class="col-sm-3">
		                        <span class="badge badge-success pull-right">{!at.totalSuccessfulAttempts}</span>
		                    </div>
		                </div>
		            </div>
		            <div class="col-sm-8">
		                <div class="pull-center">
		                    <canvas id="{!at.attemptId}" width="400" height="250"></canvas>
		                </div>
		            </div>
		            </div>
	         	</div>
	       	</div>
	      	</div>
	     </div>
        </apex:repeat>
        <div class="row header-row">
            <div class="col-md-12">
                <div class="panel panel-strategy" id="pnlMembers">
                    <div class="panel-heading clearfix">
                    	<h5><a data-toggle="collapse" data-parent="#pnlMembers" href="#collapseMembers" style="color: inherit;">Strategy Members</a></h5>
                    </div>
                    <div id="collapseMembers" class="panel-collapse collapse in">
	                    <div class="panel-body">
	                    	<apex:outputPanel id="outMembers">
	                    	<apex:form id="formMembers">
		                    	<table class="table table-hover table-condensed">
		                    		<thead>
			                    		<tr>
			                    			<th>
			                    				<apex:commandLink id="lnkFirst" rerender="outMembers" value="First Name" action="{!sortMembers}" onclick="displayOverlay();" oncomplete="hideOverlay();" > 
	                                                  <apex:param value="FirstName" assignTo="{!newSortColumn}"/>
	                                            </apex:commandLink>
	                                        </th>
			                    			<th>
												<apex:commandLink id="lnkLast" rerender="outMembers" value="Last Name" action="{!sortMembers}" onclick="displayOverlay();" oncomplete="hideOverlay();"> 
	                                                  <apex:param value="LastName" assignTo="{!newSortColumn}"/>
	                                            </apex:commandLink>
											</th>
			                    			<th>
												<apex:commandLink id="lnkCompany" rerender="outMembers" value="Company" action="{!sortMembers}" onclick="displayOverlay();" oncomplete="hideOverlay();"> 
	                                                  <apex:param value="Company" assignTo="{!newSortColumn}"/>
	                                            </apex:commandLink>
											</th>
			                    			<th>
												<apex:commandLink id="lnkNumbAttempt" rerender="outMembers" value="Number of Attempts" action="{!sortMembers}" onclick="displayOverlay();" oncomplete="hideOverlay();"> 
	                                                  <apex:param value="Attempt" assignTo="{!newSortColumn}"/>
	                                            </apex:commandLink>
											</th>
			                    			<th>
			                    				<apex:commandLink id="lnkAttemptType" rerender="outMembers" value="Last Attempt" action="{!sortMembers}" onclick="displayOverlay();" oncomplete="hideOverlay();"> 
	                                                  <apex:param value="LastAttemptType" assignTo="{!newSortColumn}"/>
	                                            </apex:commandLink>
	                                        </th>
			                    			<th>
			                    				<apex:commandLink id="lnkAttemptDate" rerender="outMembers" value="Last Attempt Date" action="{!sortMembers}" onclick="displayOverlay();" oncomplete="hideOverlay();"> 
	                                                  <apex:param value="LastAttemptDate" assignTo="{!newSortColumn}"/>
	                                            </apex:commandLink>
	                                        </th>
			                    			<th>
			                    				<apex:commandLink id="lnkAttemptResult" rerender="outMembers" value="Last Attempt Result" action="{!sortMembers}" onclick="displayOverlay();" oncomplete="hideOverlay();"> 
	                                                  <apex:param value="LastAttemptResult" assignTo="{!newSortColumn}"/>
	                                            </apex:commandLink>
	                                        </th>
			                    		</tr>
			                    	</thead>
			                    	<tbody>
			                    		
				                    		<apex:repeat value="{!members}" var="m" id="rptMembers">
				                    			<tr>
					                    			<td class="clearfix">
					                    				<div class="{!IF(m.IsLead,'contact','lead')}-legend pull-left">&nbsp;</div>
					                    				<div class="pull-left">		                         				
					                    					{!m.firstName}				                    					
					                         			</div>
					                    			</td>
					                    			<td>{!m.lastName}</td>
					                    			<td>{!m.company}</td>
					                    			<td>{!m.numberOfAttemptResults}</td>
					                    			<td>{!m.lastAttemptResult.Type__c}</td>
					                    			<td><apex:outputText value="{0,date,EEE MMM dd, yyyy 'at' hh:mm a }">
													       <apex:param value="{!m.lastAttemptResultLocalDate}" /> 
													    </apex:outputText>
													</td>
					                    			<td>{!m.lastAttemptResult.BTGCDA__Result__c}</td>
					                    		</tr>
				                    		</apex:repeat>
				                    	
			                    	</tbody>
		                    	</table>
		                    </apex:form>
		                    </apex:outputPanel>
	                    </div>
                    </div>
                </div>
            </div>
        </div>
	</apex:outputPanel>
    
    
    <script type="text/javascript">
        var data = {
                        labels : ["Morning","Afternoon","Evening", "All"],
                        datasets : [
                            {
                                fillColor : "rgba(153,153,153,1)",
                                strokeColor : "rgba(153,153,153,1)",
                                data : [{!resultSummary.morningAttempts},{!resultSummary.afternoonAttempts},{!resultSummary.eveningAttempts},{!resultSummary.totalAttempts}]                                
                            },
                            {
                                fillColor : "rgba(92,184,92,1)",
                                strokeColor : "rgba(92,184,92,1)",
                                data : [{!resultSummary.successfulMorningAttempts},{!resultSummary.successfulAfternoonAttempts},{!resultSummary.successfulEveningAttempts},{!resultSummary.totalSuccessfulAttempts}]
                            }
                        ]
                    };
         var options = {
         					scaleOverride: true,
         					scaleSteps: 10,
         					scaleStepWidth: {!scaleStepWidth},
         					scaleStartValue: 0	
        	 		   };           
        
        //Get context with jQuery - using jQuery's .get() method.
        var ctx = $("#attemptsChart").get(0).getContext("2d");
        //This will get the first returned node in the jQuery collection.
        var myNewChart = new Chart(ctx).Bar(data, options);  
        
        <apex:repeat value="{!resultTypes}" var="at">
            new Chart($("#{!at.attemptId}").get(0).getContext("2d")).Bar({
                        labels : ["Morning","Afternoon","Evening", "All"],
                        datasets : [
                            {
                                fillColor : "rgba(153,153,153,1)",
                                strokeColor : "rgba(153,153,153,1)",
                                data : [{!at.morningAttempts},{!at.afternoonAttempts},{!at.eveningAttempts},{!at.totalAttempts}]                                
                            },
                            {
                                fillColor : "rgba(92,184,92,1)",
                                strokeColor : "rgba(92,184,92,1)",
                                data : [{!at.successfulMorningAttempts},{!at.successfulAfternoonAttempts},{!at.successfulEveningAttempts},{!at.totalSuccessfulAttempts}]
                            }
                        ]
                    }, options          
            );
        </apex:repeat>
        
        function displayOverlay()
    	{
            $("#overlay").attr('style','display: block;');
        }
    
    	function hideOverlay()
    	{
            $("#overlay").attr('style','display: none;');
        }
    </script>
</apex:page>