<apex:page sidebar="false" controller="EDP1.ProspectDiscover" standardStylesheets="true" id="LdMngrPage" tabStyle="ProspectDiscover__tab" title="Eloqua Discover">

<script type="text/javascript">
    var __sfdcSessionId = '{!GETSESSIONID()}';
</script>

<script src="../../soap/ajax/19.0/connection.js" type="text/javascript" ></script>
 
<apex:stylesheet value="{!URLFOR($Resource.EDP1__All, 'js/fancybox/jquery.fancybox-1.3.1.css')}"/>
<apex:includeScript value="{!URLFOR($Resource.EDP1__All, 'js/jquery-1.4.2.min.js')}" />
<apex:includeScript value="{!URLFOR($Resource.EDP1__All, 'js/fancybox/jquery.fancybox-1.3.1.pack.js')}" />


<!-- -----------------------------------------------------------------------
* Styles used by the RaisedBuySignal mouse-over pop-ups 
* -------------------------------------------------------------------------- -->
<style type="text/css">
/* Manual addtion of the spring '12 tab styling (alj 06/06/12) */

body .tabsNewBar .tabNavigation {
    position:relative;
    background: transparent url('{!URLFOR($Resource.EDP1__Tab, 'tabbar_sprite.png')}') left -73px repeat-x;
    margin: 0 5px;
    padding: 3px 0 0;
}

body .tabsNewBar .tabNavigation .tabBarLeft{
    background: transparent url('{!URLFOR($Resource.EDP1__Tab, 'tabbar_sprite.png')}') no-repeat;
    width:15px;
    height:100%;
    position:absolute;
    left:-15px;
    top:0;
}
body .tabsNewBar .tabNavigation .tabBarRight{
    background: transparent url('{!URLFOR($Resource.EDP1__Tab, 'tabbar_sprite.png')}') -15px 0 no-repeat;
    width:15px;
    height:100%;
    position:absolute;
    right:-15px;
    top:0;
}
body .tabsNewBar .tabNavigation .tab{
    height:25px;
}
body .tab td,
body .tab td div,
body .tab .last div{
    background-image: none;
    background-repeat: no-repeat;
}
body .tab td {
    padding-left: 0;
    border: none;
}
body .tabNavigation .tab td div {
    padding: 7px 10px;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 1.18em;
    font-weight: bold;
    color: #4b4b57;
    max-height: 15px;
}
body .tabNavigation .tab a{
    color:#353535;
}
body .tabNavigation .tab a:hover{
    color:#1468b6;
}
body .tabNavigation .tab .currentTab {
    background-image: url('{!URLFOR($Resource.EDP1__Tab, 'tabs_sprite.png')}');
    background-repeat:no-repeat;
    background-position:left 0;
}
body .tabNavigation .tab .currentTab div{
    background-image: url('{!URLFOR($Resource.EDP1__Tab, 'tabs_sprite.png')}');
    background-repeat:no-repeat;
    background-position: right -150px;
}
body .tabNavigation .tab .currentTab a{
    color:#fff;
}
.tabNavigation .allTabsArrow,
.tabMenu .allTabsArrow{
    background-image: url('{!URLFOR($Resource.EDP1__Tab, 'addTabs.png')}');
    width:12px;
    height:12px;
}
body .tabNavigation .tab a:hover .allTabsArrow,
body .tabMenu a:hover .allTabsArrow{
    background-position: left -14px;
}
body.allTabTab .tabNavigation .tab .allTabsArrow,
body.allTabTab .tabNavigation .tab a:hover .allTabsArrow,
body.allTabTab .tabMenu .allTabsArrow,
body.allTabTab .tabMenu a:hover .allTabsArrow {
    margin-bottom:-2px;
    background-position: left -29px;
}


.lookupHoverDetail .topLeft,
.lookupHoverDetail .topRight,
.lookupHoverDetail .bottomLeft,
.lookupHoverDetail .bottomRight{
    background: transparent url('{!URLFOR($Resource.EDP1__All, 'hover_sprite_buysignalpopup.png')}') 0 -29px no-repeat;
    padding: 3px 6px 10px;
    height: auto;
    width: auto;
    padding-left: 10px;
    overflow: hidden;
}
.lookupHoverDetail .bPageBlock .pbFooter {
    background: transparent url('{!URLFOR($Resource.EDP1__All, 'hover_sprite_buysignalpopup.png')}') 0 -0 no-repeat;
    bottom: -14px;
    display: block;
    height: 14px;
    position: absolute;
    width: 100%;
    left: 0;
}
.lookupHoverDetail .bPageBlock .pbTitle h2 {
    width: 100%;
    overflow: hidden;
}
.lookupHoverDetail.individualPalette .bPageBlock .pbBody {
    max-height:420px;
}
</style>

<!-- BELOW IS STANDARD CSS COPIED TO MAKE THIS WORK IN THE OLD UI  -->
<apex:outputPanel rendered="{!$User.UIThemeDisplayed != 'Theme3'}">
<style>
.lookupHoverDetail .bPageBlock .pbHeader{
    border-style: solid;
    border-width: 3px 0 0;
    -moz-border-radius: 4px;
    -webkit-border-radius: 3px;
}
.lookupHoverDetail .bPageBlock .pbBody{
    background: white none;
    padding: 0;
    margin: 0 11px;
    height: auto;
    width: auto;
}
.lookupHoverDetail .pbHeader .pbTitle h2.mainTitle{
    color: #333435;
    font-size: 1.3em;
}
body .lookupHoverDetail .bPageBlock .pbHeader .pbTitle{
    width: 38%;
}
body .lookupHoverDetail .bPageBlock .pbHeader .pbButton{
    text-align: left;
}
body .lookupHoverDetail .pbHeader .pbButton input:first-child{
    margin-right: 5px;
}
body .lookupHoverDetail .bPageBlock .detailList .labelCol,
body .lookupHoverDetail .bPageBlock .detailList .dataCol{
    border-color: #ececec;
}
.lookupHoverDetail{
    height: auto;
    width: auto;
}
body .lookupHoverDetail.individualPalette > div > .bPageBlock{
    background: transparent;
    border: 0;
    width: 370px;
    height: auto;
}
.lookupHoverDetail.individualPalette .bPageBlock .pbHeader{
    padding: 3px 9px 0 7px;
}
/* .lookupHoverDetail .topLeft,
.lookupHoverDetail .topRight,
.lookupHoverDetail .bottomLeft,
.lookupHoverDetail .bottomRight{
    background: transparent url(/img/sprites/hover_sprite.png) 0 -29px no-repeat;
    padding: 3px 6px 10px;
    height: auto;
    width: auto;
} */
.lookupHoverDetail .bottomRight,
.lookupHoverDetail .bottomLeft{
    margin-top: -6px;
}
.lookupHoverDetail.individualPalette .topLeft{
    background-position: 24px -29px;
    margin-left: 15px;
    margin-top: -2px;
}
.lookupHoverDetail.individualPalette .topLeft .bPageBlock{
    background: transparent url(/img/alohaSkin/hover_lookup_tl.png) 0 10px no-repeat;
    padding-left: 24px;
}
.lookupHoverDetail.individualPalette .topLeft .pbFooter{
    left: 39px;
}
.lookupHoverDetail.individualPalette .topRight{
    margin-left: -25px;
    margin-top: -2px;
}
.lookupHoverDetail.individualPalette .topRight .bPageBlock{
    background: transparent url(/img/alohaSkin/hover_lookup_tr.png) right 10px no-repeat;
    padding-right: 24px;
}
.lookupHoverDetail.individualPalette .topRight .pbFooter{
    left: -25px;
}
.lookupHoverDetail.individualPalette .bottomRight .pbFooter .bg,
.lookupHoverDetail.individualPalette .bottomLeft .pbFooter .bg{
    background: transparent url(/img/alohaSkin/hover_lookup_bottom.png) no-repeat;
    position: absolute;
    width: 33px;
    height: 26px;
    bottom: -17px;
}
.lookupHoverDetail.individualPalette .bottomRight .pbFooter .bg{
    right: 45px;
}
.lookupHoverDetail.individualPalette .bottomLeft .pbFooter .bg{
    left: 30px;
}
.lookupHoverDetail.lookupHoverDetailLoading .bPageBlock .pbBody{
    padding: 19px 0 11px 24px;
    background: url(/img/loading.gif) 0 17px no-repeat;
}
.lookupHoverDetail.lookupHoverDetailLoading .bottomRight,
.lookupHoverDetail.lookupHoverDetailLoading .bottomLeft{
    margin-top: 180px;
}
</style>
</apex:outputPanel>

<style type="text/css">
#aniloader-animation {
  background: url("{!URLFOR($Resource.EDP1__All, 'ajax-loader1.gif')}") no-repeat center center;
  height:40px;
  width: 40px;
}
#aniloader-bg {
    background-color: #666;
    opacity: .6;
    margin-top: -2px;
}

.activitiesColumn {
    text-align: right;
    padding-right: 6px !important;
}

.accountSmallIcon {
    background-image: url('/img/sprites/master.png');
    background-position: 0px -1px;
    height: 16px;
    width: 16px;
}

.contactSmallIcon {
    background-image: url('/img/sprites/master.png');
    background-position: 0px -82px;
    height: 16px;
    width: 16px;
}

.leadSmallIcon {
    background-image: url('/img/sprites/master.png');
    background-position: 0px -200px;
    height: 16px;
    width: 16px;
}

.contactLargeIcon {
    background-image: url('/img/sprites/master.png');
    background-position: 0px -502px;
    height: 24px;
    width: 24px;
}

.leadLargeIcon {
    background-image: url('/img/sprites/master.png');
    background-position: 0px -698px;
    height: 24px;
    width: 24px;
}

.tableCell {
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12px;
    padding-right: 10px;
    white-space: nowrap;
}

.urgency0 {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -179px;
    height: 24px;
    width: 56px;
}
.urgency1 {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -202px;
    height: 24px;
    width: 56px;
}
.urgency2 {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -227px;
    height: 24px;
    width: 56px;
}
.urgency3 {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -251px;
    height: 24px;
    width: 56px;
}


.interest0 {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -274px;
    height: 24px;
    width: 56px;
}
.interest1 {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -299px;
    height: 24px;
    width: 56px;
}
.interest2 {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -324px;
    height: 24px;
    width: 56px;
}
.interest3 {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -348px;
    height: 24px;
    width: 56px;
}


.opportunityName {
   text-overflow:ellipsis;
   width: 100px;
}
.ignore {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -129px;
    height: 24px;
    width: 24px;  
}
.unignore {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -154px;
    height: 24px;
    width: 24px;  
}

.tracked {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px -26px;
    height: 24px;
    width: 24px;
}
.untracked {
    background-image: url('{!URLFOR($Resource.EDP1__All, 'icons.png')}');
    background-position: 0px 0px;
    height: 24px;
    width: 24px;
}

.myTabContent {
    display: none;
}
.opportunityField {
    padding-bottom: 6px;
}
.rowHeaderClass {
    height: 27px;
}

/* Override this FancyBox CSS element to enable the Close icon to appear in IE */ 
.fancybox-ie #fancybox-close { 
    background: transparent; 
    filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(src='{!URLFOR($Resource.All, 'js/fancybox/fancy_close.png')}', sizingMethod='scale'); 
}

</style>

<script type="text/javascript">
// Salesforce uses prototype, so release the $ variable
jQuery.noConflict();

var currentTab;
var currentTabIndex = 1;


var ajaxQueues = new Array();
function AjaxQueue(name, refreshFunction) {
    this.pendingRequest = false;
    this.backlog = new Array();
    this.actionFunction = eval(name);
    
    if ( refreshFunction )
        this.refreshFunction = eval(refreshFunction); 
    
    this.process = function(id) {
        if ( this.pendingRequest ) {
            debugout('Adding to the queue: ' + id);
            this.backlog.push(id);
        } else {
            debugout('Sending request: ' + id);
            this.pendingRequest = true;
            this.actionFunction(id);
        }       
    }
    this.onComplete = function() {
        debugout('onComplete Raised');
        if ( this.backlog.length > 0 ) {
            var ids = this.backlog.join(',');
            this.actionFunction(ids);
            this.backlog = new Array();
            debugout(' queuing ids: ' + ids);
        } else {
            if ( this.refreshFunction ) {
                this.refreshFunction();
                debugout('Refreshing');
            }
            debugout(' Complete & no queued ids');
            this.pendingRequest = false;
        }   
    }
}

jQuery(document).ready(function() {
    ajaxQueues['trackAccount'] = new AjaxQueue('trackAccount');
    ajaxQueues['trackProspect'] = new AjaxQueue('trackProspect');
    ajaxQueues['untrackAccount'] = new AjaxQueue('untrackAccount');
    ajaxQueues['untrackProspect'] = new AjaxQueue('untrackProspect');
    ajaxQueues['muteProspect'] = new AjaxQueue('muteProspect', 'refreshActiveProspects');
    ajaxQueues['muteAccount'] = new AjaxQueue('muteAccount', 'refreshActiveAccounts');

});

function debugout(txt) {
//   jQuery('#debuglog').html( jQuery('#debuglog').html() + '<BR>' + txt);
}

function setToolip(obj, state) {
    var tooltip = obj.attr('title');

    switch ( state ) {
        case 'Track':    obj.attr('title', obj.attr('title').replace('Untrack', 'Track') ); break;
        case 'Ignore':   obj.attr('title', obj.attr('title').replace('Unignore', 'Ignore') ); break;
        case 'Untrack':  obj.attr('title', obj.attr('title').replace('Track', 'Untrack') ); break;
        case 'Unignore': obj.attr('title', obj.attr('title').replace('Ignore', 'Unignore') ); break;
    }
}

function track_onClick(obj, id, objectType) {
    //alert('track_onClick');
    var queue;
    var img = jQuery(obj).children('img');
    
    if ( img.hasClass('tracked') ) {        
        jQuery('#Track-' + id).parent().parent().hide();
        jQuery('#Active-' + id).next('a').children('img').removeClass('tracked').addClass('untracked');
        img.removeClass('tracked').addClass('untracked');
        queue = ajaxQueues['untrack' + objectType];
        setToolip(img.parent(), 'Track');
    } else {
        img.removeClass('untracked').addClass('tracked');
        queue = ajaxQueues['track' + objectType];
        setToolip(img.parent(), 'Untrack');
    }
    
    queue.process(id);
}

function mute_onClick(obj, id, objectType) {
    var tracked = jQuery('#Track-' + id).parent().parent().hide();
    var active = jQuery('#Active-' + id).parent().parent().hide();

    //var queue = ajaxQueues['mute'];
    //queue.process(id);   
    queue = ajaxQueues['mute' + objectType];
    queue.process(id);
}



function tab_onClick(obj, index) {
    
    if ( currentTab ) {
      currentTab.parent().parent().removeClass('currentTab primaryPalette');
      jQuery('#tabContent' + currentTabIndex).hide();
    }
    
    currentTab = jQuery(obj);
    currentTab.parent().parent().addClass('currentTab primaryPalette');
    currentTabIndex = index;
    jQuery('#tabContent' + currentTabIndex).show();
    
    if ( currentTabIndex == 5 ) {
        //AniLoader.show( jQuery('#pageBlock') );
        showAjaxLoader(
            jQuery('#tabContent5').find('table').first()
        );
        showRecentActivity();
    } 
}

function showRecentActivity_onComplete() {
//    AniLoader.close();
}

function ucFirst(txt) {
    return txt.substr(0, 1).toUpperCase() + txt.substr(1);
}

function sort_onClick(field, panel) {
    // show loading
    var tableId;
    if ( panel == 'activeAccounts' )
        tableId = 'tabContent3';
    else if ( panel == 'activeProspects' )
        tableId = 'tabContent1';
    else if ( panel == 'trackedProspects' )
        tableId = 'tabConent2';

    var actionTable = jQuery('#' + tableId).find('table').first();
    showAjaxLoader( actionTable );
    
    // call the sorting ajax function
    var method = eval('sort' + ucFirst(panel));
    method(field);
    
}


function paging_onClick(direction, tableId, methodPrefix) {
    //AniLoader.show( jQuery('#pageBlock') );
    var actionTable = jQuery('#' + tableId).find('table').first();
    showAjaxLoader( actionTable );
    
    var method;
    if ( direction == 'next' ) 
        method = eval(methodPrefix + 'NextPage');
    else
        method = eval(methodPrefix + 'PreviousPage');
    method();
}

function paging_onComplete() {
  //AniLoader.close();
}

function showAjaxLoader(obj) {
    var tBody = obj.children('tbody');
    tBody.children('tr').hide();
    tBody.append('<tr><td colspan="100" id="aniloader-animation">&nbsp;</td></tr>');
}
</script>

<script>
// ----------------------------------------------------------------------
// M.Smith/Force2b, 05/07/2010: Implement a pop-up for UserSettings
// ----------------------------------------------------------------------
var reloadPage = false;
function openUserSettings() {

    var pageContent = '<iframe src ="apex/usersettings" height="100%" width="100%" scrolling="no" frameborder="0"><p>Your browser does not support iframes.</p></iframe>';
   
    var dialogWidth = 850; // 570;
    // var dialogHeight = 310;  // original height when the "To be notified for all Contacts in the Account" 
    //                          // section was visible
    var dialogHeight = 500; // 250;     // new height 
    

    jQuery.fancybox(
        pageContent, {
        'width' : dialogWidth,
        'height' : dialogHeight,
        'scrolling' : 'off',
        'autoDimensions': false,
        'autoScale' : true,
        'transitionIn' : 'none',
        'transitionOut' : 'none',
        'titleShow' : false,

        'onClosed' : function() { 
           if (reloadPage) location.reload(); 
        }
    });
    //callFancybox(pageContent, dialogHeight, dialogWidth);
    return true;
}

</script>

<!-- ************************************************************************************ -->
<!-- fancyBox logic as pulled from the following website                                  --> 
<!-- http://thingsilearned.com/2010/01/27/dynamically-calling-fancybox-from-javascript/   -->
<!--                                                                                      --> 
<!-- Currently fancybox only works on links in your page.  This div hides a link,         -->
<!-- and the call to callFancyBox() changes the link & then 'clicks' it to open the box   -->
<!-- ************************************************************************************ --> 
<div id="hidden_clicker" style="display:none">
<a id="hiddenclicker" href="http://asdf.com" >Hidden Clicker</a>
</div>
<div id="userSettingsDIV" style="display:none">
</div>
<script>

// This function allows you to call the fancy box from javascript
// origional source: http://outburst.jloop.com/2009/08/06/call-fancybox-from-flash/
function callFancybox(pageContent, frmHeight, frmWidth, title) {

    if (!frmWidth) frmWidth = 500;
    // Initialize the hiddenClicker DIV for FancyBox
    $("a#hiddenclicker").fancybox({
        'width' : frmWidth,
        'height' : frmHeight,
        'modal'  : true, 
        'scrolling' : 'off',
        'autoDimensions': false,
        'autoScale' : true,
        'transitionIn' : 'none',
        'transitionOut' : 'none'
    });

  var divContent = document.getElementById("userSettingsDIV");
  divContent.innerHTML = pageContent;

  var j1 = document.getElementById("hiddenclicker");
  j1.href = "#userSettingsDIV";
  $('#hiddenclicker').trigger('click');
}
   
</script>


<div id='settingsPopup' style="display:none;">
</div>

<apex:sectionHeader title="Eloqua Discover"/>

<apex:form id="LdMngrForm"> 

<!-- -------------------------- -->
<!-- AJAX Function Declarations -->
<!-- -------------------------- -->
<!-- M.Smith/Force2b, 05/12/2010: Added the onComplete event to the mute/track Actions -->

    <apex:actionFunction name="sortTrackedAccounts" action="{!trackedAccounts.sort}" reRender="trackedAccountsPanel" status="status" >
        <apex:param name="field" value="" />
    </apex:actionFunction>  
    <apex:actionFunction name="sortTrackedProspects" action="{!trackedAccounts.sort}" reRender="trackedProspectsPanel" status="status" >
        <apex:param name="field" value="" />
    </apex:actionFunction>  


    <apex:actionFunction name="sortActiveAccounts" action="{!activeAccounts.sort}" reRender="activeAccountsPanel" status="status" >
        <apex:param name="field" value="" />
    </apex:actionFunction>  
    <apex:actionFunction name="trackAccount" action="{!trackProspect}" onComplete="ajaxQueues['trackAccount'].onComplete();"  reRender="trackedAccountsPanel" status="status" >
        <apex:param name="id" value=""/>
    </apex:actionFunction>
    <apex:actionFunction name="untrackAccount" action="{!untrackProspect}" onComplete="ajaxQueues['untrackAccount'].onComplete();" status="status" >
        <apex:param name="id" value=""/>
    </apex:actionFunction>
    <apex:actionFunction name="muteAccount" action="{!muteProspect}" onComplete="ajaxQueues['muteAccount'].onComplete();" reRender="trackedAccountsPanel" status="status" >
        <apex:param name="id" value=""/>
    </apex:actionFunction>
     <apex:actionFunction name="accountsNextPage" action="{!activeAccounts.pager.next}" reRender="activeAccountsPanel" status="status" oncomplete="paging_onComplete('tabContact3')">
    </apex:actionFunction>
    <apex:actionFunction name="accountsPreviousPage" action="{!activeAccounts.pager.previous}" reRender="activeAccountsPanel" status="status" oncomplete="paging_onComplete('tabContact3')">
    </apex:actionFunction>   
    <apex:actionFunction name="refreshTrackedAccounts" action="{!blankMethod}" reRender="trackedAccountsPanel"></apex:actionFunction>
    <apex:actionFunction name="refreshActiveAccounts" action="{!blankMethod}" reRender="activeAccountsPanel"></apex:actionFunction>



    <apex:actionFunction name="sortActiveProspects" action="{!activeProspects.sort}" reRender="activeProspectsPanel" status="status" >
        <apex:param name="field" value="" />
    </apex:actionFunction>  
    <apex:actionFunction name="trackProspect" action="{!trackProspect}" onComplete="ajaxQueues['trackProspect'].onComplete();" reRender="trackedProspectsPanel" status="status" >
        <apex:param name="id" value=""/>
    </apex:actionFunction>
    <apex:actionFunction name="untrackProspect" action="{!untrackProspect}" onComplete="ajaxQueues['untrackProspect'].onComplete();"  status="status" >
        <apex:param name="id" value=""/>
    </apex:actionFunction>
    <apex:actionFunction name="muteProspect" action="{!muteProspect}" onComplete="ajaxQueues['muteProspect'].onComplete();" reRender="mutedProspectsPanel" status="status" >
        <apex:param name="id" value=""/>
    </apex:actionFunction>
    <apex:actionFunction name="prospectsNextPage" action="{!activeProspects.pager.next}" reRender="activeProspectsPanel" status="status" oncomplete="paging_onComplete('tabContact1')">
    </apex:actionFunction>
    <apex:actionFunction name="prospectsPreviousPage" action="{!activeProspects.pager.previous}" reRender="activeProspectsPanel" status="status" oncomplete="paging_onComplete('tabContact1')" >
    </apex:actionFunction>
    <apex:actionFunction name="showRecentActivity" action="{!refreshRecentActivity}" reRender="recentActivityPanel" oncomplete="showRecentActivity_onComplete()" >
    </apex:actionFunction>
    <apex:actionFunction name="refreshActiveProspects" action="{!blankMethod}" reRender="activeProspectsPanel"></apex:actionFunction>
    <apex:actionFunction name="refreshTrackedProspects" action="{!blankMethod}" reRender="trackedProspectsPanel"></apex:actionFunction>
    
    
<!-- ----------------- -->
<!-- Tabs              -->
<!-- ----------------- -->
<div style="padding: 0px 4px">
    <table class='tabsNewBar' cellpadding="0" cellspacing="0">
        <tr><td>
        <div class="tabNavigation" style=" margin-bottom: 0px; padding-bottom: 0px; padding-left:0px; {!If($User.UIThemeDisplayed != 'Theme3', 'background-image: none;', '')}" >
            <div class="tabBarLeft"></div>
            <table width='100%' class="tab" border="0" cellpadding="0" cellspacing="0">
                <tr>
                    <td nowrap="nowrap" ><div><a href='javascript:void(0);' id="tab1" onclick='tab_onClick(this, 1)'>Most Active Prospects</a></div></td>
                    <td nowrap="nowrap" ><div><a href='javascript:void(0);' id="tab2" onclick='tab_onClick(this, 2)'>My Tracked Prospects</a></div></td>
                    <td nowrap="nowrap" ><div><a href='javascript:void(0);' id="tab3" onclick='tab_onClick(this, 3)'>Most Active Accounts</a></div></td>
                    <td nowrap="nowrap" class="last" ><div><a href='javascript:void(0);' id="tab4" onclick='tab_onClick(this, 4)'>My Tracked Accounts</a></div></td>
                    <td nowrap="nowrap" style="display: none" ><div><a href='javascript:void(0);' id="tab5" onclick='tab_onClick(this, 5)'>Most Recent Activity</a></div></td>
                    <td width='100%' style='background-image: none; text-align:right; padding-right: 6px; back' valign='middle'>
                        <!-- M.Smith/Force2b, 05/07/2010: Implement a pop-up for UserSettings -->
                        <a href="javascript:void(0);" onclick="return openUserSettings();"><apex:image url="{!URLFOR($Resource.EDP1__All, 'large/edit.png')}" height="16" /> My Settings</a>
                    </td>
                </tr>
            </table>
            <div class="tabBarRight"></div>
        </div>
        </td>
        </tr>
    </table>
</div>

<div id='pageBlock' >
<apex:pageBlock >
      
<!-- *************************************************************************** -->
<!-- MOST ACTIVE PROSPECTS TAB                                                   -->
<!-- *************************************************************************** -->
<div id='tabContent1' class="myTabContent">
   <apex:outputPanel id="activeProspectsPanel">
      <apex:pageBlockTable id="ActiveProspectsTable" value="{!activeProspects.pagedRecords}"
      var="prospect" headerClass="rowHeaderClass">
         <apex:facet name="footer">
            <apex:outputPanel rendered="{!activeProspects.pager.recordCount!=0}">
               <table width="98%" style="margin-right:20px">
                  <tr>
                     <td align="left" width="33%" style="border: none;">
                        <div id="pagelinkblock">
                           <div id="curstate">
                              Prospects: {!activeProspects.pager.pageStartPositionDisplayFriendly} -
                              {!activeProspects.pager.pageEndPositionDisplayFriendly} of {!activeProspects.pager.recordCount}
                           </div>
                        </div>
                     </td>
                     <td align="center" width="33%" style="vertical-align:middle; border: none;">
                        <apex:outputLink value="javascript:void(0);" rendered="{!activeProspects.pager.hasPrevious}"
                        onclick="paging_onClick('preivous', 'tabContent1', 'prospects');">
                           &lt;&lt;Previous
                        </apex:outputLink>
                        <span id="div_mid1">&nbsp;
                           <apex:outputLabel value="|" rendered="{!activeProspects.pager.hasPrevious &&  activeProspects.pager.hasNext}" />&nbsp;
                        </span>
                        <apex:outputLink value="javascript:void(0);" rendered="{!activeProspects.pager.hasNext}"
                        onclick="paging_onClick('next',  'tabContent1', 'prospects');">Next&gt;&gt;
                        </apex:outputLink>
                     </td>
                     <td align="right" width="33%" style="vertical-align:middle;border: none;">
                        <div id="pagenumber">Page : {!activeProspects.pager.pageNumberDisplayFriendly}</div>
                     </td>
                  </tr>
               </table>
            </apex:outputPanel>
         </apex:facet>

         <!-- ------------------ -->
         <!-- STATUS ICONS       -->
         <!-- ------------------ -->
         <apex:column style="padding-right: 12px; width: 65px;">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Interest', 'activeProspects');">Buy Signals
                  <apex:image url="/img/sort_{!LOWER(activeProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'Interest'}"/>
               </apex:outputLink>
            </apex:facet>
            <apex:image url="{!URLFOR($Resource.EDP1__All, '24x24/interest' + TEXT(prospect.interest) + '.png')}"
            height="24" rendered="false" />
            <img src="/s.gif" class="interest{!prospect.interest}" style="display: block;" 
            id="buySignals1{!prospect.id}" 
            onMouseOver="buySignalPopup.getHover(this.id, 'RaisedSignals').show();"  
            onFocus="buySignalPopup.getHover(this.id, 'RaisedSignals').show();" 
            onMouseOut="buySignalPopup.getHover(this.id, 'RaisedSignals').hide();" 
            onBlur="buySignalPopup.getHover(this.id, 'RaisedSignals').hide();" />
         </apex:column>
         <apex:column style="padding-right: 12px;  width: 65px;">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Urgency', 'activeProspects');">Recency
                  <apex:image url="/img/sort_{!LOWER(activeProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'Urgency'}"/>
               </apex:outputLink>
            </apex:facet>
            <apex:image url="{!URLFOR($Resource.EDP1__All, '24x24/urgency' + TEXT(prospect.urgency) + '.png')}"
            rendered="false" />
            <img src="/s.gif" class="urgency{!prospect.urgency}" style="display: block;"
            id="Recency1{!prospect.id}" 
            onMouseOver="buySignalPopup.getHover(this.id, 'RecencyProspect').show();"  
            onFocus="buySignalPopup.getHover(this.id, 'RecencyProspect').show();" 
            onMouseOut="buySignalPopup.getHover(this.id).hide();" 
            onBlur="buySignalPopup.getHover(this.id).hide();" />
         </apex:column>
         
         <!-- ------------------ -->
         <apex:column width="10%" style="white-space:nowrap;">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Name', 'activeProspects');">Name
                  <apex:image url="/img/sort_{!LOWER(activeProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'Name'}" />
               </apex:outputLink>
            </apex:facet>
            <img src="/s.gif" class="{!LOWER(prospect.objectType)}SmallIcon" style="padding-right: 4px;"/>
            <a href="/{!prospect.id}#ProspectDiscover" style="position: relative; top: -2px;" ><apex:outputText value="{!prospect.name}" /></a>
         </apex:column>
         <apex:column width="10%" style="white-space:nowrap;">
            <apex:facet name="header">
            <!-- onclick="sort_onClick('Title', 'activeProspects');" -->
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               >Title
                  <apex:image url="/img/sort_{!LOWER(activeProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'Title'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{!prospect.title}" />
         </apex:column>
         <apex:column width="15%">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Account', 'activeProspects');">Account
                  <apex:image url="/img/sort_{!LOWER(activeProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'Account'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputLink value="/{!prospect.accountId}" rendered="{!prospect.ObjectType='Contact'}">
               {!prospect.account}
            </apex:outputLink>
            <apex:outputText value="{!prospect.account}" rendered="{!prospect.ObjectType='Lead'}"
            />
         </apex:column>
         <apex:column styleClass="activitiesColumn">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('TotalInboundActivity', 'activeProspects');">
                  Activities
                  <apex:image url="/img/sort_{!LOWER(activeProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'TotalInboundActivity'}"/>
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{!prospect.activities}" />
         </apex:column>
         <apex:column rendered="false">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('BuySignals', 'activeProspects');">
                  Buy Signals
                  <apex:image url="/img/sort_{!LOWER(activeProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'BuySignals'}"/>
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{0, number, ####}">
               <apex:param value="{!prospect.buySignals}" />
            </apex:outputText>
         </apex:column>
         <apex:column rendered="false">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('LeadScore', 'activeProspects');">
                  Lead Score
                  <apex:image url="/img/sort_{!LOWER(activeProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'LeadScore'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{!prospect.leadScore}" />
         </apex:column>
         <apex:column width="200">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('MostRecentActivityDate', 'activeProspects');">
                  Most Recent Activity
                  <apex:image url="/img/sort_{!LOWER(activeProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'MostRecentActivityDate'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText styleClass="tableCell" value="{!prospect.MostRecentActivityDate}" />
         </apex:column>
         
         <!-- ------------------ -->
         <!-- OPPORTUNITY FIELDS -->
         <!-- ------------------ -->
         <apex:column headerValue="{!OpportunityColumnLabel}" style="text-align:center; whitespace: nowrap">
            <apex:repeat value="{!prospect.opportunities}" var="o" id="theRepeat1">
               <div style="padding-bottom:6px; white-space: nowrap;">
               <!-- 
                    onmouseover="LookupHoverDetail.getHover('1_{!o.Id}_{!prospect.id}', '/{!o.Id}/m?isAjaxRequest=1').show();" 
                    onmouseout="LookupHoverDetail.getHover('1_{!o.Id}_{!prospect.id}', '/{!o.Id}/m?isAjaxRequest=1').hide();" 
                    onfocus="LookupHoverDetail.getHover('1_{!o.Id}_{!prospect.id}', '/{!o.Id}/m?isAjaxRequest=1').show();" 
                    onblur="LookupHoverDetail.getHover('1_{!o.Id}_{!prospect.id}', '/{!o.Id}/m?isAjaxRequest=1').hide();" 
                -->
                  <a href="/{!o.Id}" id="1_{!o.Id}_{!prospect.id}">
                  <apex:outputText value="{!IF(LEN(o.Name) > 25, LEFT(o.Name,25) + '...', o.Name)}" id="theValue"/></a>
               </div>
            </apex:repeat>
         </apex:column>
         <apex:column headerValue="Stage" style="text-align:center; whitespace: nowrap">
            <apex:repeat value="{!prospect.opportunities}" var="o" id="theRepeat2">
               <div style='padding-bottom:6px; white-space: nowrap;'>
                  <apex:outputText value="{!o.StageName}" id="theValue" />
               </div>
            </apex:repeat>
         </apex:column>
         <apex:column headerValue="Amount" style="text-align:right;" rendered="false">
            <apex:repeat value="{!prospect.opportunities}" var="o" id="theRepeat3">
               <div style='padding-bottom:6px; white-space: nowrap;'>
                  &nbsp; {!IF(o.Amount>0, '$','')}
                  <apex:outputText style="text-align: right;" escape="false" value="{0,number, #,###,###}"
                  id="theValue">
                     <apex:param value="{!o.Amount}" />
                  </apex:outputText>
               </div>
            </apex:repeat>
         </apex:column>
         
         <!-- ------------------ -->
         <!-- TRACKING ICONS -->
         <!-- ------------------ -->
         <apex:column headerValue="Track" style="text-align:center; width: 45px;">
            <span id="Active-{!prospect.id}">
            </span>
            <a href="javascript:void(0);" onclick="track_onClick(this, '{!prospect.id}', 'Prospect');" title="{!IF(prospect.isTracked, 'Untrack', 'Track')} {!prospect.objectType}">
            <apex:image url="/s.gif" height="24" alt="Track me" styleClass="{!IF(prospect.isTracked, 'tracked', 'untracked')}" />
            </a>
         </apex:column>
         <apex:column headerValue="Ignore" style="text-align:center; width: 45px;" title="Ignore {!prospect.objectType}">
            <a href="javascript:void(0);" id="mute1{!prospect.id}" onclick="mute_onClick(this, '{!prospect.id}', 'Prospect');">
            <!-- <img src="/s.gif" alt="Ignore me" class="ignore" />  -->
            <apex:image url="/s.gif" height="24" alt="Ignore me" styleClass="{!IF(prospect.isMuted, 'unignore', 'ignore')}" />
            </a>
         </apex:column>
         <!-- ------------------ -->
      </apex:pageBlockTable>
   </apex:outputPanel>
</div>

<!-- *************************************************************************** -->
<!-- MY TRACKED PROSPECTS TAB                                                    -->
<!-- *************************************************************************** -->
<div id='tabContent2' class="myTabContent">
   <apex:outputPanel id="trackedProspectsPanel">
      <apex:pageBlockTable value="{!trackedProspects.records}" var="prospect"  headerClass="rowHeaderClass">
         

         <apex:facet name="footer">
            <apex:outputPanel rendered="{!trackedProspects.pager.recordCount=0}">
               <div style="text-align:center; padding: 10px; font-size: 14px;">You are currently not tracking any prospects</div>
            </apex:outputPanel>
            <apex:outputPanel rendered="{!trackedProspects.pager.recordCount != 0}">
               <div style="text-align:center; padding: 10px; ">You have {!trackedProspects.records.size} tracked prospect(s)</div>
            </apex:outputPanel>
         </apex:facet>
         
         <!-- ------------------ -->
         <!-- STATUS ICONS       -->
         <!-- ------------------ -->
         <apex:column style="padding-right: 12px; width: 65px; ">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Interest', 'trackedProspects');">
                  Buy Signals
                  <apex:image url="/img/sort_{!LOWER(trackedProspects.sortDirection)}_arrow.gif" rendered="{!trackedProspects.sortField = 'Interest'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:image url="{!URLFOR($Resource.EDP1__All, '24x24/interest' + TEXT(prospect.interest) + '.png')}"
            height="24" rendered="false" />
            <img src="/s.gif" class="interest{!prospect.interest}" style="display: block;"
            id="buySignals2{!prospect.id}" 
            onMouseOver="buySignalPopup.getHover(this.id, 'RaisedSignals').show();"  
            onFocus="buySignalPopup.getHover(this.id, 'RaisedSignals').show();" 
            onMouseOut="buySignalPopup.getHover(this.id, 'RaisedSignals').hide();" 
            onBlur="buySignalPopup.getHover(this.id, 'RaisedSignals').hide();" />
         </apex:column>
         <apex:column style="padding-right: 12px; width: 65px;">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Urgency', 'trackedProspects');">
                  Recency
                  <apex:image url="/img/sort_{!LOWER(trackedProspects.sortDirection)}_arrow.gif" rendered="{!trackedProspects.sortField = 'Urgency'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:image url="{!URLFOR($Resource.EDP1__All, '24x24/urgency' + TEXT(prospect.urgency) + '.png')}"
            rendered="false" />
            <img src="/s.gif" class="urgency{!prospect.urgency}" style="display: block;"
            id="Recency2{!prospect.id}" 
            onMouseOver="buySignalPopup.getHover(this.id, 'RecencyProspect').show();"  
            onFocus="buySignalPopup.getHover(this.id, 'RecencyProspect').show();" 
            onMouseOut="buySignalPopup.getHover(this.id).hide();" 
            onBlur="buySignalPopup.getHover(this.id).hide();" />
         </apex:column>
         <!-- ------------------ -->
         <apex:column width="10%">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none; " value="javascript:void(0);">
                  Name
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedProspects.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <img src="/s.gif" class="{!LOWER(prospect.objectType)}SmallIcon" style="padding-right: 4px;" />
            <a href="/{!prospect.id}" style="position: relative; top: -4px;"><apex:outputText value="{!prospect.name}" /></a>
         </apex:column>
         <apex:column width="10%" style="white-space:nowrap;">
            <apex:facet name="header">
            <!-- onclick="sort_onClick('Title', 'trackedProspects');" -->
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">Title
                  <apex:image url="/img/sort_{!LOWER(trackedProspects.sortDirection)}_arrow.gif" rendered="{!activeProspects.sortField = 'Title'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{!prospect.title}" />
         </apex:column>
         <apex:column width="25%">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Account
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedProspects.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <a href="/{!prospect.AccountId}"><apex:outputText value="{!prospect.account}" /></a>
         </apex:column>
         <apex:column styleClass="activitiesColumn">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Activities
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedProspects.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{!prospect.activities}" />
         </apex:column>
         <apex:column rendered="false">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Buy Signals
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedProspects.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{0, number, ####}">
               <apex:param value="{!prospect.buySignals}" />
            </apex:outputText>
         </apex:column>
         <apex:column rendered="false">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Lead Score
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedProspects.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{!prospect.leadScore}" />
         </apex:column>
         <apex:column width="200">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Most Recent Activity
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedProspects.sortDirection)}_arrow.gif"/>
               </apex:outputLink>
            </apex:facet>
            <apex:outputText styleClass="tableCell" value="{!prospect.MostRecentActivityDate}" />
         </apex:column>
         <!-- ------------------ -->
         <!-- OPPORTUNITY FIELDS -->
         <!-- ------------------ -->
         <apex:column headerValue="{!OpportunityColumnLabel}" style="text-align:center; whitespace: nowrap">
            <apex:repeat value="{!prospect.opportunities}" var="o" id="theRepeat1">
               <div style="padding-bottom:6px; white-space: nowrap;">
               <!-- 
                    onmouseover="LookupHoverDetail.getHover('1_{!o.Id}_{!prospect.id}', '/{!o.Id}/m?isAjaxRequest=1').show();" 
                    onmouseout="LookupHoverDetail.getHover('1_{!o.Id}_{!prospect.id}', '/{!o.Id}/m?isAjaxRequest=1').hide();" 
                    onfocus="LookupHoverDetail.getHover('1_{!o.Id}_{!prospect.id}', '/{!o.Id}/m?isAjaxRequest=1').show();" 
                    onblur="LookupHoverDetail.getHover('1_{!o.Id}_{!prospect.id}', '/{!o.Id}/m?isAjaxRequest=1').hide();" 
                -->
                  <a href="/{!o.Id}" id="1_{!o.Id}_{!prospect.id}">
                  <apex:outputText value="{!IF(LEN(o.Name) > 25, LEFT(o.Name,25) + '...', o.Name)}" id="theValue"/></a>
               </div>
            </apex:repeat>
         </apex:column>
         <apex:column headerValue="Stage" style="text-align:center; whitespace: nowrap">
            <apex:repeat value="{!prospect.opportunities}" var="o" id="theRepeat2">
               <div style='padding-bottom:6px; white-space: nowrap;'>
                  <apex:outputText value="{!o.StageName}" id="theValue" />
               </div>
            </apex:repeat>
         </apex:column>
         <apex:column headerValue="Amount" style="text-align:right;" rendered="false">
            <apex:repeat value="{!prospect.opportunities}" var="o" id="theRepeat3">
               <div style='padding-bottom:6px; white-space: nowrap;'>
                  &nbsp; {!IF(o.Amount>0, '$','')}
                  <apex:outputText style="text-align: right;" escape="false" value="{0,number, #,###,###}"
                  id="theValue">
                     <apex:param value="{!o.Amount}" />
                  </apex:outputText>
               </div>
            </apex:repeat>
         </apex:column>
         <!-- ------------------ -->
         <!-- TRACKING ICONS -->
         <!-- ------------------ -->
         <apex:column headerValue="Track" style="text-align:center; width: 45px;">
            <span id="Track-{!prospect.id}">
            </span>
            <a href="javascript:void(0);" onclick="track_onClick(this, '{!prospect.id}', 'Prospect');" title="{!IF(prospect.isTracked, 'Untrack', 'Track')} {!prospect.objectType}">
            <apex:image url="/s.gif" height="24" alt="Track me" styleClass="{!IF(prospect.isTracked, 'tracked', 'untracked')}" /></a>
         </apex:column>
         <apex:column headerValue="Ignore" style="text-align:center; width: 45px;">
            <!-- Vic 06/17/2010 -->
            <!-- a href="javascript:void(0);" id="mute2{!prospect.id}" onclick="ajaxAction_onClick(this,
            'mute', '{!prospect.id}');" -->
            <a href="javascript:void(0);" id="mute2{!prospect.id}" onclick="mute_onClick(this, '{!prospect.id}', 'Prospect');" title="Ignore {!prospect.objectType}">
            <img src="/s.gif" alt="Ignore me" class="ignore" /></a>
         </apex:column>
      </apex:pageBlockTable>
   </apex:outputPanel>
</div>

<!-- *************************************************************************** -->
<!-- MOST ACTIVE ACCOUNTS TAB                                                    -->
<!-- *************************************************************************** -->
<div id='tabContent3' class="myTabContent" style="min-height: 160px;">
   <apex:outputPanel id="activeAccountsPanel">
      <apex:pageBlockTable value="{!activeAccounts.pagedRecords}" var="a"  headerClass="rowHeaderClass">
         <apex:facet name="footer">
            <apex:outputPanel rendered="{!activeAccounts.pager.recordCount!=0}">
               <table width="98%" style="margin-right:20px">
                  <tr>
                     <td align="left" width="33%" style="border: none;">
                        <div id="pagelinkblock">
                           <div id="curstate">
                              Accounts: {!activeAccounts.pager.pageStartPositionDisplayFriendly} - {!activeAccounts.pager.pageEndPositionDisplayFriendly}
                              of {!activeAccounts.pager.recordCount}
                           </div>
                        </div>
                     </td>
                     <td align="center" width="33%" style="vertical-align:middle; border: none;">
                        <apex:outputLink value="javascript:void(0);" rendered="{!activeAccounts.pager.hasPrevious}"
                        onclick="paging_onClick('previous', 'tabContent3', 'accounts');">
                           &lt;&lt;Previous
                        </apex:outputLink>
                        <span id="div_mid1">
                           &nbsp;
                           <apex:outputLabel value="|" rendered="{!activeProspects.pager.hasPrevious && activeProspects.pager.hasNext}" />
                           &nbsp;
                        </span>
                        <apex:outputLink value="javascript:void(0);" rendered="{!activeAccounts.pager.hasNext}"
                        onclick="paging_onClick('next', 'tabContent3', 'accounts');">
                           Next&gt;&gt;
                        </apex:outputLink>
                     </td>
                     <td align="right" width="33%" style="vertical-align:middle;border: none;">
                        <div id="pagenumber">
                           Page : {!activeAccounts.pager.pageNumberDisplayFriendly}
                        </div>
                     </td>
                  </tr>
               </table>
            </apex:outputPanel>
         </apex:facet>
         <!-- ------------------ -->
         <!-- STATUS ICONS       -->
         <!-- ------------------ -->
         <apex:column style="padding-right: 12px; width: 65px;;">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Interest', 'activeAccounts');">
                  Buy Signals
                  <apex:image url="/img/sort_{!LOWER(activeAccounts.sortDirection)}_arrow.gif" rendered="{!activeAccounts.SortField = 'Interest'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:image url="{!URLFOR($Resource.EDP1__All, '24x24/interest' + TEXT(a.interest) + '.png')}"
            height="24" rendered="false" />
            <img src="/s.gif" class="interest{!a.interest}" style="display: block;" 
            id="buySignals1{!a.id}" 
            onMouseOver="buySignalPopup.getHover(this.id, 'Account').show();"  
            onFocus="buySignalPopup.getHover(this.id, 'Account').show();" 
            onMouseOut="buySignalPopup.getHover(this.id).hide();" 
            onBlur="buySignalPopup.getHover(this.id).hide();"
            />
         </apex:column>
         <apex:column style="padding-right: 12px; width: 65px;">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Urgency', 'activeAccounts');">
                  Recency
                  <apex:image url="/img/sort_{!LOWER(activeAccounts.sortDirection)}_arrow.gif" rendered="{!activeAccounts.sortField = 'Urgency'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:image url="{!URLFOR($Resource.EDP1__All, '24x24/urgency' + TEXT(a.urgency) + '.png')}"
            rendered="false" />
            <img src="/s.gif" class="urgency{!a.urgency}" style="display: block;" 
            id="Recency3{!a.id}" 
            onMouseOver="buySignalPopup.getHover(this.id, 'RecencyAccount').show();"  
            onFocus="buySignalPopup.getHover(this.id, 'RecencyAccount').show();" 
            onMouseOut="buySignalPopup.getHover(this.id).hide();" 
            onBlur="buySignalPopup.getHover(this.id).hide();" />
            
         </apex:column>
         <!-- ------------------ -->
         <apex:column width="25%">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Name', 'activeAccounts');">
                  Name
                  <apex:image url="/img/sort_{!LOWER(activeAccounts.sortDirection)}_arrow.gif" rendered="{!activeAccounts.sortField = 'Name'}"/>
               </apex:outputLink>
            </apex:facet>
            <img src="/s.gif" class="accountSmallIcon" style="padding-right: 4px;" />
            <a href="/{!a.id}" style="position: relative; top: -4px;" target="_blank"
                id="activeContacts1{!a.id}">
                <!-- 
                onMouseOver="buySignalPopup.getHover(this.id, 'Contact').show();"  
                onFocus="buySignalPopup.getHover(this.id, 'Contact').show();" 
                onMouseOut="buySignalPopup.getHover(this.id).hide();" 
                onBlur="buySignalPopup.getHover(this.id).hide();">
                -->                
            <apex:outputText value="{!a.Name}" /></a>
         </apex:column>
         <apex:column >
            <apex:facet name="header">
               Industry
            </apex:facet>
            <apex:outputText value="{!a.industry}" />
         </apex:column>
         <apex:column styleClass="activitiesColumn">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('TotalInboundActivity', 'activeAccounts');">
                  Activities
                  <apex:image url="/img/sort_{!LOWER(activeAccounts.sortDirection)}_arrow.gif" rendered="{!activeAccounts.sortField = 'TotalInboundActivity'}"/>
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{!a.activities}" />
         </apex:column>
         <apex:column >
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('MostRecentActivityDate', 'activeAccounts');">
                  Most Recent Activity Date
                  <apex:image url="/img/sort_{!LOWER(activeAccounts.sortDirection)}_arrow.gif" rendered="{!activeAccounts.sortField = 'MostRecentActivityDate'}"/>
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{!a.mostRecentActivityDate}" />
         </apex:column>

         <!-- ------------------ -->
         <!-- OPPORTUNITY FIELDS -->
         <!-- ------------------ -->
         <apex:column headerValue="{!OpportunityColumnLabel}" style="text-align:center; whitespace: nowrap">
            <apex:repeat value="{!a.opportunities}" var="o" id="theRepeat1">
               <div style="padding-bottom:6px; white-space: nowrap;">
                  <a href="/{!o.Id}"><apex:outputText value="{!IF(LEN(o.Name) > 25, LEFT(o.Name,25) + '...', o.Name)}" id="theValue"/></a>
               </div>
            </apex:repeat>
         </apex:column>
         <apex:column headerValue="Stage" style="text-align:center; whitespace: nowrap">
            <apex:repeat value="{!a.opportunities}" var="o" id="theRepeat2">
               <div style='padding-bottom:6px; white-space: nowrap;'>
                  <apex:outputText value="{!o.StageName}" id="theValue" />
               </div>
            </apex:repeat>
         </apex:column>
         <apex:column headerValue="Amount" style="text-align:right;"  rendered="false">
            <apex:repeat value="{!a.opportunities}" var="o" id="theRepeat3">
               <div style='padding-bottom:6px; white-space: nowrap;'>
                  &nbsp; {!IF(o.Amount>0, '$','')}
                  <apex:outputText style="text-align: right;" escape="false" value="{0,number, #,###,###}"
                  id="theValue">
                     <apex:param value="{!o.Amount}" />
                  </apex:outputText>
               </div>
            </apex:repeat>
         </apex:column>
         
         <!-- ------------------ -->
         <!-- TRACKING ICONS -->
         <!-- ------------------ -->
         <apex:column headerValue="Track" style="text-align:center; width: 45px;">
            <span id="Active-{!a.id}">
            </span>
            <a href="javascript:void(0);" onclick="track_onClick(this, '{!a.id}', 'Account');" title="{!IF(a.isTracked, 'Untrack', 'Track')} Account">
            <apex:image url="/s.gif" height="24" alt="Track me" styleClass="{!IF(a.isTracked, 'tracked', 'untracked')}" />
            </a>
         </apex:column>
         <apex:column headerValue="Ignore" style="text-align:center; width: 45px;">
            <a href="javascript:void(0);" id="mute3{!a.id}" onclick="mute_onClick(this, '{!a.id}', 'Account');" title='Ignore Account'>
            <!-- <img src="/s.gif" alt="Ignore me" class="ignore" />  -->
            <apex:image url="/s.gif" height="24" alt="Ignore me" styleClass="{!IF(a.isMuted, 'unignore', 'ignore')}" />
            </a>
         </apex:column>
         <!-- ------------------ -->
      </apex:pageBlockTable>
   </apex:outputPanel>
</div>

<!-- *************************************************************************** -->
<!-- MY TRACKED ACCOUNTS TAB                                                     -->
<!-- *************************************************************************** -->
<div id='tabContent4' class="myTabContent">
   <apex:outputPanel id="trackedAccountsPanel">
      <apex:pageBlockTable value="{!trackedAccounts.records}" var="account"  headerClass="rowHeaderClass">
         <apex:facet name="footer">
            <apex:outputPanel rendered="{!trackedAccounts.pager.recordCount=0}">
               <div style="text-align:center; padding: 10px; font-size: 14px;">You are currently not tracking any accounts</div>
            </apex:outputPanel>
            <apex:outputPanel rendered="{!trackedAccounts.pager.recordCount != 0}">
               <div style="text-align:center; padding: 10px; ">You have {!trackedAccounts.records.size} tracked account(s)</div>
            </apex:outputPanel>
            
         </apex:facet>
         <!-- ------------------ -->
         <!-- STATUS ICONS       -->
         <!-- ------------------ -->
         <apex:column style="padding-right: 12px; width: 65px;;">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Interest', 'activeAccounts');">
                  Buy Signals
                  <apex:image url="/img/sort_{!LOWER(activeAccounts.sortDirection)}_arrow.gif" rendered="{!activeAccounts.sortField = 'Interest'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:image url="{!URLFOR($Resource.EDP1__All, '24x24/interest' + TEXT(account.interest) + '.png')}"
            height="24" rendered="false" />
            <img src="/s.gif" class="interest{!account.interest}" style="display: block;"
            id="buySignals2{!account.id}" 
            onMouseOver="buySignalPopup.getHover(this.id, 'Account').show();"  
            onFocus="buySignalPopup.getHover(this.id, 'Account').show();" 
            onMouseOut="buySignalPopup.getHover(this.id).hide();" 
            onBlur="buySignalPopup.getHover(this.id).hide();" />
         </apex:column>
         <apex:column style="padding-right: 12px; width: 65px;">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Urgency', 'trackedAccounts');">
                  Recency
                  <apex:image url="/img/sort_{!LOWER(activeAccounts.sortDirection)}_arrow.gif" rendered="{!activeAccounts.sortField = 'Urgency'}" />
               </apex:outputLink>
            </apex:facet>
            <apex:image url="{!URLFOR($Resource.EDP1__All, '24x24/urgency' + TEXT(account.urgency) + '.png')}"
            rendered="false" />
            <img src="/s.gif" class="urgency{!account.urgency}" style="display: block;" 
            id="Recency4{!account.id}" 
            onMouseOver="buySignalPopup.getHover(this.id, 'RecencyAccount').show();"  
            onFocus="buySignalPopup.getHover(this.id, 'RecencyAccount').show();" 
            onMouseOut="buySignalPopup.getHover(this.id).hide();" 
            onBlur="buySignalPopup.getHover(this.id).hide();" />
            
         </apex:column>
         <!-- ------------------ -->
         <apex:column width="25%">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none; " value="javascript:void(0);">
                  Name
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedAccounts.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <img src="/s.gif" class="{!LOWER(account.objectType)}SmallIcon" style="padding-right: 4px;" />
            <a href="/{!account.id}" style="position: relative; top: -4px;" target="_blank"
                id="activeContacts2{!account.id}">
                <!-- 
                onMouseOver="buySignalPopup.getHover(this.id, 'Contact').show();"  
                onFocus="buySignalPopup.getHover(this.id, 'Contact').show();" 
                onMouseOut="buySignalPopup.getHover(this.id).hide();" 
                onBlur="buySignalPopup.getHover(this.id).hide();">
                 -->
            <apex:outputText value="{!account.name}" /></a>
         </apex:column>
  <apex:column >
            <apex:facet name="header">
               Industry
            </apex:facet>
            <apex:outputText value="{!account.industry}" />
         </apex:column>       
         <apex:column styleClass="activitiesColumn" >
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Activities
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedAccounts.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{0, number, #,###}">
               <apex:param value="{!account.activities}" />
            </apex:outputText>
         
         </apex:column>
         <apex:column rendered="false">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Buy Signals
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedAccounts.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{0, number, ####}">
               <apex:param value="{!account.buySignals}" />
            </apex:outputText>
         </apex:column>
         <apex:column rendered="false">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Lead Score
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedAccounts.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{!account.leadScore}" />
         </apex:column>
         <apex:column width="200">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Most Recent Activity
                  <apex:image rendered="{!0=1}" url="/img/sort_{!LOWER(trackedAccounts.sortDirection)}_arrow.gif" />
               </apex:outputLink>
            </apex:facet>
            <apex:outputText styleClass="tableCell" value="{!account.MostRecentActivityDate}" />
         </apex:column>
         <apex:column headerValue="{!OpportunityColumnLabel}" rendered="{!0=1}" style="text-align:center;">
            <a href="/{!account.opportunityId}"><apex:outputText value="{!IF(LEN(account.opportunityName) > 40, LEFT(account.opportunityName,40) + '...', account.opportunityName)}" /></a>
         </apex:column>
         <apex:column rendered="{!0=1}" headerValue="Opp Stage" style="text-align:center;">
            <apex:outputText value="{!account.opportunityStage}" />
         </apex:column>
         <apex:column rendered="{!0=1}" headerValue="Opp Value" style="text-align:center;">
            <apex:outputText value="{0, number, #,###,###}">
               <apex:param value="{!account.opportunityValues}" />
            </apex:outputText>
         </apex:column>

         <!-- ------------------ -->
         <!-- OPPORTUNITY FIELDS -->
         <!-- ------------------ -->
         <apex:column headerValue="{!OpportunityColumnLabel}" style="text-align:center; whitespace: nowrap">
            <apex:repeat value="{!account.opportunities}" var="o" id="theRepeat1">
               <div style="padding-bottom:6px; white-space: nowrap;">
                  <a href="/{!o.Id}"><apex:outputText value="{!IF(LEN(o.Name) > 25, LEFT(o.Name,25) + '...', o.Name)}" id="theValue"/></a>
               </div>
            </apex:repeat>
         </apex:column>
         <apex:column headerValue="Stage" style="text-align:center; whitespace: nowrap">
            <apex:repeat value="{!account.opportunities}" var="o" id="theRepeat2">
               <div style='padding-bottom:6px; white-space: nowrap;'>
                  <apex:outputText value="{!o.StageName}" id="theValue" />
               </div>
            </apex:repeat>
         </apex:column>
         <apex:column headerValue="Amount" style="text-align:right;"  rendered="false">
            <apex:repeat value="{!account.opportunities}" var="o" id="theRepeat3">
               <div style='padding-bottom:6px; white-space: nowrap;'>
                  &nbsp; {!IF(o.Amount>0, '$','')}
                  <apex:outputText style="text-align: right;" escape="false" value="{0,number, #,###,###}"
                  id="theValue">
                     <apex:param value="{!o.Amount}" />
                  </apex:outputText>
               </div>
            </apex:repeat>
         </apex:column>

         <!-- ------------------ -->
         <!-- TRACKING ICONS -->
         <!-- ------------------ -->
         <apex:column headerValue="Track"  style="text-align:center; width: 45px;">
            <span id="Track-{!account.id}"></span>
            <a href="javascript:void(0);" onclick="track_onClick(this, '{!account.id}', 'Account');" title="{!IF(account.isTracked, 'Untrack', 'Track')} Account">
            <apex:image url="/s.gif" height="24" alt="Track me" styleClass="{!IF(account.isTracked, 'tracked', 'untracked')}" />
            </a>
         </apex:column>
         <apex:column headerValue="Ignore"  style="text-align:center; width: 45px;">
            <!-- Vic 06/17/2010 -->
            <!-- a href="javascript:void(0);" id="mute2{!account.id}" onclick="ajaxAction_onClick(this,
            'mute', '{!account.id}');" -->
            <a href="javascript:void(0);" id="mute4{!account.id}" onclick="mute_onClick(this, '{!account.id}', 'Account');" title='Ignore Account'>
            <apex:image url="/s.gif" height="24" alt="Ignore me" styleClass="{!IF(account.isMuted, 'unignore', 'ignore')}" />
            </a>
         </apex:column>
      </apex:pageBlockTable>
   </apex:outputPanel>
</div>

<!-- *************************************************************************** -->
<!-- RECENT ACTIVITY TAB                                                         -->
<!-- *************************************************************************** -->
<div id='tabContent5' class="myTabContent" style="min-height: 160px;">
   <apex:outputPanel id="recentActivityPanel">
      <apex:pageBlockTable value="{!recentActivity}" var="a"  headerClass="rowHeaderClass">
         <apex:column >
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Name
               </apex:outputLink>
            </apex:facet>
            <img src="/s.gif" class="{!LOWER(a.objectType)}SmallIcon" style="padding-right: 3px;" />
            <a href='/{!a.prospectId}' style="position: relative; top: -4px;">{!a.name}</a>
         </apex:column>
         <apex:column width="15%" style="vertical-align:middle;">
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);"
               onclick="sort_onClick('Account', 'recentActivity');">
                  Account
               </apex:outputLink>
            </apex:facet>
            <apex:outputLink value="/{!a.accountId}" rendered="{!a.ObjectType='Contact'}">
               {!a.account}
            </apex:outputLink>
            <apex:outputText value="{!a.account}" rendered="{!a.ObjectType='Lead'}" />
         </apex:column>
         <apex:column >
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Activity Type
               </apex:outputLink>
            </apex:facet>
            {!a.activityType}
         </apex:column>
         <apex:column >
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Marketing Asset
               </apex:outputLink>
            </apex:facet>
            {!a.assetName} &nbsp;<apex:outputText value=" (Page: {!a.activityDescription})" rendered="{!a.activityType=='Hypersite Visit'}" />
         </apex:column>
         <apex:column >
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  URL
               </apex:outputLink>
            </apex:facet>
            <a href='{!a.activityUrl}' target='_blank'>
                <apex:outputText rendered="{!a.activityType='Form Submit'}">Click here for form submission data</apex:outputText>
                <apex:outputText rendered="{!a.activityType='Website Visit'}">Click here for visit details</apex:outputText>
                <apex:outputText rendered="{!a.activityType!='Form Submit' && a.activityType!='Website Visit'}">{!IF(LEN(a.activityUrl)>34, LEFT(a.activityUrl,32)+'...', a.activityUrl)}</apex:outputText>
            </a>
         </apex:column>
         <apex:column >
            <apex:facet name="header">
               <apex:outputLink style="text-decoration: none;" value="javascript:void(0);">
                  Activity Date
               </apex:outputLink>
            </apex:facet>
            <apex:outputText value="{0,date,E MMM dd yyyy}" style="white-space:nowrap;">
               <apex:param value="{!a.activityDate}" />
            </apex:outputText>
         </apex:column>
      </apex:pageBlockTable>
   </apex:outputPanel>
</div>
</apex:pageBlock>
</div>
<div id='debuglog' >

</div>
</apex:form>

<script>
//----------------------------------
// Configuration Variables
//----------------------------------
var cfg = {
  activityDateField : "{!JSENCODE(activityDateField)}",
  activityObject    : "{!JSENCODE(config.ActivityObject__c)}",
  activityTypeField : "{!JSENCODE(activityTypeField)}",
  assetNameField    : "{!JSENCODE(assetNameField)}",
  activityDateField : "{!JSENCODE(activityDateField)}",
  contactChildRelationship : "{!JSENCODE(contactChildRelationship)}",
  contactField      : "{!JSENCODE(contactField)}",
  contactPrefix     : "{!JSENCODE(contactPrefix)}",
  leadField         : "{!JSENCODE(leadField)}"
}



// -------------------------------------------------------------------------------------------------
// M.Smith, 06/19/2010: Implement a mouse-over pop-up for Buy Signals
// -------------------------------------------------------------------------------------------------
// Based on LookupHoverDetail code from SalesForce.com's own JS libraries
// Added the buySignalPopup.prototype.buildContent() method to retrieve
// content for RaisedBuySignals. Could make this more generic by passing
// in a parameter on the getHover() call to tell the code below 'what' to query
// and/or how to build the display box.
// The original code passed in a URL for the mini-pageLayout. It used XBrowser
// to retreive the page content via a callBack and then display in the box.
// -------------------------------------------------------------------------------------------------
// Passes in two parameters:
// - id = DivID for the field (essentially this.id)
// - oType = object Type ('RaisedSignals' or null, 'Account', 'Contact', 'RecencyProspect', 'RecencyAccount')
// -------------------------------------------------------------------------------------------------
var currentlyRunningHover;
function buySignalPopup(id, oType) {
    this.objectType = oType;
    this.theItem = getElementByIdCS(id);
    this.width = buySignalPopup.STANDARD_BUBBLE_WIDTH;
    // XBroswer removed from SF summer '12 release (alj 06/06/12) this.bubbleOffset = XBrowser.userAgent.isIE6 ? 5 : 14;
    this.bubbleOffset = 14;
    this.height = buySignalPopup.STANDARD_BUBBLE_HEIGHT;
    this.hover = document.createElement("div");
    this.hover.id = id + "Hover";
    this.itemId = id;
    this.hover.className = "individualPalette lookupHoverDetail lookupHoverDetailLoading lookupHoverDetailOverridable";
    this.hover.innerHTML = '<div class="topLeft"><div class="bPageBlock"><div class="pbBody">' 
        + LC.getLabel("Global", "loading") + '</div><div class="pbFooter"><div class="bg"></div></div></div></div>';
    document.body.appendChild(this.hover);
    var self = this;
    addEvent(this.hover, "mouseover", function () {
        self.show();
    }, true);
    addEvent(this.hover, "mouseout", function () {
        self.hide();
    }, true);
    addEvent(this.hover, "click", function (e) {
        var target = getEventTarget(e);
        var tag = target.tagName;
        if (tag === "A" || (tag === "INPUT" && target.type === "button")) {
            self.hide();
        }
    }, false);
    this.hover = new iframeShim(this.hover);
    this.originalClass = "";
    this.fadingOut = null;
    this.fadingIn = null;
    // this.loaderURL = url; 
    this.loaded = false;
}
buySignalPopup.STANDARD_BUBBLE_WIDTH = 580; // not really sure this is used?
buySignalPopup.STANDARD_BUBBLE_HEIGHT = 650; // set to auto anyway
buySignalPopup.SHOW_DELAY = 300;
buySignalPopup.HIDE_DELAY = 150;
buySignalPopup.stopLoading = false;
buySignalPopup.hovers = {};
buySignalPopup.PopupFooter = '</tbody></table></div>'
    + '<div class="pbFooter secondaryPalette"><div class="bg"></div></div>'
    + '</div></div>';
buySignalPopup.getHover = function (id, oType) {
    if (buySignalPopup.hovers[id]) {
        return buySignalPopup.hovers[id];
    }
    var hover = new buySignalPopup(id, oType);
    buySignalPopup.hovers[id] = hover;
    return hover;
};
buySignalPopup.prototype.show = function () {
    if (this.fadingOut) {
        clearTimeout(this.fadingOut);
        this.fadingOut = null;
    } else {
        var self = this;
        this.fadingIn = setTimeout(function () {
            self.showNow();
        }, buySignalPopup.SHOW_DELAY);
    }
};
buySignalPopup.prototype.showNow = function () {
    if (!this.loaded) {
        //if (this.loaderURL != null) {
            var self = this;
            if ( self.objectType == 'Account' )      self.load(self.buildAccountContent());
            else if ( self.objectType == 'Contact' ) self.load(self.buildRecentContactsContent());
            else if ( self.objectType == 'RecencyProspect' ) self.load(self.buildRecencyProspectContent());
            else if ( self.objectType == 'RecencyAccount' ) self.load(self.buildRecencyAccountContent());
            else                                     self.load(self.buildBuySignalContent());
            //XBrowser.getHttpResponse(this.loaderURL, function (response) {
            //    self.load(response.responseText);
            //}, function (response) {
            //    self.load(response.responseText);
            //});
        //} else {
        //    return;
        //}
    }
    this.position();
    this.hover.setStyle("display", "block");
    this.hover.setStyle("visibility", "visible");
    this.fadingIn = null;
};
buySignalPopup.prototype.hide = function () {
    currentlyRunningHover = null;
    if (this.fadingIn) {
        clearTimeout(this.fadingIn);
        //this.fadingIn = null;
        this.hideNow();
    } else {
        var self = this;
        this.fadingOut = setTimeout(function () {
            self.hideNow();
        }, buySignalPopup.HIDE_DELAY);
    }
};
buySignalPopup.prototype.hideNow = function () {
    this.hover.setStyle("visibility", "hidden");
    this.hover.setStyle("display", "none");
    this.fadingOut = null;
};
buySignalPopup.prototype.load = function (responseText) {
    this.hover.div.innerHTML = responseText;
    if ( this.hover.div.firstChild == null )
        return;
    // Util.evalScriptsUnderElement(this.hover.div);
    this.originalClass = this.hover.div.firstChild.className;
    delStyleClass(this.hover.div, "lookupHoverDetailLoading");
    this.height = this.hover.div.offsetHeight;
    this.position();
    this.position();
    this.loaded = true;
};
buySignalPopup.prototype.position = function () {
    var lookupX = getObjX(this.theItem)+34; // shift to the right to allow mousing over all the stars to work
    var lookupY = getObjY(this.theItem);
    var lookupW = this.theItem.offsetWidth;
    var lookupH = this.theItem.offsetHeight;
    var winX = getScrollX();
    var winY = getScrollY();
    var winWidth = getWindowWidth();
    var winHeight = getWindowHeight();
    var bubbleClass = this.originalClass + " ";
    var hoverX, hoverY;
    // is (220+24+87) < (0+602)?
    // alert('is (' + lookupY + '+' + lookupH + '+' + this.height + ') < (' + winY + '+' + winHeight + ')?');
    if (lookupY + lookupH + this.height < winY + winHeight) {
        bubbleClass += "top";
        lookupY -= 25; // MGS, move up by 25 pixels
        hoverY = lookupY + lookupH;
    } else {
        bubbleClass += "bottom";
        lookupY += 5; // MGS, move down by 5 pixels
        hoverY = lookupY - this.height;
    }
    if (lookupX + lookupW - this.bubbleOffset + this.width < winX + winWidth) {
        bubbleClass += "Left";
        hoverX = lookupX + lookupW / 2 - this.bubbleOffset;
    } else {
        bubbleClass += "Right";
        hoverX = lookupX + lookupW / 2 - this.width;
    }
    this.hover.setStyle("left", hoverX + "px");
    this.hover.setStyle("top", hoverY + "px");
    if ( this.hover.div.firstChild == null )
       return;
    this.hover.div.firstChild.className = bubbleClass;
    if (this.hover.div.firstChild) {
        var overrideClass = Util.hasStyleEndsWith(this.hover.div.firstChild, "Override");
        if (overrideClass) {
            delStyleClass(this.hover.div, "lookupHoverDetailOverridable");
            delStyleClass(this.hover.div.firstChild, overrideClass);
            addStyleClass(this.hover.div, overrideClass);
        }
    }
};
buySignalPopup.prototype.buildAccountContent = function () {
    
    var dt = new Date();
    debugout('Start buildAccountContent(): ' + dt.getSeconds() + '.' + dt.getMilliseconds());

    var content = this.PopupHeader('Buy Signals Shown (up to 10 most recent)')
        + '<th scope="col" class="">Contact</th>' 
        + '<th scope="col" class="">Title</th>'
        + '<th scope="col" width="175" class="">Name</th>'
        + '<th scope="col" width="170" class="">Date</th></tr>'
    this.PopupLoading(content, 4);
        
    var prospectID = this.itemId.substr(11);
    var soql = 'SELECT ID, EDP1__Contact__c, Name, EDP1__Date__c, EDP1__BuySignal__c, '
       + 'EDP1__BuySignal__r.Name, EDP1__Contact__r.Name, EDP1__Contact__r.Title FROM EDP1__RaisedBuySignal__c '
       + 'WHERE EDP1__Contact__r.AccountID = \'' + prospectID + '\' ORDER BY EDP1__Date__c DESC LIMIT 10';
    
    dt = new Date();
    debugout('Before Run Query: ' + dt.getSeconds() + '.' + dt.getMilliseconds());
    try {
        //document.getElementById('debuglog').innerHTML = soql;
        var result = sforce.connection.query(soql);
    } catch(error) {
       handleAjaxToolkitError(error);
    }
    dt = new Date();
    debugout('After Run Query: ' + dt.getSeconds() + '.' + dt.getMilliseconds());
    
    var records = result.getArray("records");
    for (var i=0; i <= records.length-1; i++) {
        var record = records[i];
        var createdDate = record.getDateTime('EDP1__Date__c').format('D M d, Y h:i a');
        content += '<tr class="dataRow">'
             + '<td class=" dataCell "><a target="_blank" href="/' + stripHTML(record.EDP1__Contact__c) + '">' + stripHTML(record.EDP1__Contact__r.Name) + '</a></td>'
             + '<td class=" dataCell ">' + stripHTML(record.EDP1__Contact__r.Title) + '</td>'
             + '<td class=" dataCell ">' + stripHTML(record.EDP1__BuySignal__r.Name) + '</td>'
             + '<td class=" dataCell DateElement">' + createdDate + '</td>'
             + '</tr>';
    }
    content += buySignalPopup.PopupFooter;
    
    dt = new Date();
    debugout('Function Done: ' + dt.getSeconds() + '.' + dt.getMilliseconds());
    
    return content; 
    
};
buySignalPopup.prototype.buildBuySignalContent = function () {

    // The width values below are tied to the custom image in static resources
    var content = this.PopupHeader('Buy Signals Shown (up to 10 most recent)')
        + '<th scope="col" class="">Name</th>'
        + '<th scope="col" width="175" class="">Date</th></tr>'
    this.PopupLoading(content, 2);

    var prospectID = this.itemId.substr(11);

    var soql = 'SELECT ID, Name, EDP1__BuySignal__r.EDP1__Asset__r.Name, EDP1__Date__c, '
        + 'EDP1__BuySignal__r.EDP1__ActivityType__c, EDP1__BuySignal__r.EDP1__Type__c, '
        + 'EDP1__BuySignal__r.Name, EDP1__BuySignal__c FROM EDP1__RaisedBuySignal__c '
        + 'WHERE EDP1__ProspectId__c = \'' + prospectID + '\' ORDER BY EDP1__Date__c DESC LIMIT 10';

    var result = sforce.connection.query(soql);
    var records = result.getArray("records");
    for (var i=0; i <= records.length-1; i++) {
       var record = records[i];
       var createdDate = record.getDateTime('EDP1__Date__c').format('D M d, Y h:i a');
       content += '<tr class="dataRow">'
           + '<td class=" dataCell ">' + stripHTML(record.EDP1__BuySignal__r.Name) + '</td>'
           + '<td class=" dataCell DateElement">' + createdDate + '</td>'
           + '</tr>';

       //    + '<td class=" dataCell ">' + stripHTML(record.EDP1__BuySignal__r.EDP1__Type__c) + '</td>'
       // if (record.EDP1__BuySignal__r.EDP1__Asset__r == null) content += '<td class=" dataCell  ">&nbsp;</td>';
       // else content +=  '<td class=" dataCell ">' + stripHTML(record.EDP1__BuySignal__r.EDP1__Asset__r.name) + '</td>';

    }
    content += buySignalPopup.PopupFooter;
    
    return content; 
    
};
buySignalPopup.prototype.buildRecentContactsContent = function () {

    var content = this.PopupHeader('Most Active Contacts (up to 5 most recent)')
        + '<th scope="col" class="">Contact</th>' 
        + '<th scope="col" class="">Title</th>' 
        + '<th scope="col" class="">Recent Activity</th>'
        + '<th scope="col" class="">Recent Asset</th>' 
        + '<th scope="col" width="170" class="">Recent Date</th></tr>'
    this.PopupLoading(content, 5);
        
    var accountID = this.itemId.substr(15);

    var soql = 'SELECT id, Name, Title, '
       + '(SELECT {!JSENCODE(activityTypeField)}, {!JSENCODE(assetNameField)}, {!JSENCODE(activityDateField)} ' 
       + 'FROM {!JSENCODE(contactChildRelationship)} '
       + 'WHERE {!JSENCODE(activityTypeField)} != null ORDER BY {!JSENCODE(activityDateField)} DESC LIMIT 1) ' 
       + ' FROM Contact WHERE AccountId = \'' + accountID + '\''
       + ' AND EDP1__TotalInboundActivity__c > 0 '
       + ' ORDER BY EDP1__TotalInboundActivity__c, EDP1__MostRecentBuySignalDate__c DESC LIMIT 5';
    //alert(soql);
    
    try {
       // document.getElementById('debuglog').innerHTML = soql;
        var result = sforce.connection.query(soql);
    } catch(error) {
       handleAjaxToolkitError(error);
    }
    
    var records = result.getArray("records");
    for (var i=0; i <= records.length-1; i++) {
        var record = records[i];
        var createdDate = '';
        var asset = '';
        var type = '';
        var recID = record.get('Id');

        if (record.Tasks != null) {
             var task = record.Tasks.getArray('records')[0];
             createdDate = task.getDateTime('{!JSENCODE(activityDateField)}');
             if (createdDate != null && createdDate != '') { 
                if ('{!dateType}' == 'Datetime') createdDate = createdDate.format('D M d, Y h:i a');
                else createdDate = createdDate.format('D M d, Y');
             }
             asset = task.get('{!JSENCODE(assetNameField)}');
             type = task.get('{JSENCODE(!activityTypeField)}');
         }

        content += '<tr class="dataRow">'
             + '<td class=" dataCell "><a target="_blank" href="/' + stripHTML(recID) + '">' + stripHTML(record.Name) + '</a></td>'
             + '<td class=" dataCell ">' + stripHTML(record.Title) + '</td>'
             + '<td class=" dataCell ">' + stripHTML(type) + '</td>'
             + '<td class=" dataCell ">' + stripHTML(asset) + '</td>'
             + '<td class=" dataCell DateElement">' + createdDate + '</td>'
             + '</tr>';
    }
    content += buySignalPopup.PopupFooter;
    
    return content; 
    
};
buySignalPopup.prototype.buildRecencyAccountContent = function () {

    var content = this.PopupHeader('Recent Activity (up to 10 most recent)')
        + '<th scope="col" class="">Name</th>'
        + '<th scope="col" class="">Type</th>'
        + '<th scope="col" class="">Asset</th>' 
        + '<th scope="col" width="170" class="">Date</th></tr>'
    var loadingContent = this.PopupLoading(content, 4);
        
    var accountID = this.itemId.substr(8);
    
    // Remember the current instance so we have access to it from the callback function
    currentlyRunningHover = this;

    var soql = 'SELECT {!JSENCODE(contactField)}, {!contactRelationship}.Name, {!JSENCODE(activityTypeField)}, '
        + '{!JSENCODE(assetNameField)}, {!JSENCODE(activityDateField)} ' 
        + ' FROM {!JSENCODE(config.ActivityObject__c)} '
        + ' WHERE {!JSENCODE(contactField)} IN (SELECT ID FROM Contact WHERE AccountID = \'' + accountID + '\'  AND EDP1__TotalInboundActivity__c > 0)'
        + ' AND {!JSENCODE(activityTypeField)} != \'\' '
        + ' ORDER BY {!JSENCODE(activityDateField)} DESC LIMIT 10';
     //alert(soql);
    try {
       var result = sforce.connection.query(soql,  
        { onSuccess : this.buildRecencyAccountContentCallback
           , onFailure : function(error) {
               handleAjaxToolkitError(error);
           }
        });
       // this.buildRecencyAccountContentCallback(result);
    } catch(error) {
       handleAjaxToolkitError(error);
       return '';
    }
    
    return loadingContent;
    // return content; 
    
};
buySignalPopup.prototype.buildRecencyAccountContentCallback = function (result) {

    if (currentlyRunningHover == null) return;
    var self=currentlyRunningHover;
    var content = self.PopupHeader('Recent Activity (up to 10 most recent)')
        + '<th scope="col" class="">Name</th>'
        + '<th scope="col" class="">Type</th>'
        + '<th scope="col" class="">Asset</th>' 
        + '<th scope="col" width="170" class="">Date</th></tr>'
    
    var records = result.getArray("records");
    for (var i=0; i <= records.length-1; i++) {
        var record = records[i];

        createdDate = record.getDateTime('{!JSENCODE(activityDateField)}');
        if ('{!dateType}' == 'Datetime') createdDate = createdDate.format('D M d, Y h:i a');
        else createdDate = createdDate.format('D M d, Y');
        
        name = record.{!contactRelationship}.Name;
        recID = record.get('{!JSENCODE(contactField)}');
        content += '<tr class="dataRow">'
             + '<td class=" dataCell "><a target="_blank" href="/' + recID + '">' 
                + stripHTML(name) + '</a></td>'
             + '<td class=" dataCell ">' + stripHTML(record.get('{!JSENCODE(activityTypeField)}')) + '</td>'
             + '<td class=" dataCell ">' + stripHTML(record.get('{!JSENCODE(assetNameField)}')) + '</td>'
             + '<td class=" dataCell DateElement">' + createdDate + '</td>'
             + '</tr>';
    }
    content += buySignalPopup.PopupFooter;
    self.load(content);
    // return content;
}

function handleAjaxToolkitError(error) {
      try {
         //alert(error);
         var error = eval("(" + error + ")");
      } catch(e) {
         error = new String(error);
            //alert(error);
            
            //jQuery('#debuglog').html(error); 
            if ( error.indexOf('INVALID_FIELD') > 0 ) {
            alert(
               'Invalid Field Error. This is most likely due to incorrectly configured permissions\n' +
               'Please contact your Salesforce system administrator for assistance and provide the below.\n\n' +
               error
            );
            return;
         }
         alert('An unexpected error has occured. Please contact Eloqua Support with the following information\n\n' + error);
         return;
      }

      switch ( error.faultcode ) {
        case 'sf:INVALID_SESSION_ID':
            alert('Your Salesforce session has expired. Please login again');
            break;
        case 'sf:API_CURRENTLY_DISABLED':
            alert(
                'You currently do not have permissions to use this feature\n\n' +
                'Please contact your Salesforce administrator and request\n' +
                'they enable API permissions for your profile'
            );
            break;
        case 'sf:API_DISABLED_FOR_ORG':
            alert(
                'The API is not enabled for this Salesforce account.\n\n' +
                'Please contact your Salesforce administrator and to enable API access'
            );
            break;
        default:
            alert(error);
      }

}

buySignalPopup.prototype.buildRecencyProspectContent = function () {

    var content = this.PopupHeader('Recent Activity (up to 10 most recent)')
        + '<th scope="col" class="">Type</th>'
        + '<th scope="col" class="">Asset</th>' 
        + '<th scope="col" width="170" class="">Date</th></tr>'
    this.PopupLoading(content, 3);
        
    var prospectID = this.itemId.substr(8);
    
    if (prospectID.substr(0,3) == '{!JSENCODE(contactPrefix)}') whoField = '{!JSENCODE(contactField)}';
    else whoField = '{!JSENCODE(leadField)}';
    var soql = 'SELECT {!JSENCODE(activityTypeField)}, {!JSENCODE(assetNameField)}, {!JSENCODE(activityDateField)}' 
        + ' FROM {!JSENCODE(config.ActivityObject__c)} '
        + ' WHERE ' + whoField + ' = \'' + prospectID + '\' AND {!JSENCODE(activityTypeField)} != \'\' '
        + ' ORDER BY {!JSENCODE(activityDateField)} DESC LIMIT 10';
    //alert(soql);
    
    try {
      // document.getElementById('debuglog').innerHTML = soql;
        var result = sforce.connection.query(soql);
    } catch(error) {
        handleAjaxToolkitError(error);
       return '';
    }
    
    var records = result.getArray("records");
    for (var i=0; i <= records.length-1; i++) {
        var record = records[i];

        createdDate = record.getDateTime('{!JSENCODE(activityDateField)}');
        if ('{!dateType}' == 'Datetime') createdDate = createdDate.format('D M d, Y h:i a');
        else createdDate = createdDate.format('D M d, Y');
        content += '<tr class="dataRow">'
             + '<td class=" dataCell ">' + stripHTML(record.get('{!JSENCODE(activityTypeField)}')) + '</td>'
             + '<td class=" dataCell ">' + stripHTML(record.get('{!JSENCODE(assetNameField)}')) + '</td>'
             + '<td class=" dataCell DateElement">' + createdDate + '</td>'
             + '</tr>';
    }

    content += buySignalPopup.PopupFooter;

    return content; 
    
};
buySignalPopup.prototype.PopupHeader = function (t) {
    // The width values below are tied to the custom image in static resources
    return '<div class="accountBlock " style="width:625px; ">'
        + '<div class="bPageBlock secondaryPalette" style="width:610px; ">'
        + '<div class="pbHeader"  style="margin-right: 10px; width:580px;">'
        + '<table  border="0" cellpadding="0" cellspacing="0">'
        + '<tr><td class="pbTitle"><h2 class="mainTitle">' + t + '</h2></td></tr>'
        + '</table>'
        + '</div><div class="pbBody" style="margin-right: 10px; width:580px; overflow: hidden; max-height:420">'
        + '<table class="list" border="0" cellpadding="0" cellspacing="0">'
        + '<tbody ><tr class="headerRow">';
        // style="font-size: 90%;"
};
buySignalPopup.prototype.PopupLoading = function (hdr, columns) {
    
    // The width values below are tied to the custom image in static resources
    content = hdr + '<tr><td colspan="' + columns + '">'
        + "<center><img src=\"{!URLFOR($Resource.EDP1__All, 'ajax-loader1.gif')}\" /></center>"
        + '</td></tr></tbody></table></div>'
        + '<div class="pbFooter secondaryPalette"><div class="bg"></div></div>'
        + '</div></div>';

    this.load(content)
    // this.position();
    this.hover.setStyle("display", "block");
    this.hover.setStyle("visibility", "visible");
    
    return content;
};

function stripHTML(s) {
    if (s) return s.replace(/(<([^>]+)>)/ig,"");
    else return '';
}

</script>


<script type="text/javascript">
// M.Smith, 05/28/2010: Moved this to the VERY bottom of the page
// to get it to work in IE7. Otherwise, it was failing with an "object error" 
    var tab1 = document.getElementById("tab1");
    tab_onClick(tab1, 1);
</script>

<script>
// http://jacwright.com/projects/javascript/date_format
// Simulates PHP's date function
Date.prototype.format=function(format){var returnStr='';var replace=Date.replaceChars;for(var i=0;i<format.length;i++){var curChar=format.charAt(i);if(replace[curChar]){returnStr+=replace[curChar].call(this);}else{returnStr+=curChar;}}return returnStr;};Date.replaceChars={shortMonths:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],longMonths:['January','February','March','April','May','June','July','August','September','October','November','December'],shortDays:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],longDays:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],d:function(){return(this.getDate()<10?'0':'')+this.getDate();},D:function(){return Date.replaceChars.shortDays[this.getDay()];},j:function(){return this.getDate();},l:function(){return Date.replaceChars.longDays[this.getDay()];},N:function(){return this.getDay()+1;},S:function(){return(this.getDate()%10==1&&this.getDate()!=11?'st':(this.getDate()%10==2&&this.getDate()!=12?'nd':(this.getDate()%10==3&&this.getDate()!=13?'rd':'th')));},w:function(){return this.getDay();},z:function(){return"Not Yet Supported";},W:function(){return"Not Yet Supported";},F:function(){return Date.replaceChars.longMonths[this.getMonth()];},m:function(){return(this.getMonth()<9?'0':'')+(this.getMonth()+1);},M:function(){return Date.replaceChars.shortMonths[this.getMonth()];},n:function(){return this.getMonth()+1;},t:function(){return"Not Yet Supported";},L:function(){return(((this.getFullYear()%4==0)&&(this.getFullYear()%100!=0))||(this.getFullYear()%400==0))?'1':'0';},o:function(){return"Not Supported";},Y:function(){return this.getFullYear();},y:function(){return(''+this.getFullYear()).substr(2);},a:function(){return this.getHours()<12?'am':'pm';},A:function(){return this.getHours()<12?'AM':'PM';},B:function(){return"Not Yet Supported";},g:function(){return this.getHours()%12||12;},G:function(){return this.getHours();},h:function(){return((this.getHours()%12||12)<10?'0':'')+(this.getHours()%12||12);},H:function(){return(this.getHours()<10?'0':'')+this.getHours();},i:function(){return(this.getMinutes()<10?'0':'')+this.getMinutes();},s:function(){return(this.getSeconds()<10?'0':'')+this.getSeconds();},e:function(){return"Not Yet Supported";},I:function(){return"Not Supported";},O:function(){return(-this.getTimezoneOffset()<0?'-':'+')+(Math.abs(this.getTimezoneOffset()/60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()/60))+'00';},P:function(){return(-this.getTimezoneOffset()<0?'-':'+')+(Math.abs(this.getTimezoneOffset()/60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()/60))+':'+(Math.abs(this.getTimezoneOffset()%60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()%60));},T:function(){var m=this.getMonth();this.setMonth(0);var result=this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,'$1');this.setMonth(m);return result;},Z:function(){return-this.getTimezoneOffset()*60;},c:function(){return this.format("Y-m-d")+"T"+this.format("H:i:sP");},r:function(){return this.toString();},U:function(){return this.getTime()/1000;}};
</script>

</apex:page>